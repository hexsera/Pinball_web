# 랭킹 테이블 수정 실행계획

## 요구사항 요약

**요구사항**: ranking 테이블(monthly_scores)에 nickname 필드를 추가하고, POST API에서 user 테이블의 nickname을 자동으로 가져와 저장하며, GET API 응답에서 user_id 대신 nickname을 반환한다.

**목적**: 프론트엔드에서 랭킹 조회 시 nickname을 직접 받아 별도의 user 조회 API 호출 없이 사용자 닉네임을 표시하기 위함이다.

## 현재상태 분석

**MonthlyScore 모델** (models.py:49-56):
- 현재 user_id, score, created_at 필드만 존재
- nickname 필드 없음
- User 테이블과의 관계(relationship) 설정 없음

**POST /api/v1/monthly-scores** (main.py:650-674):
- MonthlyScoreCreateRequest로 user_id와 score만 받음
- nickname을 저장하는 로직 없음

**GET /api/v1/monthly-scores** (main.py:677-689):
- MonthlyScoreResponse로 user_id, score, created_at 반환
- nickname 필드 없음

## 구현 방법

1. **Alembic 마이그레이션**으로 monthly_scores 테이블에 nickname 컬럼 추가
2. **MonthlyScore 모델**에 nickname 필드 추가 (SQLAlchemy Column)
3. **POST API**에서 user_id로 User 테이블 조회 후 nickname을 가져와 저장
4. **MonthlyScoreResponse 스키마**에서 user_id 제거, nickname 추가
5. **GET API**는 자동으로 nickname 포함하여 반환 (코드 수정 불필요)

## 구현 단계

### 1. MonthlyScore 모델에 nickname 필드 추가

```python
class MonthlyScore(Base):
    __tablename__ = "monthly_scores"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, nullable=False, index=True)
    nickname = Column(String(100), nullable=False)  # 추가
    score = Column(Integer, nullable=False, index=True)
    created_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

- **무엇을 하는가**: User 테이블의 nickname을 저장하기 위한 필드 추가
- String(100): users 테이블의 nickname 컬럼과 동일한 타입
- nullable=False: nickname은 필수 값 (User 테이블에서 항상 가져올 수 있음)
- 인덱스는 불필요 (조회 조건으로 사용하지 않음)

### 2. Alembic 마이그레이션 파일 생성 및 적용

```bash
# 마이그레이션 파일 자동 생성
docker exec fastapi-server alembic revision --autogenerate -m "Add nickname to monthly_scores"

# 마이그레이션 적용
docker exec fastapi-server alembic upgrade head
```

- **무엇을 하는가**: models.py 변경사항을 DB 스키마에 반영
- autogenerate로 models.py의 변경사항 자동 감지
- nullable=False 필드 추가 시 기존 레코드가 있으면 오류 발생 가능 (현재는 데이터가 없으므로 안전)

### 3. POST API에서 nickname 조회 및 저장 로직 추가

```python
@app.post("/api/v1/monthly-scores", response_model=MonthlyScoreResponse)
def create_or_update_monthly_score(
    score_data: MonthlyScoreCreateRequest,
    db: Session = Depends(get_db)
):
    """월간 점수 생성 또는 수정 (최고 점수만 저장)"""
    # User 테이블에서 nickname 조회
    user = db.query(User).filter(User.id == score_data.user_id).first()
    if user is None:
        raise HTTPException(
            status_code=404,
            detail=f"User with id {score_data.user_id} not found"
        )

    existing_score = db.query(MonthlyScore).filter(
        MonthlyScore.user_id == score_data.user_id
    ).first()

    if existing_score:
        if score_data.score > existing_score.score:
            existing_score.score = score_data.score
            existing_score.nickname = user.nickname  # nickname 갱신
            db.commit()
            db.refresh(existing_score)
        return existing_score
    else:
        new_score = MonthlyScore(
            user_id=score_data.user_id,
            nickname=user.nickname,  # nickname 저장
            score=score_data.score
        )
        db.add(new_score)
        db.commit()
        db.refresh(new_score)
        return new_score
```

- **무엇을 하는가**: user_id로 User 테이블을 조회하여 nickname을 가져와 MonthlyScore에 저장
- user가 없으면 404 에러 반환 (존재하지 않는 사용자의 점수 저장 방지)
- 기존 점수 갱신 시에도 nickname 갱신 (사용자가 닉네임을 변경한 경우 대응)
- 신규 점수 생성 시 nickname 포함하여 저장

### 4. MonthlyScoreResponse 스키마 수정

```python
class MonthlyScoreResponse(BaseModel):
    """월간 점수 응답"""
    nickname: str  # 추가
    score: int
    created_at: datetime

    class Config:
        from_attributes = True
```

- **무엇을 하는가**: GET API 응답에서 user_id 제거, nickname 추가
- user_id 제거: 프론트엔드에서 user_id 대신 nickname 사용
- nickname 추가: User 테이블 조회 없이 바로 닉네임 표시 가능
- from_attributes = True: SQLAlchemy 모델을 Pydantic 모델로 자동 변환

### 5. 테스트용 Mock 데이터 생성 스크립트 작성

```python
# backend/seed_monthly_scores.py
import os
import random
from datetime import datetime
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv
from models import User, MonthlyScore

load_dotenv()

# DB 연결
DATABASE_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def seed_monthly_scores():
    """users 테이블의 ID를 기반으로 MonthlyScore Mock 데이터 생성"""
    db = SessionLocal()
    try:
        # users 테이블에서 모든 사용자 조회
        users = db.query(User).all()

        if not users:
            print("No users found in the database")
            return

        print(f"Found {len(users)} users")

        # 각 사용자마다 랜덤 점수 생성
        for user in users:
            # 기존 점수가 있는지 확인
            existing = db.query(MonthlyScore).filter(
                MonthlyScore.user_id == user.id
            ).first()

            if existing:
                print(f"User {user.id} ({user.nickname}) already has a score: {existing.score}")
                continue

            # 랜덤 점수 생성 (1000 ~ 50000)
            random_score = random.randint(1000, 50000)

            # MonthlyScore 생성
            monthly_score = MonthlyScore(
                user_id=user.id,
                nickname=user.nickname,
                score=random_score
            )
            db.add(monthly_score)
            print(f"Created score for user {user.id} ({user.nickname}): {random_score}")

        db.commit()
        print("Monthly scores seeding completed")

    except Exception as e:
        print(f"Error during seeding: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    seed_monthly_scores()
```

- **무엇을 하는가**: users 테이블의 모든 사용자 ID를 조회하여 MonthlyScore 테스트 데이터 생성
- User 테이블에서 모든 사용자를 조회하여 id와 nickname 가져오기
- 각 사용자마다 1000~50000 사이의 랜덤 점수 생성
- 이미 점수가 있는 사용자는 스킵 (중복 방지)
- nickname도 함께 저장하여 실제 API 동작과 동일하게 테스트

### 6. Mock 데이터 생성 스크립트 실행

```bash
# FastAPI 컨테이너 내부에서 스크립트 실행
docker exec fastapi-server python seed_monthly_scores.py
```

- **무엇을 하는가**: 작성한 Mock 데이터 생성 스크립트를 실행하여 테스트 데이터 삽입
- FastAPI 컨테이너 내부에서 실행 (DB 연결 설정 및 모델 임포트가 가능한 환경)
- users 테이블의 모든 사용자에 대해 랜덤 점수 생성
- GET API 테스트를 위한 충분한 데이터 확보

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| backend/models.py | 수정 | MonthlyScore 모델에 nickname 필드 추가 |
| backend/main.py | 수정 | POST API에 User 조회 및 nickname 저장 로직 추가 |
| backend/main.py | 수정 | MonthlyScoreResponse에서 user_id 제거, nickname 추가 |
| backend/alembic/versions/*.py | 생성 | Alembic 마이그레이션 파일 (autogenerate) |
| backend/seed_monthly_scores.py | 생성 | MonthlyScore 테스트 데이터 생성 스크립트 |

## 완료 체크리스트

- [o] monthly_scores 테이블에 nickname 컬럼이 추가되었는지 확인 (`DESCRIBE monthly_scores;`)
- [o] Mock 데이터 스크립트 실행 시 users 테이블의 모든 ID로 데이터가 생성되는지 확인
- [o] Mock 데이터가 nickname과 함께 저장되는지 확인 (`SELECT * FROM monthly_scores;`)
- [o] POST /api/v1/monthly-scores 호출 시 User 테이블에서 nickname을 가져와 저장하는지 확인
- [o] 존재하지 않는 user_id로 POST 요청 시 404 에러 반환하는지 확인
- [o] GET /api/v1/monthly-scores 응답에 nickname 필드가 포함되는지 확인
- [o] GET /api/v1/monthly-scores 응답에 user_id 필드가 제거되었는지 확인
- [o] 사용자가 닉네임을 변경한 후 점수 갱신 시 nickname이 업데이트되는지 확인
- [o] FastAPI 서버가 에러 없이 실행되는지 확인
