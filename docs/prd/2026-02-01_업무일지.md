# 업무일지

## 기본 정보
- 날짜: 2026-02-01 (일) 12:03~13:00
- 작성자: hexsera

## 진행 목표
핀볼 게임 종료 시 게임 오버 오버레이 UI를 표시하고, 획득한 점수를 월간 랭킹 API에 POST하여 최고점수를 갱신하고 오버레이에 표시하는 기능 구현 (PHASE 1 + PHASE 2)

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| overlayState 상태 추가 | react/main/src/Pinball.jsx | null / 'gameOver' 값으로 오버레이 종류 관리 |
| 게임 오버 시 오버레이 트리거 | react/main/src/Pinball.jsx | 목숨 0일 때 setOverlayState('gameOver') 호출 |
| 범용 인게임 오버레이 UI 추가 | react/main/src/Pinball.jsx | 게임 캔버스 영역(1100px) 위에 position: absolute로 배치 |
| axios, AuthContext import 추가 | react/main/src/Pinball.jsx | API 호출 및 사용자 정보 접근용 |
| bestScore 상태 및 submitScore 함수 구현 | react/main/src/Pinball.jsx | POST 응답의 score를 최고점수로 세팅 |
| 게임 오버 시 submitScore 호출 | react/main/src/Pinball.jsx | setOverlayState 다음 줄에 추가 |
| 오버레이 최고점수 표시에 bestScore 연결 | react/main/src/Pinball.jsx | null이면 '---', 아니면 실제 값 표시 |

## 주요 변경 사항

### 1. react/main/src/Pinball.jsx 수정

#### import 추가

**변경 전:**
```jsx
import { useEffect, useRef, useState, useCallback } from 'react';
import Matter from 'matter-js';
import { Button, Box, Typography } from '@mui/material';
```

**변경 후:**
```jsx
import { useEffect, useRef, useState, useCallback } from 'react';
import Matter from 'matter-js';
import axios from 'axios';
import { Button, Box, Typography } from '@mui/material';
import { useAuth } from './AuthContext';
```

---

#### 상태 변수 및 useAuth 추가

**변경 전:**
```jsx
function Pinball() {
  const sceneRef = useRef(null);
  // ...
  const [lives, setLives] = useState(3);
  const [windowSize, setWindowSize] = useState({
```

**변경 후:**
```jsx
function Pinball() {
  const { user } = useAuth();
  const sceneRef = useRef(null);
  // ...
  const [lives, setLives] = useState(3);
  const [overlayState, setOverlayState] = useState(null);
  const [bestScore, setBestScore] = useState(null);
  const [windowSize, setWindowSize] = useState({
```

**특징:**
- `useAuth()`에서 현재 로그인한 사용자의 `user` 객체를 가져옴 (`user.id`로 사용자 ID 접근)
- `overlayState`: 현재 표시할 오버레이 종류를 관리하는 단일 상태 (`null` → 숨김, `'gameOver'` → 게임 오버 콘텐츠)
- `bestScore`: POST 응답에서 받은 최고점수를 저장하는 상태 (초기값 `null`)

---

#### submitScore 함수 추가

**변경 전:**
```jsx
  // 최적 스케일 계산 함수
  const calculateScale = useCallback(() => {
```

**변경 후:**
```jsx
  // 점수 전송 및 최고점수 갱신 함수
  const submitScore = async () => {
    if (!user || !user.id) {
      console.log('User not logged in, score not submitted');
      return;
    }

    try {
      const response = await axios.post('/api/v1/monthly-scores', {
        user_id: user.id,
        score: score
      });
      console.log('Score submitted successfully:', response.data);
      setBestScore(response.data.score);
    } catch (error) {
      console.error('Failed to submit score:', error);
    }
  };

  // 최적 스케일 계산 함수
  const calculateScale = useCallback(() => {
```

**특징:**
- 로그인하지 않은 사용자는 점수 전송을 건너뜀 (console.log로 안내)
- POST `/api/v1/monthly-scores`는 Upsert 로직: 기존 점수보다 높을 때만 갱신하고, 갱신된 최고점수를 응답에 반환
- 응답의 `score` 값을 `bestScore`로 세팅하여 별도 GET 호출 없이 최고점수가 바로 결정됨

---

#### 게임 오버 시 오버레이 트리거 및 점수 전송

**변경 전:**
```jsx
          } else {
            // 생명이 없으면 공 제거 (게임 오버)
            World.remove(engine.world, ball);
            console.log('Game Over!');
          }
```

**변경 후:**
```jsx
          } else {
            // 생명이 없으면 공 제거 (게임 오버)
            World.remove(engine.world, ball);
            console.log('Game Over!');
            setOverlayState('gameOver');
            submitScore();
          }
```

**특징:**
- `setOverlayState('gameOver')`: 오버레이 UI를 즉시 표시
- `submitScore()`: 점수를 API에 전송하고, 응답 후 최고점수 갱신 (비동기)

---

#### 범용 인게임 오버레이 UI 추가

**변경 전:**
```jsx
          {/* 게임 영역 (하단 900px) */}
          <Box sx={{
            width: '700px',
            height: '1100px',
            backgroundImage: 'url(/images/pinball_back.png)',
            backgroundSize: '100% 100%',
            backgroundPosition: 'center',
            backgroundRepeat: 'no-repeat'
          }}>
            <div ref={sceneRef} />
          </Box>
```

**변경 후:**
```jsx
          {/* 게임 영역 (하단 1100px) */}
          <Box sx={{
            position: 'relative',
            width: '700px',
            height: '1100px',
            backgroundImage: 'url(/images/pinball_back.png)',
            backgroundSize: '100% 100%',
            backgroundPosition: 'center',
            backgroundRepeat: 'no-repeat'
          }}>
            <div ref={sceneRef} />

            {/* 인게임 오버레이 (게임 캔버스 영역 위) */}
            {overlayState && (
              <Box
                sx={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: '100%',
                  height: '100%',
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  display: 'flex',
                  flexDirection: 'column',
                  justifyContent: 'center',
                  alignItems: 'center',
                  zIndex: 10,
                }}
              >
                {overlayState === 'gameOver' && (
                  <>
                    <Typography variant="h2" sx={{ color: '#ff0000', fontWeight: 'bold', mb: 4 }}>
                      GAME OVER
                    </Typography>
                    <Typography variant="h4" sx={{ color: '#ffffff', mb: 2 }}>
                      획득 점수: {score}
                    </Typography>
                    <Typography variant="h5" sx={{ color: '#ffff00', mb: 4 }}>
                      최고 점수: {bestScore !== null ? bestScore : '---'}
                    </Typography>
                    <Button
                      variant="contained"
                      disabled
                      sx={{ fontSize: '1.2rem', padding: '10px 30px' }}
                    >
                      다시 시작
                    </Button>
                  </>
                )}
              </Box>
            )}
          </Box>
```

**특징:**
- 게임 영역 Box에 `position: 'relative'` 추가하여 오버레이의 절대 배치 기준점 설정
- 오버레이는 게임 캔버스 영역(1100px)만 덮음 (상단 UI Bar 아래)
- 외부 Box는 범용 구조로, `overlayState` 값에 따라 내부 콘텐츠를 분기 렌더링 (향후 'pause' 등 추가 가능)
- 최고 점수: `bestScore`가 `null`이면 `---` 표시, API 응답 후 실제 값으로 갱신
- 다시시작 버튼: `disabled` 상태 (기능 미구현)

---

### 데이터 흐름

```
게임 오버 발생 (목숨 0)
        │
        ▼
  World.remove(ball)          ← 공 제거
  setOverlayState('gameOver') ← 오버레이 즉시 표시
  submitScore()               ← 비동기 점수 전송
        │
        ▼
  POST /api/v1/monthly-scores
  { user_id, score }
        │
        ▼
  백엔드 Upsert 로직
  ├── 기존 점수 없음 → INSERT
  └── 기존 점수 있음 → 새 점수가 더 높으면 UPDATE
        │
        ▼
  응답: { user_id, score (최고점수), created_at }
        │
        ▼
  setBestScore(response.data.score)
        │
        ▼
  오버레이 최고 점수 표시 갱신
```

## 결과
- 상태: 완료
- PHASE 1 (범용 오버레이 구조 + 게임 오버 콘텐츠): 완료
- PHASE 2 (월간 점수 API 연동 + 최고점수 표시): 완료

## 배운내용

## 다음 작업
- 다시시작 버튼 기능 구현 (overlayState를 null로 리셋하고 공/목숨 초기화)
- 최고점수 조회: 게임 시작 시에도 기존 최고점수를 GET으로 가져오기
- 점수 시스템 구현 (현재 score는 하드코딩 값)
- 사용자 정보 수정시 localstroge 업데이트.