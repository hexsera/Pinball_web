# 핀볼 게임 종료 UI 실행계획

## 요구사항 요약

**요구사항**: 핀볼 게임에서 목숨이 0이 되면 게임 오버 오버레이 UI를 표시하고, 획득한 점수를 월간 랭킹 API에 POST한다.

**목적**: 사용자에게 게임 종료 상태를 명확하게 알리고, 획득한 점수를 서버에 저장하여 랭킹 시스템에 반영한다.

## 현재상태 분석

- `lives` 상태와 `livesRef`로 목숨을 관리하고 있음 (초기값 3)
- 목숨이 0이 되면 `World.remove(engine.world, ball)`로 공만 제거하고 UI 피드백 없음
- `score` 상태는 30으로 하드코딩되어 있음 (향후 점수 시스템 구현 필요)
- 월간 점수 API(`POST /api/v1/monthly-scores`)는 백엔드에 이미 구현됨
- MUI Box, Button, Typography는 이미 import되어 사용 중

## 구현 방법

- 오버레이를 `isGameOver` 전용이 아닌 범용 인게임 오버레이로 설계한다
- `overlayState` 상태로 현재 오버레이 종류를 관리하고 (`null` / `'gameOver'`), 값에 따라 콘텐츠를 분기 렌더링한다
- 오버레이 영역은 게임 캔버스 영역(1100px)만 덮음 (상단 UI Bar 아래)
- `position: relative`인 게임 캔버스 감싸는 Box 안에 `position: absolute`로 배치
- PHASE 1: 범용 오버레이 구조 및 게임 오버 콘텐츠 구현
- PHASE 2: axios로 월간 점수 API 연동, AuthContext에서 user.id 가져와서 POST 요청
- 최고 점수 API와 다시시작 버튼 기능은 현재 구현하지 않음 (임시값/비활성 상태로 표시)

## 구현 단계

---

## PHASE 1: 범용 인게임 오버레이 및 게임 오버 콘텐츠

### 1-1. overlayState 상태 추가
```javascript
const [overlayState, setOverlayState] = useState(null);
// null: 오버레이 숨김
// 'gameOver': 게임 오버 콘텐츠 표시
// 향후 추가예시: 'pause', 'levelComplete' 등
```
- **무엇을 하는가**: 현재 표시할 오버레이 종류를 관리하는 단일 상태변수다
- `null`이면 오버레이를 표시하지 않고, 문자열 값에 따라 해당 콘텐츠를 렌더링한다
- 향후 인게임 UI(예: 일시정지, 레벨 완료 등)를 추가할 때 여기에 새 값만 추가하면 된다
- 기존 상태 변수들(`score`, `lives` 등) 근처에 추가

### 1-2. 게임 오버 시 오버레이 표시
```javascript
// 충돌 이벤트 핸들러 내부 (기존 else 블록)
} else {
  World.remove(engine.world, ball);
  console.log('Game Over!');
  setOverlayState('gameOver');  // 이 줄 추가
}
```
- **무엇을 하는가**: 목숨이 0일 때 `overlayState`를 `'gameOver'`로 설정하여 게임 오버 콘텐츠가 표시되도록 한다
- 기존 `World.remove()` 다음 줄에 추가

### 1-3. 범용 인게임 오버레이 UI 추가
```jsx
{/* 인게임 오버레이 (게임 캔버스 영역 위) */}
{overlayState && (
  <Box
    sx={{
      position: 'absolute',
      top: 0,
      left: 0,
      width: '100%',
      height: '100%',
      backgroundColor: 'rgba(0, 0, 0, 0.8)',
      display: 'flex',
      flexDirection: 'column',
      justifyContent: 'center',
      alignItems: 'center',
      zIndex: 10,
    }}
  >
    {overlayState === 'gameOver' && (
      <>
        <Typography variant="h2" sx={{ color: '#ff0000', fontWeight: 'bold', mb: 4 }}>
          GAME OVER
        </Typography>
        <Typography variant="h4" sx={{ color: '#ffffff', mb: 2 }}>
          획득 점수: {score}
        </Typography>
        <Typography variant="h5" sx={{ color: '#ffff00', mb: 4 }}>
          최고 점수: ---
        </Typography>
        <Button
          variant="contained"
          disabled
          sx={{ fontSize: '1.2rem', padding: '10px 30px' }}
        >
          다시 시작
        </Button>
      </>
    )}
  </Box>
)}
```
- **무엇을 하는가**: 게임 캔버스 영역(1100px) 위에 반투명 오버레이를 덮고, `overlayState` 값에 따라 콘텐츠를 분기 렌더링한다
- 오버레이 배경 Box는 범용 구조이고, 안쪽 콘텐츠는 `overlayState === 'gameOver'`로 조건부 렌더링
- 향후 `overlayState === 'pause'` 등을 추가하면 같은 오버레이 배경 안에 새 콘텐츠를 추가하면 된다
- 배치 위치: 기존 `<div ref={sceneRef} />` 아래에 추가 (게임 캔버스 감싸는 Box 내부)
- 최고 점수는 `---`로 표시 (API 미구현), 다시시작 버튼은 `disabled` (기능 미구현)

---

## PHASE 2: 월간 점수 API 연동

### 2-1. axios 및 AuthContext import 추가
```javascript
import axios from 'axios';
import { useAuth } from './AuthContext';
```
- **무엇을 하는가**: API 호출을 위한 axios와 사용자 정보 접근을 위한 AuthContext를 가져온다
- 파일 상단의 import 영역에 추가
- axios가 이미 import되어 있다면 생략

### 2-2. useAuth 훅 호출
```javascript
const { user } = useAuth();
```
- **무엇을 하는가**: AuthContext에서 현재 로그인한 사용자 정보를 가져온다
- 컴포넌트 함수 내부, 다른 useState/useRef 선언부 근처에 추가
- `user.id`로 사용자 ID에 접근 가능

### 2-3. 점수 전송 함수 생성
```javascript
const submitScore = async () => {
  if (!user || !user.id) {
    console.log('User not logged in, score not submitted');
    return;
  }

  try {
    const response = await axios.post('/api/v1/monthly-scores', {
      user_id: user.id,
      score: score
    });
    console.log('Score submitted successfully:', response.data);
  } catch (error) {
    console.error('Failed to submit score:', error);
  }
};
```
- **무엇을 하는가**: 게임 오버 시 획득한 점수를 월간 랭킹 API에 전송한다
- 로그인하지 않은 사용자는 점수 전송을 건너뜀
- API는 기존 점수보다 높을 때만 갱신 (Upsert 로직이 백엔드에 구현됨)

### 2-4. 게임 오버 시 점수 전송 호출
```javascript
} else {
  World.remove(engine.world, ball);
  console.log('Game Over!');
  setOverlayState('gameOver');
  submitScore();  // 이 줄 추가
}
```
- **무엇을 하는가**: 게임 오버 시점에 점수 전송 함수를 호출한다
- `setOverlayState('gameOver')` 다음 줄에 추가

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| react/main/src/Pinball.jsx | 수정 | PHASE 1: overlayState 상태 추가, 범용 인게임 오버레이 UI 추가 |
| react/main/src/Pinball.jsx | 수정 | PHASE 2: axios/AuthContext import, submitScore 함수, API 호출 |

## 완료 체크리스트

### PHASE 1
- [o] 목숨이 0이 되면 오버레이가 게임 캔버스 영역(1100px) 위에 표시됨 (상단 UI Bar 위에 덮이지 않음)
- [o] 오버레이에 "GAME OVER" 텍스트가 빨간색으로 표시됨
- [o] 오버레이에 획득 점수가 표시됨
- [o] 오버레이에 최고 점수가 "---"로 표시됨
- [x] 오버레이에 다시시작 버튼이 비활성화 상태로 표시됨
- [o] 오버레이가 반투명 검은색 배경으로 덮임
- [o] `overlayState`가 `null`이면 오버레이가 표시되지 않음

### PHASE 2
- [ ] 게임 오버 시 브라우저 개발자 도구 Console에 "Score submitted successfully" 메시지 확인
- [ ] 로그인하지 않은 상태에서는 "User not logged in" 메시지 확인
- [ ] DB에서 monthly_scores 테이블에 점수가 저장되었는지 확인 (`docker exec mysql-server mysql -u hexsera -phexpoint hexdb -e "SELECT * FROM monthly_scores;"`)
