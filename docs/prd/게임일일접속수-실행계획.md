# 게임 일일 접속수 PUT 엔드포인트 실행계획

## 요구사항 요약

**요구사항**: FastAPI에 게임 일일 접속자 수 집계용 PUT 엔드포인트 생성

**목적**: IP 주소를 기반으로 게임 접속 여부를 기록하여 일일 접속자 통계를 수집한다.

## 현재상태 분석

- `backend/models.py`에 `Visit` 테이블이 이미 정의되어 있음 (id, user_id, visited_at 필드)
- PRD에서 요구하는 `game_visits` 테이블과 `is_visits` 필드는 현재 존재하지 않음
- PRD에서는 테이블을 나중에 만들 예정이라고 명시하고 있으나, 임시로 DB 연결하여 엔드포인트만 구현
- 현재 `Visit` 테이블에는 ip_address 필드가 없고 user_id와 visited_at만 존재

## 구현 방법

SQLAlchemy ORM을 사용하여 PUT 엔드포인트를 구현한다. 현재 존재하는 `Visit` 테이블 구조를 활용할 수 없으므로 (ip_address, is_visits 필드 없음), PRD 요구사항대로 `game_visits` 테이블 모델을 새로 생성한다. PUT 메서드는 기존 레코드를 수정하는 용도이므로, ip_address를 기준으로 레코드를 조회하여 `is_visits` 필드를 업데이트한다.

## 구현 단계

### 1. GameVisit 모델 생성

```python
class GameVisit(Base):
    __tablename__ = "game_visits"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, nullable=True, index=True)  # 비회원도 접속 가능하므로 nullable
    ip_address = Column(String(45), nullable=False, index=True)  # IPv6 지원 (최대 45자)
    is_visits = Column(Boolean, nullable=False, default=False)
    created_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
    updated_at = Column(DateTime, nullable=False, server_default=func.now(), onupdate=func.now())
```

- **무엇을 하는가**: 게임 접속 IP 주소, 사용자 ID, 방문 여부를 저장하는 테이블 모델 정의
- user_id는 로그인 사용자를 추적하기 위한 필드 (비회원은 NULL 허용)
- ip_address는 IPv4(15자), IPv6(45자) 모두 지원
- is_visits는 방문 여부를 나타내는 boolean 필드 (기본값: False)
- created_at과 updated_at으로 생성/수정 시각 추적
- user_id와 ip_address 모두 인덱스를 추가하여 조회 성능 최적화

### 2. Pydantic 스키마 생성

```python
class GameVisitUpdateRequest(BaseModel):
    """게임 접속 기록 수정 요청"""
    user_id: Optional[int] = None  # 비회원은 None
    ip_address: str

class GameVisitUpdateResponse(BaseModel):
    """게임 접속 기록 수정 응답"""
    message: str
    user_id: Optional[int]
    ip_address: str
    is_visits: bool
    updated_at: datetime
```

- **무엇을 하는가**: 요청과 응답 데이터 구조를 정의하여 API 입출력 검증
- GameVisitUpdateRequest는 user_id(선택)와 ip_address를 받음
- user_id는 Optional로 정의하여 비회원 접속도 처리 가능
- GameVisitUpdateResponse는 업데이트 결과를 반환하는 구조 정의
- user_id, is_visits, updated_at을 포함하여 업데이트 결과를 명확히 전달

### 3. PUT 엔드포인트 구현

```python
@app.put("/api/v1/game_visits", response_model=GameVisitUpdateResponse)
def update_game_visit(
    visit_data: GameVisitUpdateRequest,
    db: Session = Depends(get_db)
):
    """IP 주소 기반 게임 접속 기록 업데이트 (is_visits = True)"""
    # IP 주소로 레코드 조회
    game_visit = db.query(GameVisit).filter(
        GameVisit.ip_address == visit_data.ip_address
    ).first()

    if game_visit is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Game visit record for IP {visit_data.ip_address} not found"
        )

    # user_id와 is_visits 필드 업데이트
    if visit_data.user_id is not None:
        game_visit.user_id = visit_data.user_id
    game_visit.is_visits = True
    db.commit()
    db.refresh(game_visit)

    return GameVisitUpdateResponse(
        message="Game visit updated successfully",
        user_id=game_visit.user_id,
        ip_address=game_visit.ip_address,
        is_visits=game_visit.is_visits,
        updated_at=game_visit.updated_at
    )
```

- **무엇을 하는가**: IP 주소와 user_id를 받아 해당 레코드의 is_visits를 True로 변경
- `db.query(GameVisit).filter(...)`로 IP 주소 기준 레코드 조회
- 레코드가 없으면 404 에러 반환
- user_id가 제공되면 함께 업데이트 (로그인 사용자 추적)
- is_visits를 True로 설정하여 방문 기록 표시
- db.commit()으로 변경사항 저장, db.refresh()로 최신 데이터 로드
- updated_at은 onupdate=func.now()에 의해 자동 갱신됨

### 4. main.py에 모델 import 추가

```python
from models import User, Score, Friendship, MonthlyScore, GameVisit
```

- **무엇을 하는가**: 새로 생성한 GameVisit 모델을 main.py에서 사용 가능하도록 import
- Base.metadata.create_all()이 실행될 때 game_visits 테이블도 자동 생성됨

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| backend/models.py | 수정 | GameVisit 모델 클래스 추가 |
| backend/main.py | 수정 | GameVisitUpdateRequest, GameVisitUpdateResponse 스키마 추가 및 PUT /api/v1/game_visits 엔드포인트 구현 |
| backend/main.py | 수정 | models.py에서 GameVisit import 추가 |

## 완료 체크리스트

- [ ] backend/models.py에 GameVisit 모델이 추가되었는지 확인
- [ ] backend/main.py에 PUT /api/v1/game_visits 엔드포인트가 생성되었는지 확인
- [ ] Docker 컨테이너 재시작 시 game_visits 테이블이 자동 생성되는지 확인
- [ ] Swagger UI (http://localhost:8000/docs)에서 PUT /api/v1/game_visits 엔드포인트가 표시되는지 확인
- [ ] 존재하지 않는 IP 주소로 PUT 요청 시 404 에러가 반환되는지 확인
- [ ] 존재하는 IP 주소로 PUT 요청 시 is_visits가 True로 업데이트되는지 확인
