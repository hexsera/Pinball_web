# 업무일지

## 기본 정보
- 날짜: 2026-01-22 (수)
- 작성자: hexsera

## 진행 목표
FastAPI 데이터베이스 마이그레이션 구현 및 Base.metadata.create_all 추가

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|

[PRD 작성]
요구사항 분석 → Alembic 마이그레이션 PRD 작성
| 데이터베이스 마이그레이션 PRD 작성 | PRD/fastapi-데이터베이스-마이그레이션.md | Alembic 사용, User 테이블 생성
20분

[실행]
| requirements.txt에 alembic 추가 | fastapi/requirements.txt | alembic==1.13.1
| User 모델 생성 | fastapi/models.py | SQLAlchemy ORM 모델 정의
| Alembic 초기화 | fastapi/alembic/, fastapi/alembic.ini | 디렉토리 및 설정 파일 생성
| alembic.ini 수정 | fastapi/alembic.ini | sqlalchemy.url 주석 처리
| alembic/env.py 수정 | fastapi/alembic/env.py | Base.metadata 연결, 환경변수 로드
| 마이그레이션 파일 생성 | fastapi/alembic/versions/7b4c306d44ce_create_users_table.py | autogenerate로 자동 생성
| 마이그레이션 실행 | MySQL hexdb | users 테이블 생성
10분

[테스트]
alembic current 명령으로 버전 확인
20 분

[학습]
사용자 요청에 따른 학습 문서 작성
| Alembic 개념 설명 | PRD/Alembic이란-무엇인가.md | 초보자용 설명
| Alembic 초기 구축 과정 | PRD/Alembic-초기-구축-과정.md | 단계별 구축 가이드
| context.config와 target_metadata | PRD/Alembic-context-config와-target-metadata-설명.md | 핵심 개념 설명
| 최초 실행 동작 과정 | PRD/SQLAlchemy-Alembic-MySQL-최초실행-동작과정.md | 전체 흐름 설명
| Base.metadata.create_all 설명 | PRD/부트스트랩-자동-마이그레이션과-create-all-설명.md | create_all vs Alembic
| main.py에 create_all 추가 | fastapi/main.py | 애플리케이션 시작 시 테이블 자동 생성
| 테스트 방법 문서 작성 | PRD/Base-metadata-create-all-테스트-방법.md | 단계별 테스트 가이드
users 테이블 삭제 → FastAPI 재시작 → 테이블 자동 생성 확인

3시간 15분

[업무일지 작성]
15분

**총 4시간 20분**
**학습 제외 3시간 50분**

## 주요 변경 사항

### 1. fastapi/models.py 생성

**추가:**
```python
from sqlalchemy import Column, Integer, String, Date
from database import Base


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, index=True, nullable=False)
    nickname = Column(String(100), nullable=False)
    password = Column(String(255), nullable=False)
    birth_date = Column(Date, nullable=False)
    role = Column(String(20), nullable=False, default='user')
```

**특징:**
- SQLAlchemy ORM 모델 정의
- email에 UNIQUE 제약조건 및 인덱스
- id와 email에 인덱스 설정
- role 기본값 'user'

### 2. Alembic 초기화 및 설정

**생성된 파일:**
```
fastapi/
├── alembic.ini                  # Alembic 설정 파일
└── alembic/
    ├── env.py                  # 환경 설정
    ├── script.py.mako          # 마이그레이션 템플릿
    ├── README
    └── versions/
        └── 7b4c306d44ce_create_users_table.py
```

**alembic/env.py 주요 수정:**
```python
import os
from dotenv import load_dotenv

load_dotenv()

# 환경변수에서 DATABASE_URL 설정
DATABASE_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"
config.set_main_option('sqlalchemy.url', DATABASE_URL)

# Base.metadata 연결
from database import Base
from models import User
target_metadata = Base.metadata
```

**특징:**
- 환경변수를 사용하여 데이터베이스 연결 정보 관리
- User 모델을 명시적으로 import하여 autogenerate가 인식하도록 함
- target_metadata에 Base.metadata 연결

### 3. 마이그레이션 파일 (7b4c306d44ce_create_users_table.py)

**자동 생성된 upgrade 함수:**
```python
def upgrade() -> None:
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=False),
        sa.Column('nickname', sa.String(length=100), nullable=False),
        sa.Column('password', sa.String(length=255), nullable=False),
        sa.Column('birth_date', sa.Date(), nullable=False),
        sa.Column('role', sa.String(length=20), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
```

**자동 생성된 downgrade 함수:**
```python
def downgrade() -> None:
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
```

**특징:**
- models.py의 User 클래스 정의를 자동으로 SQL로 변환
- upgrade: 테이블 및 인덱스 생성
- downgrade: 롤백 시 테이블 및 인덱스 삭제

### 4. Base.metadata.create_all 추가 (fastapi/main.py:4-14)

**변경 전:**
```python
from fastapi import FastAPI
from pydantic import BaseModel
from datetime import date
from database import wait_for_db

if not wait_for_db():
    raise Exception("Database connection failed after retries")

app = FastAPI(title="Hexsera API", version="1.0.0")
```

**변경 후:**
```python
from fastapi import FastAPI
from pydantic import BaseModel
from datetime import date
from database import wait_for_db, engine, Base
from models import User

if not wait_for_db():
    raise Exception("Database connection failed after retries")

# 모든 테이블 생성 (존재하지 않는 경우에만)
print("Creating database tables...")
Base.metadata.create_all(bind=engine)
print("Database tables created successfully")

app = FastAPI(title="Hexsera API", version="1.0.0")
```

**특징:**
- FastAPI 시작 시 자동으로 테이블 생성
- 테이블이 이미 존재하면 아무 작업도 하지 않음
- Alembic과 병행 사용 가능 (Alembic 우선 권장)
- 개발 환경에서 편의성 제공

## 아키텍처 설계

### 마이그레이션 흐름

```
1. models.py에 User 클래스 정의
   ↓
2. alembic revision --autogenerate
   → 마이그레이션 파일 자동 생성
   ↓
3. alembic upgrade head
   → MySQL에 users 테이블 생성
   ↓
4. alembic_version 테이블에 버전 기록
```

### Base.metadata.create_all 흐름

```
1. FastAPI 애플리케이션 시작
   ↓
2. wait_for_db() → MySQL 연결 확인
   ↓
3. Base.metadata.create_all(bind=engine)
   → users 테이블이 없으면 생성
   → 이미 존재하면 무시
   ↓
4. FastAPI 서버 실행
```

## MySQL 테이블 생성 결과

### users 테이블 구조
```
+------------+--------------+------+-----+---------+----------------+
| Field      | Type         | Null | Key | Default | Extra          |
+------------+--------------+------+-----+---------+----------------+
| id         | int          | NO   | PRI | NULL    | auto_increment |
| email      | varchar(255) | NO   | UNI | NULL    |                |
| nickname   | varchar(100) | NO   |     | NULL    |                |
| password   | varchar(255) | NO   |     | NULL    |                |
| birth_date | date         | NO   |     | NULL    |                |
| role       | varchar(20)  | NO   |     | NULL    |                |
+------------+--------------+------+-----+---------+----------------+
```

### 인덱스 구조
```
Table  Non_unique  Key_name        Column_name
users  0           PRIMARY         id
users  0           ix_users_email  email      (UNIQUE)
users  1           ix_users_id     id
```

### alembic_version 테이블
```
+-------------+
| version_num |
+-------------+
| 7b4c306d44ce |
+-------------+
```

## 결과
- 상태: 완료

DB 초기화를 테스트 해야할때는 항상 시간이 많이 걸리게 된다...

## 다음 작업
- 초기 데이터 생성 (관리자 계정, 기본 설정값 설정)
