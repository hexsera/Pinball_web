# 업무일지

## 기본 정보
- 날짜: 2026-01-21 (화)
- 작성자: hexsera

## 진행 목표
FastAPI Bootstrapping 구현 - Docker 환경에서 MySQL 연결 및 기본 API 엔드포인트 구축

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|

[부트 스트랩 PRD 작성]
PRD 초안 작성 → .env 파일 추가 → 완전한 Bootstrapping으로 확장 → 테이블 생성 제거 → DB 오프라인 시나리오 추가
| Bootstrapping PRD 작성 | PRD/fastapi-bootstrapping.md | Docker 재시도 로직 포함
1시간 20분

[실행]
| requirements.txt 수정 | fastapi/requirements.txt | python-dotenv 추가
| docker-compose.yml 수정 | docker-compose.yml | MySQL healthcheck, FastAPI depends_on 추가
| .env 파일 생성 | fastapi/.env | MySQL 연결 정보 환경 변수
| Dockerfile 생성 | fastapi/Dockerfile | Python 3.11-slim 기반 이미지
| database.py 생성 | fastapi/database.py | SQLAlchemy 연결, wait_for_db 재시도 로직
| main.py 생성 | fastapi/main.py | FastAPI 앱, DB 연결 확인, 헬스체크 API
5분

[테스트]
1시간 20분

[학습]
부트스트랩 과정 설명 문서 작성 요청 분석
일반적 부트스트랩 10단계 vs 내 프로젝트 구현 상태 비교
| 부트스트랩 설명 문서 작성 | PRD/FastAPI-부트스트랩-과정-설명.md | 일반적 단계와 프로젝트 매칭
1시간 10분

[업무일지 작성]
30분

**총 4시간 25분**
**학습 제외 3시간 15분**

## 주요 변경 사항

### 1. requirements.txt 수정 (fastapi/requirements.txt:6)

**변경 전:**
```
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
pymysql==1.1.0
cryptography
```

**변경 후:**
```
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
pymysql==1.1.0
cryptography
python-dotenv
```

### 2. .env 파일 생성 (fastapi/.env)

```
MYSQL_HOST=mysql-server
MYSQL_PORT=3306
MYSQL_DATABASE=hexdb
MYSQL_USER=hexsera
MYSQL_PASSWORD=hexpoint
```

**특징:**
- 환경 변수로 MySQL 연결 정보 관리
- 코드에 비밀번호 하드코딩 방지

### 3. Dockerfile 생성 (fastapi/Dockerfile)

```dockerfile
FROM python:3.11-slim

WORKDIR /code

COPY requirements.txt .

RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

**특징:**
- Python 3.11 경량 이미지 사용
- requirements.txt 먼저 복사하여 캐시 최적화
- --reload 옵션으로 코드 변경 시 자동 재시작

### 4. database.py 생성 (fastapi/database.py)

```python
import os
import time
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def wait_for_db(max_retries=10, delay=2):
    """DB 연결 대기 함수 (재시도 로직)"""
    retries = 0
    print("start Database connect")
    while retries < max_retries:
        try:
            engine.connect()
            print("Database connected successfully")
            return True
        except Exception as e:
            retries += 1
            print(f"Database connection failed (attempt {retries}/{max_retries}): {e}")
            if retries < max_retries:
                time.sleep(delay)
    return False
```

**특징:**
- .env 파일 로드 및 환경 변수 사용
- SQLAlchemy 엔진 및 세션 생성
- wait_for_db(): 최대 10번, 2초 간격 재시도

### 5. main.py 생성 (fastapi/main.py)

```python
from fastapi import FastAPI
from database import wait_for_db

# 애플리케이션 시작 시 DB 연결 확인
if not wait_for_db():
    raise Exception("Database connection failed after retries")


app = FastAPI(title="Hexsera API", version="1.0.0")


@app.get("/api/")
def health_check():
    return {"status": "ok", "message": "FastAPI is running"}


@app.get("/api/test")
def api_test():
    return {"status": "ok", "message": "API test endpoint"}
```

**특징:**
- 앱 시작 시 DB 연결 확인
- 연결 실패 시 예외 발생으로 컨테이너 중단
- 2개의 헬스체크 API 엔드포인트

## 이슈 및 해결

### 문제 1: Database connected successfully 메시지가 처음 시작 시 보이지 않음

**증상**
- `docker compose up -d --build` 실행 후 로그에서 "Database connected successfully" 메시지 확인 안됨
- main.py 파일 수정 시에만 메시지 출력됨

**원인**
- Dockerfile의 `--reload` 옵션과 볼륨 마운트 (`./fastapi:/code`)
- 파일 변경 감지 시 Uvicorn이 main.py를 다시 로드
- `wait_for_db()` 함수가 다시 실행되면서 메시지 출력

**확인된 동작**
- 처음 컨테이너 시작 시에도 `wait_for_db()`는 실행됨
- 로그를 놓쳤거나 Python의 print 버퍼링 문제

**해결 방안 (미적용)**
**!!!!단 이 방법은 적용해보지않아서 검증된 방법이 아님!!!!!**
```dockerfile
ENV PYTHONUNBUFFERED=1
```
- Python stdout 버퍼링 비활성화로 즉시 출력
- 현재는 동작 확인되어 적용하지 않음



### 문제 2: DB 오프라인 시 FastAPI 자동 재시작 안됨

**증상**
- MySQL 중지 → FastAPI 재시작 → 10회 재시도 실패 → 컨테이너 종료
- MySQL 재시작 후에도 FastAPI가 자동으로 다시 시작되지 않음

**원인**
- `restart: always`는 컨테이너 종료 시 재시작하지만
- `wait_for_db()` 실패로 인한 예외는 정상 종료로 간주됨
- 컨테이너가 Exit 0 상태로 종료되어 재시작하지 않음

**현재 동작**
- main.py 파일 수정 시 Uvicorn이 재로드되면서 DB 재연결 시도
- 수동으로 `docker compose restart fastapi` 실행 필요

**미래 개선 방안**
- 헬스체크 엔드포인트에서 DB 연결 상태 확인
- Lifespan 이벤트로 주기적 DB 연결 확인

## 기타
## PRD 작성 과정

### 초기 PRD (최소 Bootstrapping)
- Dockerfile, main.py, database.py 생성
- MySQL 연결 설정

### 1차 수정: .env 파일 추가
- 환경 변수 관리로 보안 강화
- python-dotenv 패키지 추가

### 2차 수정: 완전한 Bootstrapping
- DB 연결 재시도 로직 추가
- models.py, init_db.py 추가
- 테이블 자동 생성 및 초기 데이터 삽입

### 3차 수정: 테이블 생성 제거
- 사용자 요청으로 테이블 자동 생성 제거
- 최소 Bootstrapping으로 단순화
- models.py, init_db.py 제거

### 4차 수정: DB 오프라인 시나리오 추가
- 체크리스트에 DB 중지 테스트 추가
- restart: always 정책 검증

## 학습 내용

### 일반적인 FastAPI 부트스트랩 10단계
1. 환경 설정 로드 (Configuration Loading) - ✅ 구현
2. 로깅 설정 (Logging Setup) - ❌ 미구현
3. 데이터베이스 연결 (Database Connection) - ✅ 구현
4. 데이터베이스 마이그레이션 (Database Migration) - ❌ 미구현
5. 초기 데이터 생성 (Seed Data) - ❌ 미구현
6. 미들웨어 등록 (Middleware Registration) - ❌ 미구현
7. 라우터 등록 (Router Registration) - ✅ 구현
8. 외부 서비스 연결 (External Service Connection) - ❌ 미구현
9. 백그라운드 작업 시작 (Background Task Initialization) - ❌ 미구현
10. 서버 시작 (Server Start) - ✅ 구현


## 결과
- 상태: 미완료
- .env 파일을 통한 환경 변수 관리
- Docker 환경에서 MySQL 연결 확인 및 재시도 로직 동작
- 2개의 헬스체크 API 엔드포인트 정상 동작

### 미완료 원인
- 부트스트랩에 대한 이해 부족 에 따른 목표 설정 어려움
- 부트스트랩에 필요한 기술과 배워야할 학문이 많아서 해야 할 일이 많아 4시간 안에 하기 힘듬
- fastapi 로그가 특정 타이밍에 남지 않는 문제가 있어 테스트 체크리스트 확인 불가능.

## 다음 작업
- 데이터베이스 마이그레이션 (테이블 생성)
- 초기 데이터 생성 (관리자 계정)
