# 친구 추가 요청 API 실행 계획

## 개요

이 문서는 [친구추가PRD.md](./친구추가PRD.md) PRD를 기반으로 작성된 실행 계획입니다.

**목표**: POST /api/friend-requests 엔드포인트 구현 (콘솔 출력만)

**특징**:
- DB 저장 없음
- DB 의존성 없음
- 테이블 생성 불필요
- 보안/검증 로직 없음
- 요청 데이터를 콘솔에 print만 수행

## 실행 단계

### Step 1: 현재 코드 확인

**목적**: 기존 코드 구조 파악

**작업**:
1. `fastapi/main.py` 확인
   - 기존 import 구조 파악
   - 기존 Pydantic 스키마 위치 확인 (line 34-103)
   - FastAPI app 인스턴스 확인
   - 기존 엔드포인트 위치 확인 (line 105-298)

**예상 결과**:
- main.py 구조 파악 완료 → Step 2로 진행

---

### Step 2: Pydantic 스키마 추가

**파일**: `fastapi/main.py`

**작업**:
1. FriendRequestRequest 스키마 추가
   ```python
   class FriendRequestRequest(BaseModel):
       """친구 추가 요청 스키마"""
       id: int
       requester_id: int
   ```

2. FriendRequestResponse 스키마 추가
   ```python
   class FriendRequestResponse(BaseModel):
       """친구 추가 응답 스키마"""
       message: str
       id: int
       requester_id: int
   ```

**위치**: 기존 Pydantic 스키마 클래스들 다음 (ScoreResponse 클래스 다음)

**검증**: Python 문법 오류 없이 정의되었는지 확인

---

### Step 3: POST /api/friend-requests 엔드포인트 구현

**파일**: `fastapi/main.py`

**작업**:
1. 엔드포인트 함수 추가 (기존 엔드포인트 다음, 파일 끝 부분)
   ```python
   @app.post("/api/friend-requests", response_model=FriendRequestResponse)
   def create_friend_request(request: FriendRequestRequest):
       """친구 추가 요청을 받는 엔드포인트 (콘솔 출력만)"""

       # 콘솔에 출력
       print(f"요청 받음, {request.id} -> {request.requester_id}")

       # 응답 반환
       return FriendRequestResponse(
           message="Friend request received",
           id=request.id,
           requester_id=request.requester_id
       )
   ```

**위치**: 기존 POST /api/v1/scores 엔드포인트 다음

**주의사항**:
- 매우 단순한 엔드포인트 (유효성 검증 없음)
- DB 의존성 없음 (`Depends(get_db)` 사용 안 함)
- API Key 인증 없음 (`Depends(verify_api_key)` 사용 안 함)
- 외부 모델 import 불필요

---

### Step 4: FastAPI 재시작

**작업**:
```bash
docker compose restart fastapi
```

**검증**:
```bash
# 로그 확인
docker compose logs -f fastapi

# 에러 없이 시작되었는지 확인
# "Application startup complete" 메시지 확인
```

**예상 문제**:
- 문법 오류: 코드 작성 실수
- IndentationError: 들여쓰기 오류

---

### Step 5: API 테스트 (정상 케이스)

**작업**:
```bash
# 1. 친구 추가 요청 API 호출
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": 1, "requester_id": 2}'
```

**예상 응답** (200 OK):
```json
{
  "message": "Friend request received",
  "id": 1,
  "requester_id": 2
}
```

**검증**:
- 상태 코드 200 확인
- 응답 JSON 구조 확인
- message 필드 확인
- id, requester_id 필드 일치 확인

---

### Step 6: 콘솔 출력 확인

**작업**:
```bash
# FastAPI 로그 확인
docker compose logs fastapi | tail -n 20
```

**예상 출력**:
```
요청 받음, 1 -> 2
```

**검증**:
- print 문이 콘솔에 정확히 출력되었는지 확인
- id, requester_id 값 일치 확인
- PRD에서 요구한 형식대로 출력되었는지 확인

---

### Step 7: Swagger UI 확인

**작업**:
1. 브라우저에서 접속: `http://localhost:8000/docs`
2. POST /api/friend-requests 엔드포인트 확인
3. "Try it out" 클릭하여 테스트
4. 요청/응답 스키마 확인

**검증**:
- 엔드포인트가 Swagger UI에 표시되는지 확인
- FriendRequestRequest 스키마가 올바르게 표시되는지 확인
  - id (integer, required)
  - requester_id (integer, required)
- FriendRequestResponse 스키마가 올바르게 표시되는지 확인
  - message (string)
  - id (integer)
  - requester_id (integer)

---

### Step 8: 추가 테스트 (다양한 데이터)

**작업**:
```bash
# 테스트 케이스 1: 다양한 사용자 조합
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": 3, "requester_id": 5}'

# 테스트 케이스 2: 같은 사용자 (유효성 검증 없으므로 허용됨)
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": 1, "requester_id": 1}'

# 테스트 케이스 3: 큰 숫자
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": 999, "requester_id": 1000}'

# 테스트 케이스 4: 음수 (유효성 검증 없으므로 허용됨)
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": -1, "requester_id": -2}'
```

**검증**:
- 모든 케이스가 200 OK 반환
- 콘솔에 각 데이터가 출력됨
- PRD 요구사항에 따라 검증 없이 모든 요청 수락

---

### Step 9: 에러 케이스 테스트 (Pydantic 자동 검증)

**작업**:
```bash
# 테스트 케이스 1: 필수 필드 누락
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": 1}'

# 테스트 케이스 2: 잘못된 타입
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{"id": "abc", "requester_id": 2}'

# 테스트 케이스 3: 빈 body
curl -X POST http://localhost:8000/api/friend-requests \
  -H "Content-Type: application/json" \
  -d '{}'
```

**예상 결과**:
- 422 Unprocessable Entity 반환 (Pydantic 자동 검증)
- 에러 메시지에 누락/잘못된 필드 정보 표시

**참고**:
- PRD에서 "검증 로직을 고려하지 않는다"고 했지만, Pydantic은 자동으로 타입 검증을 수행합니다.
- 이는 FastAPI의 기본 동작이므로 문제없습니다.

---

## 예상 문제 및 해결 방안

### 문제 1: FastAPI 재시작 후 에러

**확인 사항**:
1. 로그 확인: `docker compose logs fastapi`
2. 문법 오류 확인
3. 들여쓰기 오류 확인 (Python은 들여쓰기에 민감)

**해결 방법**:
- SyntaxError 발생 시: 코드 문법 재확인
- IndentationError 발생 시: 들여쓰기 수정 (4칸 공백 사용)
- NameError 발생 시: import 누락 확인 (BaseModel은 이미 import됨)

---

### 문제 2: 엔드포인트가 Swagger UI에 표시되지 않음

**확인 사항**:
1. FastAPI app 인스턴스에 엔드포인트가 등록되었는지 확인
2. `@app.post(...)` 데코레이터가 올바르게 작성되었는지 확인

**해결 방법**:
- FastAPI 재시작: `docker compose restart fastapi`
- 브라우저 캐시 지우기 (Ctrl + Shift + R)

---

### 문제 3: print 문이 콘솔에 표시되지 않음

**확인 사항**:
1. Docker 로그가 실시간으로 업데이트되는지 확인
2. `docker compose logs -f fastapi` 명령어 사용 (-f 옵션으로 실시간 로그 확인)

**해결 방법**:
- 로그 확인: `docker compose logs fastapi | tail -n 50`
- API 호출 후 즉시 로그 확인

---

## 완료 체크리스트

- [o] Step 1: 현재 코드 확인 완료
- [o] Step 2: Pydantic 스키마 추가 완료
- [o] Step 3: POST 엔드포인트 구현 완료
- [o] Step 4: FastAPI 재시작 성공
- [o] Step 5: API 테스트 (정상 케이스) 성공
- [o] Step 6: 콘솔 출력 확인 성공
- [o] Step 7: Swagger UI 확인 완료
- [o] Step 8: 추가 테스트 성공
- [o] Step 9: 에러 케이스 테스트 완료

## 최종 검증

모든 단계 완료 후:

1. **API 동작 확인**:
   - POST /api/friend-requests가 정상 동작
   - 200 OK 반환
   - 콘솔에 데이터 출력 (PRD 형식: "요청 받음, id -> requester_id")

2. **코드 품질 확인**:
   - 기존 코드 스타일과 일관성 유지
   - Pydantic 스키마 작성 스타일 일관성 유지
   - 주석 적절히 작성 (docstring)

3. **단순성 확인**:
   - 유효성 검증 없음 (Pydantic 자동 검증 제외)
   - 보안 로직 없음 (API Key 인증 없음)
   - 최소한의 코드로 구현
   - print문만으로 동작 확인 가능

4. **PRD 요구사항 준수 확인**:
   - 엔드포인트 경로: `/api/friend-requests` ✓
   - 요청 body 필드: `id`, `requester_id` ✓
   - 테이블 생성 없음 ✓
   - 보안 고려 없음 ✓
   - 검증 로직 없음 ✓
   - print 형식: `"요청 받음, id -> requester_id"` ✓

## 참고 문서

- [PRD: 친구추가PRD.md](./친구추가PRD.md)
- [FastAPI 엔드포인트 구조](./user-crud-mysql.md)
- [점수 API 실행 계획](./pinball-score-api-실행계획.md) (유사한 단순 엔드포인트)

## 구현 완료 후 다음 단계 (선택 사항)

이 API는 현재 매우 단순한 형태입니다. 실제 프로덕션 환경에서는 다음 기능들이 필요할 수 있습니다:

1. **데이터베이스 저장**:
   - friend_requests 테이블 생성
   - FriendRequest 모델 추가 (models.py)
   - SQLAlchemy로 DB에 요청 저장

2. **검증 로직**:
   - id와 requester_id가 유효한 사용자인지 확인
   - 중복 요청 방지 (이미 친구 요청이 존재하는지 확인)
   - 자기 자신에게 친구 요청 불가능

3. **보안**:
   - API Key 인증 추가 (`Depends(verify_api_key)`)
   - 또는 사용자 토큰 기반 인증 (JWT)

4. **추가 엔드포인트**:
   - GET /api/friend-requests (친구 요청 목록 조회)
   - PUT /api/friend-requests/{id}/accept (친구 요청 수락)
   - DELETE /api/friend-requests/{id} (친구 요청 거절/삭제)

하지만 현재 PRD에서는 이러한 기능들을 요구하지 않으므로, 단순한 print 출력만 구현합니다.
