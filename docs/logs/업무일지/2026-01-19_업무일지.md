# 업무일지

## 기본 정보
- 날짜: 2026-01-19 (일)
- 작성자: hexsera

## 진행 목표
MySQL users 테이블에 role 컬럼 추가 및 FastAPI 연동

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| role 컬럼 추가 PRD 작성 | PRD/mysql-users-role-컬럼추가.md | PRD 스킬 사용 |
| PRD 1단계 DBeaver 방법 추가 | PRD/mysql-users-role-컬럼추가.md | SQL 쿼리 방법과 GUI 방법 추가 |
50분

| models.py role 컬럼 추가 | fastapi/models.py | Column(String(20), nullable=False, default='user') |
| schemas.py role 필드 추가 | fastapi/schemas.py | UserCreate, UserUpdate, UserResponse에 role 추가 |
| main.py POST 엔드포인트 수정 | fastapi/main.py | User 객체 생성 시 role=user.role 추가 |
| main.py PUT 엔드포인트 수정 | fastapi/main.py | 조건부 role 업데이트 로직 추가 |
1시간

| DB 스키마 변경 학습 | PRD/DB-테이블-속성-추가제거시-기존데이터-처리방법.md | 초보자용 설명 문서 |
30분

**총 2시간 20분**
**학습 제외 1시간 50분**


## 주요 변경 사항

### 1. SQLAlchemy ORM 모델 (fastapi/models.py)
- User 클래스에 role 컬럼 추가
- 타입: String(20), NOT NULL
- 기본값: 'user'

### 2. Pydantic 스키마 (fastapi/schemas.py)
- UserCreate: role 필드 추가 (기본값: 'user')
- UserUpdate: role 필드 추가 (선택적, None 허용)
- UserResponse: role 필드 추가 (응답에 포함)

### 3. FastAPI 엔드포인트 (fastapi/main.py)
- POST /api/v1/users: User 객체 생성 시 role 필드 명시적 매핑
- PUT /api/v1/users/{user_id}: role이 None이 아닐 때만 업데이트

### 4. MySQL 테이블 스키마
- users 테이블에 role VARCHAR(20) NOT NULL DEFAULT 'user' 컬럼 추가 예정
- DBeaver를 통해 SQL 쿼리 또는 GUI로 추가

## 이슈 및 해결

### 이슈 1: POST/PUT 시 role='admin'으로 전송해도 DB에 'user'로 저장됨
- **원인**: main.py의 POST와 PUT 엔드포인트에서 role 필드를 명시적으로 매핑하지 않음
- **해결**:
  - POST: User 객체 생성 시 `role=user.role` 추가
  - PUT: `if user.role is not None: db_user.role = user.role` 조건부 업데이트 추가

### 이슈 2: role 필드 보안 우려
- **문제**: 일반 사용자가 회원가입/수정 시 자신의 role을 'admin'으로 설정 가능 (권한 상승 취약점)
- **결정**: 당장은 현재 구현 유지, 추후 admin 전용 엔드포인트 분리 예정

## 결과
- 상태: 완료
- models.py, schemas.py에 role 필드 추가 완료
- main.py POST/PUT 엔드포인트에서 role 필드 정상 처리
- MySQL 테이블 변경은 DBeaver로 수동 수행 필요

## 다음 작업
- user 테이블 role 변경 api 생성
- user 테이블 put, post 에 role 접근 제거.
