# AI 대전 핀볼 게임 및 AI 채팅 PRD

## 목표

기존 1인용 핀볼 게임은 그대로 유지하고, AI와 1:1로 대전하는 새로운 핀볼 게임 모드를 별도 페이지로 추가한다. AI 대전 모드는 중력을 0으로 설정하여 공이 화면 전체에서 자유롭게 튀도록 하고, AI 상대 플립퍼가 공의 위치를 감지하여 자동으로 작동한다. 게임 화면 옆에 채팅 UI를 배치하여 플레이어가 게임 중 LLM AI와 대화할 수 있도록 한다.

## 현재상태 분석

- **핀볼 게임**: `frontend/src/pages/Pinball/Pinball.jsx`에 Matter.js 기반 1인용 핀볼이 구현되어 있다. 중력 y=1, 플립퍼 2개(좌/우), 플런저, 범퍼, 스테이지 시스템이 존재한다. 이 코드는 수정하지 않고 유지한다.
- **물리 설정**: 공 restitution 0.8, friction 0, frictionAir 0. 플립퍼는 각도 제한과 회전 속도로 제어된다.
- **게임 필드**: 700x1100 캔버스. 하단에 플립퍼, 상단에 범퍼/목표물, 하단에 죽음구역(센서)이 있다.
- **백엔드**: FastAPI + PostgreSQL. 인증, 사용자, 월간점수, 친구 API가 있다. 채팅 관련 코드는 없다.
- **프론트엔드 스택**: React 19, Vite 7, MUI 7, Axios. 상태관리는 useState/useRef 기반이다.
- **라우팅**: `App.jsx`에서 `/pinball` 경로로 기존 1인용 핀볼 페이지가 연결되어 있다.

## 실행 방법 및 단계

### 1단계: AI 대전 핀볼 페이지 및 컴포넌트 생성
- `frontend/src/pages/AIPinball/` 디렉토리를 새로 생성한다.
- 기존 `Pinball.jsx`의 Matter.js 초기화, 벽, 플립퍼 생성 로직을 참고하되 별도 파일(`AIPinball.jsx`)로 작성한다.
- `App.jsx`에 `/ai-pinball` 경로를 추가하여 새 페이지를 라우팅한다.

### 2단계: AI 대전 핀볼 물리 엔진 설정
- `Engine.create()`의 gravity를 `{ x: 0, y: 0 }`으로 설정한다.
- 기존 핀볼의 죽음구역, 플런저, 깔대기 경사면은 포함하지 않는다.
- 게임 필드를 상하 대칭 구조로 구성한다 (상단: AI 플립퍼, 하단: 플레이어 플립퍼).

### 3단계: AI 플립퍼 구현
- 화면 상단에 AI 전용 플립퍼 2개를 배치한다 (플레이어 플립퍼의 상하 반전 위치).
- `beforeUpdate` 이벤트에서 공의 좌표를 감지하여 AI 플립퍼를 자동 작동시키는 로직을 작성한다.
- AI 판정: 공이 AI 플립퍼의 일정 거리 이내에 진입하면 해당 플립퍼를 활성화한다.

### 4단계: 공 발사 방식
- 게임 시작 시 필드 중앙에서 랜덤 방향으로 공을 발사한다.

### 5단계: 채팅 UI 구현
- `AIPinballPage.jsx`의 레이아웃에서 게임 캔버스 옆에 채팅 패널을 배치한다.
- 채팅 패널 구성: 메시지 목록 영역, 텍스트 입력 필드, 전송 버튼.
- MUI 컴포넌트(Box, TextField, Button, List)를 사용한다.

### 6단계: 채팅 백엔드 API 구현
- `backend/routers/chat.py`에 채팅 엔드포인트를 생성한다.
- `POST /api/v1/chat`: 사용자 메시지를 받아 LLM API에 전달하고 응답을 반환한다.
- LLM API 호출을 위한 서비스 모듈(`backend/services/llm_service.py`)을 생성한다.

### 7단계: 프론트엔드-백엔드 채팅 연동
- Axios로 `POST /api/v1/chat` 호출하여 메시지를 전송하고 응답을 표시한다.
- 로딩 상태를 표시한다 (AI 응답 대기 중 인디케이터).

## 사용 할 기술 및 패키지

| 기술/패키지 | 용도 |
|-------------|------|
| Matter.js (기존) | AI 대전 핀볼 물리 엔진 (중력 0, AI 플립퍼 제어) |
| React 19 (기존) | AI 대전 핀볼 페이지 및 채팅 UI 컴포넌트 |
| React Router (기존) | `/ai-pinball` 경로 추가 |
| MUI 7 (기존) | 채팅 패널 UI 구성 (Box, TextField, Button) |
| Axios (기존) | 프론트엔드에서 채팅 API 호출 |
| FastAPI (기존) | 채팅 API 엔드포인트 |
| Anthropic Python SDK | 백엔드에서 Claude API 호출 (LLM 채팅) |

## 테스트 방법

1. **기존 핀볼 유지 확인**: `/pinball` 경로에서 기존 1인용 핀볼이 정상 동작하는지 확인한다.
2. **AI 대전 물리 테스트**: `/ai-pinball`에서 공이 중력 없이 벽에 반사되며 자유롭게 움직이는지 확인한다.
3. **AI 플립퍼 테스트**: 공이 AI 플립퍼 근처에 접근했을 때 플립퍼가 자동으로 작동하는지 확인한다.
4. **공 발사 테스트**: 게임 시작 시 공이 필드 중앙에서 랜덤 방향으로 발사되는지 확인한다.
5. **채팅 UI 테스트**: 게임 화면 옆에 채팅 패널이 표시되고, 메시지 입력 후 전송이 되는지 확인한다.
6. **AI 채팅 테스트**: 메시지를 보내면 LLM AI가 응답을 반환하고 채팅 목록에 표시되는지 확인한다.
7. **동시 동작 테스트**: 게임 플레이 중 채팅이 정상 동작하고, 채팅 중 게임이 멈추지 않는지 확인한다.

## 체크리스트

- [ ] `/pinball` 경로에서 기존 1인용 핀볼이 변경 없이 정상 동작한다
- [ ] `/ai-pinball` 경로에서 AI 대전 핀볼 페이지가 정상 렌더링된다
- [ ] 공이 아래로 떨어지지 않고 벽에 반사되며 자유롭게 움직인다
- [ ] AI 플립퍼가 화면 상단에 표시되고 공 접근 시 자동으로 회전한다
- [ ] 게임 시작 시 공이 필드 중앙에서 랜덤 방향으로 발사된다
- [ ] 게임 캔버스 옆에 채팅 패널이 정상 렌더링된다
- [ ] 채팅 입력 후 전송 버튼 클릭 시 메시지가 목록에 표시된다
- [ ] AI가 채팅 메시지에 대해 응답을 반환하고 화면에 표시된다
- [ ] 게임 플레이 중 채팅 전송/수신이 게임 성능에 영향을 주지 않는다
- [ ] 키보드 입력이 채팅 입력 중일 때 플립퍼를 작동시키지 않는다
