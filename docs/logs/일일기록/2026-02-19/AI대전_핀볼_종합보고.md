# AI 대전 핀볼 기능 - 종합 보고서

> 작성일: 2026-02-19
> 대상 문서: `1_AI대전_핀볼_상세PRD.md` / `2_AI대전_핀볼_UI_상세PRD.md` / `3_AI대전_핀볼_API_상세PRD.md`

---

## 1. 기획 요약

기존 1인용 핀볼 게임(`/pinball`)에 **AI 대전 모드**(`/ai-pinball`)를 추가한다. 핵심은 두 가지다.

1. **AI 플리퍼**: 화면 상단에 AI가 조작하는 플리퍼를 배치해 공을 막는 물리적 대전 구조 구현
2. **AI 채팅**: 게임 화면 우측에 채팅 패널을 두어 플레이어가 LLM AI(Gemini)와 실시간 대화 가능

기존 핀볼의 물리 엔진, 필드, 스테이지, 점수 체계 등 모든 구조는 **그대로 유지**하며, 최소한의 코드 변경으로 기능을 추가한다.

---

## 2. 구현 범위 개요

| 영역 | 변경 내용 | 문서 |
|------|-----------|------|
| 게임 로직 | AIPinball.jsx 신규 생성, AI 플리퍼 추가, 점수 API 비활성화 | 문서 1 |
| 채팅 UI | ChatPanel / ChatMessage / ChatInput 컴포넌트 신규 개발 | 문서 2 |
| 백엔드 API | `POST /api/v1/chat` 엔드포인트, Gemini LLM 서비스 모듈 | 문서 3 |

---

## 3. 게임 로직 (문서 1 요약)

### 접근 방식

`Pinball.jsx`를 그대로 복사해 `AIPinball.jsx`를 만든 후, AI 관련 코드만 최소 추가한다. 기존 `/pinball` 경로와 코드는 일절 변경하지 않는다.

### 파일 구조 변경

```
frontend/src/pages/
└── AIPinball/
    ├── AIPinball.jsx     # Pinball.jsx 복사본 + AI 추가
    └── index.js
```

`App.jsx`에 `/ai-pinball` 라우트를 추가하고, `PinballPage.jsx`는 `GameComponent` prop을 받도록 수정해 재사용성을 확보한다.

### AI 플리퍼 스펙

| 항목 | AI 왼쪽 플리퍼 | AI 오른쪽 플리퍼 |
|------|--------------|----------------|
| 위치 | `(400, 105)` | `(265, 105)` |
| 색상 | `#e74c3c` (빨간색) | `#e74c3c` (빨간색) |
| 제어 | 자동 (공 위치 감지) | 자동 (공 위치 감지) |

- 공이 `y < 300` 영역으로 올라오고 위 방향 속도일 때 AI 플리퍼 활성화
- 플레이어 플리퍼와 좌우 반전, 각도 클램핑으로 물리적으로 자연스러운 동작 구현

### 기존 핀볼과 차이점

| 항목 | 기존 1인용 | AI 대전 |
|------|-----------|---------|
| 경로 | `/pinball` | `/ai-pinball` |
| 플리퍼 | 하단 2개 (플레이어) | 하단 2개 + 상단 2개(AI) |
| AI 제어 | 없음 | 공 위치 기반 자동 제어 |
| 점수 저장 | 서버 저장 | **비활성화** (AI 대전 모드에서 제외) |

---

## 4. 채팅 UI (문서 2 요약)

### 컴포넌트 구조

```
frontend/src/components/ChatPanel/
├── ChatPanel.jsx     # 레이아웃 및 상태 관리
├── ChatMessage.jsx   # 말풍선 (사용자/AI 구분)
└── ChatInput.jsx     # 입력 필드 + 전송 버튼
```

### 레이아웃

게임 화면 우측에 **350px 고정 너비** 패널 배치.

```
┌─────────────────────────┐
│  💬 AI Chat        [✕]  │  ← 헤더 (48px)
├─────────────────────────┤
│                         │
│  AI 메시지 (좌측)        │
│       사용자 메시지 (우측)│
│  AI 응답 대기 ●●●        │  ← 로딩 인디케이터
│                         │
├─────────────────────────┤
│ [메시지를 입력하세요] [▶] │  ← 입력 영역 (56px)
└─────────────────────────┘
```

### 디자인 원칙

- 기존 프로젝트 다크 테마 컬러 시스템 유지 (`#0F172A`, `#1E293B`, `#334155`)
- MUI(Material-UI) 7.x, sx prop 기반 스타일링
- 데스크탑 전용

### 주요 인터랙션

| 기능 | 동작 |
|------|------|
| 메시지 전송 | `Enter` 키 또는 전송 버튼 |
| 자동 스크롤 | 새 메시지 추가 시 하단으로 smooth 스크롤 |
| 로딩 인디케이터 | AI 응답 대기 중 바운스 점 3개 |
| 게임 키 차단 | 채팅 입력 포커스 시 ArrowLeft/ArrowRight/Space 게임 전달 차단 |
| 전송 비활성화 | 입력 비어있거나 AI 응답 대기 중에는 전송 불가 |

---

## 5. 백엔드 API (문서 3 요약)

### 신규 엔드포인트

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/v1/chat` | 대화 히스토리를 받아 Gemini AI 응답 반환 |

### 신규 파일

| 파일 | 역할 |
|------|------|
| `backend/app/services/llm_service.py` | Google Gemini SDK 래퍼, 시스템 프롬프트 설정 |
| `backend/app/schemas/chat.py` | ChatRequest / ChatResponse Pydantic 모델 |
| `backend/app/api/v1/chat.py` | 채팅 라우터 |

### LLM 설정

- **모델**: `gemini-1.5-flash`
- **시스템 프롬프트**: 핀볼 대전 중인 AI 캐릭터로 2~3문장 이내 짧은 응답
- **환경변수**: `GEMINI_API_KEY` 추가 필요
- **신규 패키지**: `google-generativeai >= 0.8.0`

### AI 자율 발화 로직

탁구식 1:1 응답이 아닌, AI가 게임 상황을 감지해 자율적으로 말을 거는 구조.

| 트리거 시점 | 발화 확률 | 비고 |
|------------|----------|------|
| 게임 시작 | 50% | 먼저 인사 |
| 점수 변화 | 30% | 상황 코멘트 |
| 목숨 감소 | 30% | 상황 코멘트 |
| 플레이어 메시지 수신 | 100% | 항상 응답 |

- 연속 자율 발화 방지: 마지막 발화 후 **최소 15초 쿨다운**
- 중복 호출 방지: `isAISpeaking` 플래그로 동시 발화 차단
- 히스토리 제한: 최근 20개 메시지만 API에 전송 (토큰 비용 관리)

---

## 6. 전체 아키텍처 흐름

```
플레이어 조작 (키보드)
    ↓
[AIPinball.jsx] ← Matter.js 물리 엔진
    ├── 하단 플리퍼 (플레이어 조작)
    └── 상단 플리퍼 (AI 자동 제어)

플레이어 채팅 입력
    ↓
[ChatPanel.jsx]
    ↓
POST /api/v1/chat (FastAPI)
    ↓
[llm_service.py] → Google Gemini API
    ↓
AI 응답 → ChatPanel에 표시

게임 이벤트 (점수/목숨 변화)
    ↓
확률 판정 → AI 자율 발화 트리거
    ↓
POST /api/v1/chat → AI 응답 → ChatPanel에 표시
```

---

## 7. 체크리스트 (전체)

### 게임 로직

- [ ] `/pinball` 기존 핀볼 정상 동작 (변경 없음)
- [ ] `/ai-pinball` 접속 및 기본 게임 동작
- [ ] 화면 상단 AI 플리퍼 2개 표시 (빨간색)
- [ ] 공 상단 진입 시 AI 플리퍼 자동 작동
- [ ] 플레이어 플리퍼 정상 조작
- [ ] 게임오버 시 점수 API 미호출 확인

### 채팅 UI

- [ ] 사용자/AI 메시지 좌우 정렬 및 색상 구분
- [ ] AI 응답 대기 중 바운스 인디케이터 표시
- [ ] 새 메시지 자동 스크롤
- [ ] 채팅 입력 시 게임 키 차단
- [ ] 빈 입력 / 대기 중 전송 버튼 비활성화

### 백엔드 API

- [ ] `POST /api/v1/chat` 정상 응답 반환
- [ ] 게임 시작 시 50% 확률 AI 인사
- [ ] 점수/목숨 변화 시 30% 확률 AI 코멘트
- [ ] 15초 쿨다운 준수
- [ ] 에러 시 적절한 HTTP 500 응답

---

## 8. 신규 의존성 및 환경 변수

| 항목 | 내용 |
|------|------|
| 신규 패키지 | `google-generativeai >= 0.8.0` (`backend/requirements.txt` 추가) |
| 환경 변수 | `GEMINI_API_KEY` (`backend/.env` 추가) |
| 프론트엔드 | MUI 7.x, MUI Icons 7.x (기존 의존성 확인 필요) |
