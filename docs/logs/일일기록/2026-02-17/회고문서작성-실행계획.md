# 회고 문서 작성 실행계획

## 요구사항 요약

**요구사항**: `docs/retrospective.md` 회고 문서 작성

**목적**: 프로젝트 전반의 타임라인, 기술 의사결정 배경, 트러블슈팅 사례, 잘된 점·아쉬운 점을 기록하여 향후 유사 프로젝트의 참고 자료로 활용한다.

---

## 현재상태 분석

- `docs/` 하위에 `logs/`, `prd/` 폴더만 있고 `retrospective.md`는 존재하지 않음
- `docs/logs/업무일지/` 에 2026-01-17 ~ 2026-02-16 총 37개 업무일지 파일 존재
- 프로젝트 시작: 2026-01-17 (로그인 API 연동)
- 종료: 2026-02-16 (마무리 커밋)
- MySQL → PostgreSQL 전환: 2026-02-08 TDD 구조 구축 시 conftest.py에 `hexdb_test` (PostgreSQL) 명시됨
- pytest testDB 문제: 2026-02-16 업무일지에 SAVEPOINT → TRUNCATE 방식으로 전면 재작성 기록 존재

---

## 구현 방법

마크다운 형식으로 `docs/retrospective.md`를 신규 생성한다. 37개 업무일지와 git 커밋 히스토리에서 수집한 사실 정보를 기반으로 4개 섹션으로 구성한다.

---

## 구현 단계

### 1. 프로젝트 개요 및 타임라인 섹션 작성

```markdown
## 프로젝트 개요

Pinball_web은 Matter.js 물리 엔진 기반의 멀티플레이어 핀볼 게임을 위한 풀스택 웹 플랫폼이다.
React/Vite 프론트엔드, FastAPI 백엔드, PostgreSQL 데이터베이스,
Traefik + Docker Compose 기반 프로덕션 배포로 구성된다.
총 개발 기간은 2026-01-17부터 2026-02-16까지 약 31일이다.

---

## 타임라인

### Phase 1: 백엔드 기반 구축 (2026-01-17 ~ 01-22)

| 날짜 | 작업 내용 |
|------|-----------|
| 01-17 | 로그인 페이지에서 FastAPI 로그인 API 연동 |
| 01-18 | FastAPI API Key 인증 도입; 핀볼 플리퍼 추가 및 각도 제한 구현 |
| 01-19 | MySQL users 테이블에 role 컬럼 추가 및 FastAPI 연동 |
| 01-20 | 핀볼 플리퍼 진동 버그 해결; 핀볼 중력 적용; Admin 메인 페이지 구현 |
| 01-21 | FastAPI Docker 환경 MySQL 연결 및 기본 API 구축; Admin 페이지 UI |
| 01-22 | 회원가입 엔드포인트 구현 (범용/일반 분리); DB 마이그레이션; User CRUD DB 연동 |

주요 성과:
- Docker + MySQL 환경에서 FastAPI 백엔드 기반 완성
- API Key 인증, 회원가입/로그인, User CRUD 완전 연동
- 핀볼 물리 엔진(Matter.js) 초기 구조 확립 (중력, 플리퍼, 각도 제한)

---

### Phase 2: 핀볼 게임 고도화 및 DB 확장 (2026-01-23 ~ 01-31)

| 날짜 | 작업 내용 |
|------|-----------|
| 01-23 | friendships 테이블 생성; POST /api/friend-requests DB 연결; 친구 승인/거절 API |
| 01-24 | Admin 데이터 시딩(관리자 계정 자동 생성); Dashboard에 핀볼 인라인 렌더링 |
| 01-25 | 핀볼 범퍼 추가; 배경이미지 캔버스 전체 채움 수정; UserInfo 회원정보 조회 버그 해결 (`response.data.id` → `response.data.user_id`) |
| 01-26 | 핀볼 점수 DB 저장 (Score 테이블); game_visits 테이블 생성 |
| 01-27 | friendships 컬럼명 변경 (addressee_id → receiver_id); 핀볼 죽음구역 추가; 부활 기능; target 오브젝트 구현 |
| 01-28 | 핀볼 스테이지 전환 시스템 설계; 반응형 스케일링; 충돌 사운드; 범퍼 시각 개선; UI/게임 영역 분리 |
| 01-29 | 관리자 회원목록 테이블 UI; Dashboard 한달 랭킹 TOP 10; 관리자 페이지 자동 이동; 사이드바 메뉴 개선 |
| 01-30 | 사이드바 토글(모바일 대응); UserInfo 회원정보 수정 FastAPI 연동; 월간 점수 API 초안 |
| 01-31 | 월간 점수 CRUD 5개 엔드포인트 DB 연결 (메모리 → DB); 친구 요청 GET 양방향 검색 및 status 필터 추가 |

주요 성과:
- 친구 관계 시스템 완성 (요청/승인/거절, 중복 방지, 역방향 검증)
- 핀볼 게임 핵심 기능 완성 (죽음구역, 부활, target, 스코어, 스테이지 구조)
- 월간 랭킹 시스템 DB 연결 완료

---

### Phase 3: 관리자 통계·게임 방문 API·DB 마이그레이션 (2026-02-01 ~ 02-07)

| 날짜 | 작업 내용 |
|------|-----------|
| 02-01 | 핀볼 게임 오버 오버레이 UI; 점수 API 연동(POST /api/v1/monthly-scores); useEffect 클로저 버그 수정(score 0 전송 → scoreRef); 깔대기 구조 리디자인; 점수 증가 mechanic 추가 |
| 02-03 | 프론트엔드 폴더 구조 개선 (react/main → frontend); Admin 통계 페이지 및 MUI LineChart 추가; Dashboard 월간 랭킹 API 연동; 회원 탈퇴 기능 구현 |
| 02-04 | GameVisit POST/GET/DELETE API 구현 (IP 기반 중복 방지); monthly_scores에 nickname 비정규화 저장; Users API에서 API Key 인증 제거; 백엔드 core 모듈 분리 (config.py, security.py) |
| 02-05 | MySQL → PostgreSQL 마이그레이션 (드라이버 교체, DATABASE_URL 환경변수화, 447건 데이터 이동); users 테이블에 UUID 컬럼 추가; friendships 외래키 제약 추가 |
| 02-06 | 핀볼 스테이지 시스템 구현 (stageConfigs.js 분리, loadStageMap() 함수, 'n' 키 전환) |
| 02-07 | 프론트엔드 TDD 구조 구축 (Vitest, React Testing Library, vitest.config.js) |

주요 성과:
- PostgreSQL 전환 및 데이터 무결성 강화 (FK 제약, UUID 컬럼)
- 핀볼 스테이지 시스템 분리 설계 (스테이지 데이터 외부 파일 관리)
- 프론트엔드·백엔드 TDD 기반 마련

---

### Phase 4: TDD 고도화·백엔드 리팩토링·친구 페이지 (2026-02-08 ~ 02-12)

| 날짜 | 작업 내용 |
|------|-----------|
| 02-08 | 백엔드 TDD 구조 구축 (pytest, conftest.py, hexdb_test PostgreSQL 테스트 DB, TESTING 환경변수 분기) |
| 02-09 | HighScore FK 제약 TDD 적용 (RED → GREEN 사이클); HighScore API 구현 |
| 02-10~02-12 | 백엔드 모듈화 (app/api/v1/ 라우터 분리); 친구 목록 페이지 프론트엔드 연동 |

주요 성과:
- TDD 사이클(RED → GREEN → REFACTOR)을 실제 API 개발에 적용
- 백엔드 단일 main.py에서 라우터 기반 모듈화로 구조 개선

---

### Phase 5: 마무리 및 정리 (2026-02-13 ~ 02-16)

| 날짜 | 작업 내용 |
|------|-----------|
| 02-13 | game_visits FK 제약 추가 (user_id NULL 보존 전략 적용); 핀볼 전용 페이지(/pinball) 분리 |
| 02-14 | 핀볼 모바일 대응; 5스테이지 범퍼 레이아웃 완성 |
| 02-15 | high_scores/scores 테이블 및 관련 API 정리 삭제 |
| 02-16 | pytest testDB SAVEPOINT → TRUNCATE 방식으로 conftest.py 전면 재작성; game_visits FK 사전 검증 추가; 마무리 |

주요 성과:
- 불필요 테이블(high_scores, scores) 정리로 데이터 모델 단순화
- pytest 격리 방식 전환으로 안정적인 테스트 환경 확보
- 5스테이지 핀볼 게임 완성
```

- 5개 Phase로 프로젝트 진행 흐름을 일별 상세 타임라인과 함께 기록한다
- 총 기간: 31일 (2026-01-17 ~ 2026-02-16)
- 각 Phase의 주요 성과를 별도로 정리하여 맥락을 전달한다

---

### 2. 기술 의사결정 섹션 작성

```markdown
## 기술적 의사결정

### MySQL → PostgreSQL 전환
- **결정**: 초기 MySQL 사용에서 PostgreSQL로 전환
- **배경**: 프로젝트 규모 확장에 따라 PostgreSQL의 성능과
  JSON 지원을 활용하기 위해 전환; TDD 환경 구축(2026-02-08) 시
  conftest.py에 `hexdb_test` PostgreSQL DB를 사용하도록 설계됨
- MySQL은 레거시 백업으로 docker-compose에 유지

### ON DELETE CASCADE 미적용
- **결정**: FK에 CASCADE 없이 API에서 수동 삭제
- **배경**: 삭제 순서 제어와 game_visits 방문 기록 보존(user_id → NULL)을
  위해 의도적으로 CASCADE를 사용하지 않음

### MonthlyScore nickname 비정규화
- **결정**: monthly_scores 테이블에 nickname 컬럼 중복 저장
- **배경**: 랭킹 조회 시 JOIN 없이 빠른 표시를 위해 비정규화 적용
```

- 3개 핵심 결정의 배경을 기록한다

---

### 3. 트러블슈팅 사례 섹션 작성

```markdown
## 트러블슈팅 사례

### 사례 1: pytest testDB SAVEPOINT 문제 (2026-02-16)
- **문제**: testDB에서 SAVEPOINT 방식 적용 시 `commit() → refresh()` 패턴과
  구조적으로 충돌하여 `InvalidRequestError` 발생
- **원인**: 프로덕션 코드 전체가 `db.commit()` 직후 `db.refresh()`를 호출하는데,
  `after_transaction_end` 이벤트로 SAVEPOINT를 재시작해도 refresh 시점이 앞서 실행됨
- **해결**: SAVEPOINT 방식을 버리고 `autouse=True` + `TRUNCATE TABLE ... RESTART IDENTITY CASCADE`
  방식으로 conftest.py를 전면 재작성함

### 사례 2: useEffect 클로저로 인한 점수 전송 버그 (2026-02-01)
- **문제**: 게임 오버 시 API에 항상 0점이 전송됨
- **원인**: `useEffect([], [])`로 생성된 클로저가 `score` 초기값 0을 캡처하여 고정됨
- **해결**: `scoreRef = useRef(0)` 생성 후 `useEffect([score])` 로 매 변경 시 동기화,
  API 전송 시 `scoreRef.current` 사용

### 사례 3: undefined user.id로 API 호출 (2026-01-25)
- **문제**: UserInfo.jsx에서 axios 요청이 실행되지 않고 에러도 발생하지 않음
- **원인**: Login.jsx에서 `response.data.id`(undefined)를 저장; `useEffect`의
  `if (user && user.id)` 조건이 false가 되어 fetch 함수 자체가 호출되지 않음
- **해결**: `response.data.user_id`(올바른 필드명)로 수정
```

- 3개 대표 트러블슈팅 사례를 기록한다

---

### 4. 잘된 점·아쉬운 점·배운 점 섹션 작성

```markdown
## 잘된 점·아쉬운 점·배운 점

### 잘된 점
- PRD → PLAN → 실행 → 업무일지의 개발 사이클을 일관되게 유지함
- TDD 구조를 도입하여 API 회귀 테스트 기반을 마련함
- Docker Compose + Traefik으로 프로덕션 환경과 동일한 로컬 환경 구성

### 아쉬운 점
- API Key를 코드에 하드코딩; 환경변수 처리가 미완성 상태
- 프론트엔드 라우트 가드 미구현; 비로그인 사용자가 보호 페이지에 직접 접근 가능
- HighScore, Score 테이블이 나중에 삭제됨; 초기 설계 단계에서 테이블 필요성을 충분히 검토하지 않았음

### 배운 점
- `useEffect` 클로저 문제 해결에 `useRef` 패턴 활용
- SQLAlchemy 2.0 방식(`DeclarativeBase`)과 SAVEPOINT 트랜잭션 격리의 한계
- Traefik + Cloudflare DNS Challenge 조합으로 자동 인증서 갱신 운영
```

- 잘된 점 3개, 아쉬운 점 3개, 배운 점 3개를 기록한다

---

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| `docs/retrospective.md` | 생성 | 타임라인, 기술 의사결정, 트러블슈팅, 회고 4개 섹션 |

---

## 완료 체크리스트

- [ ] `docs/retrospective.md` 파일이 존재한다
- [ ] MySQL → PostgreSQL 전환 배경이 기술되어 있다
- [ ] pytest testDB 문제(SAVEPOINT → TRUNCATE 전환) 트러블슈팅 사례가 포함되어 있다
- [ ] 프로젝트 타임라인(시작일·종료일·주요 단계)이 기록되어 있다
- [ ] 잘된 점, 아쉬운 점, 배운 점 항목이 각 1개 이상 포함되어 있다
