# 업무일지

## 기본 정보
- 날짜: 2026-02-16 (월) 15:30~16:00
- 작성자: hexsera

## 진행 목표
`POST /api/v1/game_visits` 및 `PUT /api/v1/game_visits` 요청 시 `user_id`가 `users` 테이블에 존재하는지 사전 검증하여 DB FK 오류(IntegrityError) 방지

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| PRD 작성 | `PRD/game_visits fk검사prd.md` | 요구사항 정의 |
| 실행계획 작성 | `PRD/game_visits_fk검사-실행계획.md` | 코드베이스 분석 후 구현 계획 수립 |
| User 모델 import 추가 | `backend/app/api/v1/game_visits.py` | User 존재 여부 조회 위해 추가 |
| POST 엔드포인트 검증 로직 추가 | `backend/app/api/v1/game_visits.py` | user_id → users 테이블 조회 후 없으면 404 반환 |
| PUT 엔드포인트 검증 로직 추가 | `backend/app/api/v1/game_visits.py` | 동일 패턴 적용 |
| 테스트 (5 케이스) | - | curl로 POST/PUT 각 케이스 검증 |

**총 1시간**

## 주요 변경 사항

### 1. `backend/app/api/v1/game_visits.py` 수정

**변경 전:**
```python
from models import GameVisit
```

**변경 후:**
```python
from models import GameVisit, User
```

**특징:**
- User 모델을 import하여 user_id 존재 여부 조회에 사용

---

**변경 전 (POST 엔드포인트):**
```python
def create_game_visit(...):
    """게임 접속 기록 생성 (오늘 날짜 + IP 기준 중복 방지)"""
    # 클라이언트 IP 추출
    client_ip = get_client_ip(request)
    ...
```

**변경 후 (POST 엔드포인트):**
```python
def create_game_visit(...):
    """게임 접속 기록 생성 (오늘 날짜 + IP 기준 중복 방지)"""
    # user_id가 전달된 경우 users 테이블에서 존재 여부 확인
    if visit_data.user_id is not None:
        user = db.query(User).filter(User.id == visit_data.user_id).first()
        if user is None:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User with id {visit_data.user_id} not found"
            )

    # 클라이언트 IP 추출
    client_ip = get_client_ip(request)
    ...
```

**특징:**
- `user_id`가 `None`이면 검증 건너뜀 (비로그인 사용자 허용)
- `user_id`가 있을 때만 DB 조회 → 없으면 HTTP 404 반환 후 INSERT 차단

---

**변경 전 (PUT 엔드포인트):**
```python
def update_game_visit(...):
    """IP 주소 기반 게임 접속 기록 업데이트 (is_visits = True)"""
    # IP 주소로 레코드 조회
    game_visit = db.query(GameVisit).filter(...)
    ...
```

**변경 후 (PUT 엔드포인트):**
```python
def update_game_visit(...):
    """IP 주소 기반 게임 접속 기록 업데이트 (is_visits = True)"""
    # user_id가 전달된 경우 users 테이블에서 존재 여부 확인
    if visit_data.user_id is not None:
        user = db.query(User).filter(User.id == visit_data.user_id).first()
        if user is None:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User with id {visit_data.user_id} not found"
            )

    # IP 주소로 레코드 조회
    game_visit = db.query(GameVisit).filter(...)
    ...
```

**특징:**
- POST와 동일한 패턴으로 검증 로직 추가

## 테스트 결과

| # | 케이스 | 기대 결과 | 실제 결과 |
|---|--------|-----------|-----------|
| 1 | POST — 존재하지 않는 `user_id=99999` | 404 | ✅ 404 |
| 2 | POST — `user_id=null` (비로그인) | 201 | ✅ 201 |
| 3 | POST — 유효한 `user_id=1` | 201 | ✅ 201 |
| 4 | PUT — 존재하지 않는 `user_id=99999` | 404 | ✅ 404 |
| 5 | PUT — 유효한 `user_id=2` | 200 | ✅ 200 |

## 결과
- 상태: 완료

## 배운 내용

## 다음 작업
- 없음

---

## 기본 정보 (2차 작업)
- 날짜: 2026-02-16 (월) 16:00~16:30
- 작성자: hexsera

## 진행 목표
`monthly_scores` API에서 이번 달(1일~말일) 범위의 레코드만 대상으로 조회·등록되도록 제한하여, 월이 바뀌었을 때 이전 달 점수가 이번 달 점수로 오인되는 문제 방지

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| 실행계획 확인 | `PRD/monthly_scores_이번달범위제한-실행계획.md` | 요구사항 및 구현 방법 검토 |
| 헬퍼 함수 `get_current_month_range()` 추가 | `backend/app/api/v1/monthly_scores.py` | POST/GET 공통 사용, 중복 제거 |
| POST 기존 점수 조회에 이번 달 범위 필터 추가 | `backend/app/api/v1/monthly_scores.py` | 이전 달 레코드를 별개 레코드로 취급 |
| GET `/` 전체 조회 `date` → `datetime` 타입 교체 | `backend/app/api/v1/monthly_scores.py` | 말일 00:00:00 이후 데이터 누락 버그 수정 |
| GET `/{user_id}` 단일 조회에 이번 달 범위 필터 추가 | `backend/app/api/v1/monthly_scores.py` | 이전 달 레코드만 있으면 404 반환 |
| 미사용 `date` import 제거 | `backend/app/api/v1/monthly_scores.py` | 코드 정리 |

## 주요 변경 사항

### `backend/app/api/v1/monthly_scores.py`

**헬퍼 함수 추가:**
```python
def get_current_month_range():
    """이번 달 시작(1일 00:00:00)과 끝(말일 23:59:59)을 반환"""
    now = datetime.now()
    year, month = now.year, now.month
    _, last_day = monthrange(year, month)
    start = datetime(year, month, 1, 0, 0, 0)
    end = datetime(year, month, last_day, 23, 59, 59)
    return start, end
```

**POST — 이번 달 범위 필터 적용:**
```python
# 변경 전
existing_score = db.query(MonthlyScore).filter(
    MonthlyScore.user_id == score_data.user_id
).first()

# 변경 후
start, end = get_current_month_range()
existing_score = db.query(MonthlyScore).filter(
    MonthlyScore.user_id == score_data.user_id,
    MonthlyScore.created_at >= start,
    MonthlyScore.created_at <= end
).first()
```

**GET `/` — `date` → `datetime` 타입 교체:**
```python
# 변경 전: date 타입 비교 → 말일 00:00:00 이후 데이터 누락
start_date = date(year, month, 1)
end_date = date(year, month, last_day)

# 변경 후: datetime 타입으로 말일 23:59:59까지 포함
start, end = get_current_month_range()
```

**GET `/{user_id}` — 이번 달 범위 필터 추가:**
```python
# 변경 전: 날짜 필터 없음
score = db.query(MonthlyScore).filter(
    MonthlyScore.user_id == user_id
).first()

# 변경 후
start, end = get_current_month_range()
score = db.query(MonthlyScore).filter(
    MonthlyScore.user_id == user_id,
    MonthlyScore.created_at >= start,
    MonthlyScore.created_at <= end
).first()
```

## 결과 
- 상태: 완료
