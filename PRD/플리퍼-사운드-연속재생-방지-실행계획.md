# 플리퍼 사운드 연속 재생 방지 실행계획

## 요구사항 요약

**요구사항**: 플립퍼 키(ArrowLeft, ArrowRight)를 오래 누를 때 사운드가 반복 재생되는 문제를 수정한다. 플립퍼 상태가 false → true로 바뀌는 순간에만 사운드를 재생한다.

**목적**: 키를 누르는 동안 OS의 키 반복(key repeat) 기능으로 keydown 이벤트가 연속 발생해 사운드가 중복 재생되는 현상을 제거한다.

## 현재상태 분석

- `handleKeyDown`에서 ArrowLeft/ArrowRight 감지 시 즉시 `playFlipperSound()`를 호출한다.
- OS는 키를 누르고 있으면 keydown 이벤트를 반복적으로 발생시킨다(key repeat).
- `isLeftKeyPressed.current`, `isRightKeyPressed.current` ref가 이미 존재하며 키 누름 상태를 추적하고 있다.
- 터치(handleTouchStart)와 포인터(onPointerDown) 핸들러는 반복 호출이 없으므로 수정 불필요하다.

## 구현 방법

`pressFlipperKey(ref)` / `releaseFlipperKey(ref)` 헬퍼 함수를 만들어 "상태 변경 + 사운드 재생" 로직을 한 곳에서 관리한다. 키 누름·터치·포인터 등 모든 입력 핸들러가 이 함수를 호출하도록 교체한다. `pressFlipperKey`는 ref가 이미 `true`이면 사운드를 재생하지 않고, `false`일 때만 재생 후 `true`로 설정한다. `releaseFlipperKey`는 ref를 `false`로 설정한다.

## 구현 단계

### 1. 헬퍼 함수 정의

```javascript
const pressFlipperKey = (keyRef) => {
  if (!keyRef.current) {
    playFlipperSound(fliperSoundRef.current);
  }
  keyRef.current = true;
};

const releaseFlipperKey = (keyRef) => {
  if (keyRef.current) {
    playFlipperSound(fliperSoundRef.current);
  }
  keyRef.current = false;
};
```
- **무엇을 하는가**: 플립퍼 키 누름/뗌 시 상태 변경과 사운드 재생을 한 곳에서 처리한다.
- `pressFlipperKey`는 `keyRef.current`가 `false`일 때만 사운드를 재생해 key repeat으로 인한 중복 재생을 방지한다.
- `releaseFlipperKey`는 `keyRef.current`가 `true`일 때(실제로 눌려 있던 상태)만 사운드를 재생하고 `false`로 설정한다.
- `keyRef`를 인자로 받으므로 Left/Right 양쪽에서 재사용 가능하다.
- `handleKeyDown` 직전(같은 스코프)에 선언한다.

### 2. handleKeyDown 수정

```javascript
if (event.key === 'ArrowLeft') {
  console.log('왼쪽 방향키 눌림');
  pressFlipperKey(isLeftKeyPressed);
}
if (event.key === 'ArrowRight') {
  console.log('오른쪽 방향키 눌림');
  pressFlipperKey(isRightKeyPressed);
}
```
- **무엇을 하는가**: 기존 인라인 상태 변경·사운드 재생 코드를 헬퍼 함수 호출로 교체한다.
- line 682–690의 기존 코드를 위 코드로 대체한다.

### 3. handleTouchStart 수정

```javascript
if (touchX < centerX) {
  console.log('왼쪽 터치');
  pressFlipperKey(isLeftKeyPressed);
} else {
  console.log('오른쪽 터치');
  pressFlipperKey(isRightKeyPressed);
}
```
- **무엇을 하는가**: 터치 핸들러도 동일한 헬퍼를 사용해 일관성을 확보한다.
- 터치는 key repeat이 없어 사운드 중복 문제는 없지만, 로직 통일을 위해 교체한다.

### 4. handleKeyUp, handleTouchEnd 수정

```javascript
// handleKeyUp
if (event.key === 'ArrowLeft') releaseFlipperKey(isLeftKeyPressed);
if (event.key === 'ArrowRight') releaseFlipperKey(isRightKeyPressed);

// handleTouchEnd
releaseFlipperKey(isLeftKeyPressed);
releaseFlipperKey(isRightKeyPressed);
```
- **무엇을 하는가**: 키/터치를 뗄 때 ref를 `false`로 되돌리는 코드를 헬퍼로 교체한다.
- `handleKeyUp`의 line 747–751, `handleTouchEnd`의 line 778–779를 대체한다.

### 5. onPointerDown JSX 수정

```jsx
onPointerDown={() => pressFlipperKey(isLeftKeyPressedRef)}
onPointerUp={() => releaseFlipperKey(isLeftKeyPressedRef)}
onPointerLeave={() => releaseFlipperKey(isLeftKeyPressedRef)}

onPointerDown={() => pressFlipperKey(isRightKeyPressedRef)}
onPointerUp={() => releaseFlipperKey(isRightKeyPressedRef)}
onPointerLeave={() => releaseFlipperKey(isRightKeyPressedRef)}
```
- **무엇을 하는가**: JSX 인라인 핸들러도 헬퍼로 교체해 모든 입력 경로를 통일한다.
- line 953, 979의 onPointerDown 인라인 코드를 대체한다.

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| `frontend/src/pages/Pinball/Pinball.jsx` | 수정 | `pressFlipperKey`/`releaseFlipperKey` 헬퍼 추가, 모든 입력 핸들러에서 헬퍼 호출로 교체 |

## 완료 체크리스트

- [ ] ArrowLeft를 짧게 눌렀다 떼면 사운드가 1회 재생된다.
- [ ] ArrowLeft를 3초 이상 길게 눌러도 사운드가 1회만 재생된다.
- [ ] ArrowRight를 짧게 눌렀다 떼면 사운드가 1회 재생된다.
- [ ] ArrowRight를 3초 이상 길게 눌러도 사운드가 1회만 재생된다.
- [ ] 키를 떼면 사운드가 1회 재생된다.
- [ ] 키를 떼고 다시 누르면 사운드가 다시 1회 재생된다.
- [ ] 터치/포인터 버튼을 뗄 때도 사운드가 1회 재생된다.
