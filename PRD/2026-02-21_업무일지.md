# 업무일지

## 기본 정보
- 날짜: 2026-02-21 (토)
- 작성자: hexsera

## 진행 목표
기존 1인용 핀볼(`/pinball`)을 유지하면서, 같은 페이지 내에서 버튼 하나로 AI 대전 모드로 전환할 수 있는 기능 구현

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| "AI 대전" 버튼 방식으로 설계 변경 | `PRD/AI대전핀볼-실행계획.md` | 별도 라우트 → 페이지 내 토글로 수정 |
| AI 플리퍼 제어 방식 설계 변경 | `PRD/AI대전핀볼-실행계획.md` | 직접 속도 주입 → bool ref 판단/제어 분리로 수정 |
| AIPinball 컴포넌트 생성 | `frontend/src/pages/AIPinball/AIPinball.jsx` | Pinball.jsx 복사 후 수정 |
| re-export 파일 생성 | `frontend/src/pages/AIPinball/index.js` | 생성 |
| PinballPage에 AI 대전 토글 버튼 추가 | `frontend/src/pages/PinballPage/PinballPage.jsx` | 수정 |


## 주요 변경 사항

### 1. AIPinball/AIPinball.jsx 생성

Pinball.jsx를 복사 후 아래 내용을 수정/추가했다.

**제거:**
- `axios` import
- `useAuth` import 및 `user` 변수
- `bestScore` 상태(`useState`)
- `submitScore()` 함수 전체
- 게임오버 시 `submitScore()` 호출
- 게임오버 오버레이의 `최고 점수` 표시 줄

**타이틀 변경:**
```jsx
// 변경 전
PINBALL

// 변경 후
AI PINBALL
```

**안내문구 추가:**
```jsx
// SPACE 줄 아래에 추가
<Typography sx={{ color: '#aaaaaa', fontSize: '24px', mb: 4 }}>
  AI 플리퍼가 상단에서 공을 막습니다
</Typography>
```

**AI 플리퍼 각도 상수 추가:**
```javascript
const AI_LEFT_MIN_ANGLE  = -35 * Math.PI / 180;  // 올린 상태 (반시계)
const AI_LEFT_MAX_ANGLE  =  15 * Math.PI / 180;  // 내린 상태 (시계)
const AI_RIGHT_MIN_ANGLE = -15 * Math.PI / 180;  // 내린 상태 (반시계)
const AI_RIGHT_MAX_ANGLE =  35 * Math.PI / 180;  // 올린 상태 (시계)
```

**AI 플리퍼 bool ref 추가:**
```javascript
const isAILeftPressed  = { current: false };
const isAIRightPressed = { current: false };
```

**AI 플리퍼 Bodies/Constraint 추가 (기존 플리퍼의 y=995 → y=105, 좌우 반전):**
```javascript
const aiLeftFlipper  = Bodies.rectangle(400, 105, 100, 20, { ... fillStyle: '#e74c3c' });
const aiRightFlipper = Bodies.rectangle(265, 105, 100, 20, { ... fillStyle: '#e74c3c' });

const aiLeftConstraint  = Constraint.create({ bodyA: aiLeftFlipper,  pointA: { x: 40, y:0 }, pointB: { x: 440, y: 105 }, ... });
const aiRightConstraint = Constraint.create({ bodyA: aiRightFlipper, pointA: { x:-40, y:0 }, pointB: { x: 225, y: 105 }, ... });

World.add(engine.world, [..., aiLeftFlipper, aiRightFlipper, aiLeftConstraint, aiRightConstraint]);
```

**beforeUpdate에 AI 판단 + 물리 제어 추가:**
```javascript
// 판단부: bool 갱신
if (ballPos.y < AI_ACTIVATION_Y && ballVel.y < 0) {
  isAILeftPressed.current  = Math.abs(ballPos.x - AI_LEFT_CENTER_X)  < AI_REACTION_DISTANCE;
  isAIRightPressed.current = Math.abs(ballPos.x - AI_RIGHT_CENTER_X) < AI_REACTION_DISTANCE;
} else {
  isAILeftPressed.current  = false;
  isAIRightPressed.current = false;
}

// 제어부: bool 소비 (플레이어 플리퍼와 동일한 구조)
if (isAILeftPressed.current) {
  Body.setAngularVelocity(aiLeftFlipper, FLIPPER_SPEED);
} else {
  Body.setAngularVelocity(aiLeftFlipper, -FLIPPER_SPEED);
}
// ... 각도 클램핑 및 우플리퍼 동일 처리
```

**아키텍처 구조 — AI 플리퍼 판단/제어 흐름:**
```
beforeUpdate (매 프레임)
│
├─ [판단부] ball.position, ball.velocity 읽기
│       │
│       ├─ y < 300 && vy < 0  →  isAILeftPressed.current  = (거리 < 160)
│       │                         isAIRightPressed.current = (거리 < 160)
│       └─ 그 외             →  isAILeftPressed.current  = false
│                                isAIRightPressed.current = false
│
└─ [제어부] bool 읽어서 setAngularVelocity + setAngle 클램핑
         (플레이어 플리퍼 제어 패턴과 동일)
```

---

### 2. AIPinball/index.js 생성

```javascript
export { default } from './AIPinball';
```

---

### 3. PinballPage/PinballPage.jsx 수정

**import 추가:**
```jsx
// 변경 전
import { Box, AppBar, Toolbar, IconButton, CircularProgress } from '@mui/material';
import Pinball from '../Pinball';

// 변경 후
import { Box, AppBar, Toolbar, IconButton, CircularProgress, Button } from '@mui/material';
import Pinball from '../Pinball';
import AIPinball from '../AIPinball';
```

**isAIMode 상태 추가:**
```jsx
const [isAIMode, setIsAIMode] = useState(false);
```

**AppBar에 AI 대전 토글 버튼 추가:**
```jsx
// 변경 전
<IconButton onClick={() => navigate('/')} sx={{ color: '#F1F5F9' }}>
  <HomeIcon />
</IconButton>

// 변경 후
<Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
  <IconButton onClick={() => navigate('/')} sx={{ color: '#F1F5F9' }}>
    <HomeIcon />
  </IconButton>
  <Button
    onClick={() => { setIsAIMode(prev => !prev); setIsReady(false); }}
    variant={isAIMode ? 'contained' : 'outlined'}
    size="small"
    sx={{
      color: isAIMode ? '#ffffff' : '#e74c3c',
      borderColor: '#e74c3c',
      backgroundColor: isAIMode ? '#e74c3c' : 'transparent',
      '&:hover': { backgroundColor: '#c0392b', color: '#ffffff', borderColor: '#c0392b' },
    }}
  >
    {isAIMode ? 'AI 대전 ON' : 'AI 대전'}
  </Button>
</Box>
```

**게임 컴포넌트 조건부 렌더링:**
```jsx
// 변경 전
<Pinball onReady={() => setIsReady(true)} />

// 변경 후
{isAIMode
  ? <AIPinball key="ai"     onReady={() => setIsReady(true)} />
  : <Pinball   key="normal" onReady={() => setIsReady(true)} />
}
```

`key` prop을 다르게 설정하여 모드 전환 시 React가 컴포넌트를 완전히 언마운트·재마운트하도록 강제한다. 이렇게 해야 Matter.js 엔진이 초기화된다.

**아키텍처 구조 — 페이지 컴포넌트 관계:**
```
PinballPage
├── AppBar
│   ├── HomeIcon 버튼
│   ├── "AI 대전" 토글 버튼  ← 신규
│   └── HeaderUserInfo
└── 게임 영역
    ├── isAIMode === false  →  <Pinball key="normal" />   (기존)
    └── isAIMode === true   →  <AIPinball key="ai" />     ← 신규
```

## 결과
- 상태: 완료
- 빌드: `npm run build` 성공 (에러 없음)
- `/pinball` 기존 핀볼 변경 없이 유지
- "AI 대전" 버튼 클릭으로 AIPinball 모드 전환 가능
- AI 플리퍼(빨간색)가 상단에 배치되어 공이 올라올 때 자동으로 작동

## 배운 내용

## 다음 작업
- AI 플리퍼 동작 실제 테스트 및 파라미터 튜닝 (`AI_ACTIVATION_Y`, `AI_REACTION_DISTANCE`)
- AI 대전 모드 점수 체계 검토 (현재 점수 UI는 있으나 서버 저장 없음)
- 모바일 터치 환경에서 AI 대전 모드 동작 확인

---

# 업무일지 (추가)

## 기본 정보
- 날짜: 2026-02-21 (토)
- 작성자: hexsera

## 진행 목표
AI 플립퍼의 작동 방향·각도를 player 플립퍼의 x축 반전으로 수정하고, AI 영역에 경사로를 추가하여 구조를 player 영역과 대칭으로 만들기. 디버깅을 위해 중력 반전 및 공 시작 위치 조정. aiStageConfigs 분리.

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| PRD 작성 (AI 플립퍼 수정) | `PRD/AI플립퍼수정-실행계획.md` | 생성 |
| 엔진 중력 y=1 → -1 변경 | `AIPinball/AIPinball.jsx` | 디버깅용 임시 설정 |
| AI 플립퍼 각도 상수 반전 | `AIPinball/AIPinball.jsx` | player 플립퍼 x축 반전 |
| AI 플립퍼 제어 로직 회전 방향 반전 | `AIPinball/AIPinball.jsx` | setAngularVelocity 부호 반전 |
| AI 깔대기 경사로 Bodies 추가 | `AIPinball/AIPinball.jsx` | player 깔대기의 y축 대칭 위치 |
| 공 시작 위치 변경 | `AIPinball/AIPinball.jsx` | x=662 → x=60, y -200 조정 |
| aiStageConfigs.js 분리 생성 | `AIPinball/aiStageConfigs.js` | stageConfigs.js 복사 |
| AIPinball import 경로 변경 | `AIPinball/AIPinball.jsx` | `../Pinball/stageConfigs` → `./aiStageConfigs` |

## 주요 변경 사항

### 1. AIPinball.jsx 수정 — 엔진 중력

**변경 전:**
```javascript
const engine = Engine.create({
  gravity: { x: 0, y: 1 }
});
```

**변경 후:**
```javascript
const engine = Engine.create({
  gravity: { x: 0, y: -1 }  // 임시: AI 플립퍼 디버깅용
});
```

---

### 2. AIPinball.jsx 수정 — AI 플립퍼 각도 상수

player 플립퍼 각도를 x축 반전하여 AI 플립퍼가 공을 위쪽으로 타격하도록 변경.

**변경 전:**
```javascript
const AI_LEFT_MIN_ANGLE  = -35 * Math.PI / 180;  // 올린 상태
const AI_LEFT_MAX_ANGLE  =  15 * Math.PI / 180;  // 내린 상태
const AI_RIGHT_MIN_ANGLE = -15 * Math.PI / 180;  // 내린 상태
const AI_RIGHT_MAX_ANGLE =  35 * Math.PI / 180;  // 올린 상태
```

**변경 후:**
```javascript
// player Left: -35°(올림)~+15°(내림) → AI Left: -15°(내림)~+35°(올림)
// player Right: -15°(올림)~+35°(내림) → AI Right: -35°(올림)~+15°(내림)
const AI_LEFT_MIN_ANGLE  = -15 * Math.PI / 180;  // 내린 상태
const AI_LEFT_MAX_ANGLE  =  35 * Math.PI / 180;  // 올린 상태
const AI_RIGHT_MIN_ANGLE = -35 * Math.PI / 180;  // 올린 상태
const AI_RIGHT_MAX_ANGLE =  15 * Math.PI / 180;  // 내린 상태
```

---

### 3. AIPinball.jsx 수정 — AI 플립퍼 제어 로직

각도 상수 반전에 맞춰 `setAngularVelocity` 부호도 반전. 각도 제한 clamp는 속도 설정 직후 수행.

**변경 전:**
```javascript
if (isAILeftPressed.current) {
  Body.setAngularVelocity(aiLeftFlipper, FLIPPER_SPEED);   // 올리기 (시계)
} else {
  Body.setAngularVelocity(aiLeftFlipper, -FLIPPER_SPEED);  // 내리기 (반시계)
}

if (isAIRightPressed.current) {
  Body.setAngularVelocity(aiRightFlipper, -FLIPPER_SPEED); // 올리기 (반시계)
} else {
  Body.setAngularVelocity(aiRightFlipper, FLIPPER_SPEED);  // 내리기 (시계)
}
```

**변경 후:**
```javascript
if (isAILeftPressed.current) {
  Body.setAngularVelocity(aiLeftFlipper, -FLIPPER_SPEED);  // 올리기 (반시계)
} else {
  Body.setAngularVelocity(aiLeftFlipper, FLIPPER_SPEED);   // 내리기 (시계)
}

if (isAIRightPressed.current) {
  Body.setAngularVelocity(aiRightFlipper, FLIPPER_SPEED);  // 올리기 (시계)
} else {
  Body.setAngularVelocity(aiRightFlipper, -FLIPPER_SPEED); // 내리기 (반시계)
}
```

**AI 플립퍼 제어 흐름:**
```
beforeUpdate (매 프레임)
│
├─ [판단부] ball.position, ball.velocity 읽기
│       ├─ y < 300 && vy < 0  →  isAILeftPressed / isAIRightPressed = (거리 < 160)
│       └─ 그 외              →  false
│
└─ [제어부] bool → setAngularVelocity(±FLIPPER_SPEED) + setAngle clamp
         AI Left  : true → -FLIPPER_SPEED (반시계/올림), false → +FLIPPER_SPEED (시계/내림)
         AI Right : true → +FLIPPER_SPEED (시계/올림),  false → -FLIPPER_SPEED (반시계/내림)
```

---

### 4. AIPinball.jsx 수정 — AI 깔대기 경사로 추가

player 영역 하단 깔대기(y≈915~925)를 y축 대칭으로 뒤집어 AI 플립퍼(y=105) 양옆에 배치.

**추가:**
```javascript
const AI_FUNNEL_ANGLE = 35 * Math.PI / 180;
const AI_FUNNEL_THICKNESS = 20;

const aiLeftFunnelWall = Bodies.rectangle(105, 185, 260, AI_FUNNEL_THICKNESS, {
  isStatic: true,
  render: { fillStyle: '#16213e' }
});
Body.setAngle(aiLeftFunnelWall, -AI_FUNNEL_ANGLE);  // player +35° → AI -35°

const aiRightFunnelWall = Bodies.rectangle(540, 175, 220, AI_FUNNEL_THICKNESS, {
  isStatic: true,
  render: { fillStyle: '#16213e' }
});
Body.setAngle(aiRightFunnelWall, AI_FUNNEL_ANGLE);  // player -35° → AI +35°

// World.add에 추가
World.add(engine.world, [..., aiLeftFunnelWall, aiRightFunnelWall, ...]);
```

**구조 — player/AI 경사로 대칭:**
```
천장 (y=0)
────────────────────────────────
  \  aiLeftFunnelWall(-35°) /     ← AI 깔대기 (y≈175~185)
   \                        /
    [aiLeft]    [aiRight]          ← AI 플립퍼 (y=105)
────────────────────────────────
          (게임 영역)
────────────────────────────────
    [Left]      [Right]            ← player 플립퍼 (y=995)
   /                        \
  /  leftFunnelWall(+35°)    \    ← player 깔대기 (y≈915~925)
────────────────────────────────
바닥 (y=1100)
```

---

### 5. AIPinball.jsx 수정 — 공 시작 위치 변경

**변경 전:**
```javascript
const ball = Bodies.circle(662, SHELF_Y - 20, 15, { ... });
```

**변경 후:**
```javascript
const ball = Bodies.circle(60, SHELF_Y - 220, 15, { ... });
```

- x: 662(오른쪽 플런저 레인) → 60(왼쪽 벽 근처, 내면 x=40 + 여유)
- y: SHELF_Y - 20 → SHELF_Y - 220 (200px 위에서 시작)

---

### 6. aiStageConfigs.js 생성 및 import 분리

**추가: `AIPinball/aiStageConfigs.js`**

`Pinball/stageConfigs.js` 를 복사하여 AIPinball 전용 스테이지 설정 파일로 분리.

**변경 전 (AIPinball.jsx import):**
```javascript
import { STAGE_CONFIGS, BUMPER_RADIUS } from '../Pinball/stageConfigs';
```

**변경 후:**
```javascript
import { STAGE_CONFIGS, BUMPER_RADIUS } from './aiStageConfigs';
```

## 결과
- 상태: 완료
- AI 플립퍼 각도·회전 방향 x축 반전 적용
- AI 영역 상단에 깔대기 경사로 추가 (player 영역과 대칭)
- 중력 y=-1로 디버깅 환경 설정
- aiStageConfigs.js 분리로 AI 전용 스테이지 독립 관리 가능

## 배운 내용

## 다음 작업
- 브라우저에서 AI 플립퍼 동작 확인 (각도·방향 정상 여부)
- AI 경사로 위치·각도 미세 조정
- 디버깅 완료 후 중력 y=-1 → 정상값으로 복구
