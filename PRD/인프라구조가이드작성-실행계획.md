# 인프라 구조 가이드 작성 실행계획

## 요구사항 요약

**요구사항**: `docs/infrastructure-guide.md` 신규 생성 — 전체 아키텍처 다이어그램, 5개 서비스 역할·포트 표, Traefik·Nginx 설정, 네트워크·볼륨 구성, 요청 라우팅 흐름 작성

**목적**: 인프라 변경·장애 대응 시 구조를 빠르게 파악하기 위해 현재 Docker Compose 기반 인프라 전체를 문서화한다.

---

## 현재상태 분석

- `docker-compose.yml`: 5개 서비스(traefik, nginx, fastapi, mysql, postgres) + `web` 네트워크 + 3개 볼륨 정의
- `traefik.yml`: HTTP→HTTPS 리다이렉트, Docker provider, Cloudflare DNS Challenge, Let's Encrypt 인증서 설정
- `nginx/nginx.conf`: listen 8080, `try_files` SPA 폴백 설정 (현재 nginx 컨테이너는 포트 80으로 라우팅, conf는 개발용)
- `docs/` 디렉토리: `logs/`, `prd/` 폴더만 존재, 인프라 가이드 없음

---

## 구현 방법

마크다운(.md) 형식으로 `docs/infrastructure-guide.md`를 신규 생성한다. 코드 자동 생성 없이 `docker-compose.yml`, `traefik.yml`, `nginx.conf`를 직접 분석하여 내용을 작성한다.

---

## 구현 단계

### 1. 전체 아키텍처 다이어그램 작성

```markdown
## 전체 아키텍처

```
인터넷
  │
  ▼
Traefik (:80 / :443)
  ├─ HTTP(:80) → HTTPS(:443) 리다이렉트
  ├─ Host(hexsera.com) && PathPrefix(/api) → fastapi-server:8000
  └─ Host(hexsera.com)                     → nginx-server:80
                                                  │
                                                  ▼
                                            Nginx (SPA)
                                    (try_files → /index.html)

fastapi-server:8000
  └─ postgres-server:5432 (주 DB)
```
```
- ASCII 텍스트로 요청 흐름을 시각적으로 표현한다.
- Traefik의 두 라우팅 규칙(nginx, fastapi)을 분기로 나타낸다.

### 2. 서비스 목록 및 역할 표 작성

```markdown
## 서비스 목록

| 서비스명 | 컨테이너명 | 이미지 | 호스트 포트 | 역할 |
|----------|-----------|--------|------------|------|
| traefik | traefik | traefik:latest | 80, 443 | 리버스 프록시, SSL/TLS 종단, 라우팅 |
| nginx | nginx-server | nginx:latest | (내부 80) | React SPA 정적 파일 제공 |
| fastapi | fastapi-server | ./backend (빌드) | 8000 | REST API 서버 |
| postgres | postgres-server | postgres:16 | 5432 | 주 데이터베이스 |
| mysql | mysql-server | mysql:8.0 | 3306 | 레거시 백업용 DB |
```
- 5개 서비스 모두 `web` Docker 네트워크에 연결되어 컨테이너명으로 상호 통신한다.
- mysql은 현재 레거시로, 주 DB는 postgres다.

### 3. Traefik 설정 설명 작성

```markdown
## Traefik 설정 (traefik.yml)

- **entryPoints.web** (`:80`): 모든 HTTP 요청을 HTTPS(websecure)로 리다이렉트
- **entryPoints.websecure** (`:443`): HTTPS 요청 처리
- **providers.docker**: Docker 소켓(`/var/run/docker.sock`) 연결로 컨테이너 레이블 자동 감지
  - `exposedByDefault: false` — `traefik.enable=true` 레이블이 있는 컨테이너만 라우팅
- **certificatesResolvers.cloudflare**: Let's Encrypt 인증서를 Cloudflare DNS Challenge 방식으로 발급
  - DNS 리졸버: `1.1.1.1:53` (Cloudflare), `8.8.8.8:53` (Google)
  - 인증서 저장: `./acme.json`
```
- Cloudflare API Token은 `docker-compose.yml`의 `CF_DNS_API_TOKEN` 환경변수로 주입된다.

### 4. 라우팅 규칙 명시 작성

```markdown
## 요청 라우팅 규칙

| 라우터 | 규칙 | 진입점 | 백엔드 |
|--------|------|--------|--------|
| fastapi | `Host(hexsera.com) && PathPrefix(/api)` | websecure | fastapi-server:8000 |
| nginx | `Host(hexsera.com)` | websecure | nginx-server:80 |

> `/api`로 시작하는 경로가 fastapi 라우터가 더 구체적이므로 우선 적용된다.
```
- Traefik은 규칙 구체성 기준으로 라우터 우선순위를 자동 결정한다.
- `fastapi` 라우터가 `nginx` 라우터보다 경로 조건이 더 구체적이므로 `/api/*` 요청을 먼저 처리한다.

### 5. 네트워크·볼륨 구성 작성

```markdown
## 네트워크·볼륨 구성

### 네트워크
| 이름 | 타입 | 설명 |
|------|------|------|
| web | bridge (internal) | 모든 컨테이너가 공유하는 내부 네트워크 |

### 볼륨
| 볼륨명 | 마운트 위치 | 설명 |
|--------|------------|------|
| html-data-volume | nginx:/etc/nginx/html | React 빌드 결과물(dist/) 저장 |
| postgres-data | postgres:/var/lib/postgresql/data | PostgreSQL 데이터 영속화 |
| mysql-data | mysql:/var/lib/mysql | MySQL 데이터 영속화 |
```
- `html-data-volume`에 빌드 결과물(`dist/`)을 복사하면 Nginx가 서빙한다.
- `./backend:/code` 바인드 마운트로 FastAPI는 소스코드를 컨테이너에 실시간 반영한다.

---

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| `docs/infrastructure-guide.md` | 생성 | 아키텍처 다이어그램, 서비스 표, Traefik·Nginx 설정, 네트워크·볼륨 구성, 라우팅 규칙 |

---

## 완료 체크리스트

- [ ] `docs/infrastructure-guide.md` 파일이 존재하고 열람 가능하다
- [ ] 5개 서비스(traefik, nginx, fastapi, postgres, mysql)의 역할과 포트가 표로 정리되어 있다
- [ ] Traefik의 HTTP→HTTPS 리다이렉트 흐름이 기술되어 있다
- [ ] Cloudflare DNS Challenge 방식으로 Let's Encrypt 인증서를 발급한다는 내용이 포함되어 있다
- [ ] `hexsera.com` → nginx-server, `hexsera.com/api/*` → fastapi-server 라우팅 규칙이 명시되어 있다
- [ ] `web` 네트워크와 3개 볼륨(html-data-volume, postgres-data, mysql-data) 구성이 정리되어 있다
