# 업무일지

## 기본 정보
- 날짜: 2026-02-05 (수) 10:20~11:27 3:00~4:00
- 작성자: hexsera

## 진행 목표
MySQL에서 PostgreSQL로 데이터베이스 환경 마이그레이션 (MySQL 컨테이너 유지)

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| PostgreSQL 드라이버 추가 | backend/requirements.txt | psycopg2-binary==2.9.9 추가 |
| PostgreSQL Docker 서비스 추가 | docker-compose.yml | postgres 서비스, healthcheck, volume 추가 |
| DATABASE_URL 환경변수 추가 | backend/.env, backend/.env.example | PostgreSQL 연결 문자열 |
| 데이터베이스 설정 단순화 | backend/database.py | DATABASE_URL 환경변수로 변경 |
| Settings 클래스 단순화 | backend/app/core/config.py | DATABASE_URL 환경변수로 변경 |
| Alembic 설정 단순화 | backend/alembic/env.py | DATABASE_URL 환경변수로 변경 |
| FastAPI depends_on 변경 | docker-compose.yml | mysql → postgres |
| MySQL 마이그레이션 백업 | backend/alembic/versions/ → versions_mysql_backup/ | 기존 마이그레이션 보존 |
| PostgreSQL 초기 마이그레이션 | backend/alembic/versions/92671f4e4bf1_initial_postgresql_migration.py | autogenerate로 생성 |
| 마이그레이션 적용 | PostgreSQL hexdb | 6개 테이블 생성 |

## 주요 변경 사항

### 1. backend/requirements.txt 수정

**변경 후:**
```txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
pymysql==1.1.0
psycopg2-binary==2.9.9
cryptography
python-dotenv
alembic==1.13.1
```

**특징:**
- psycopg2-binary 추가 (PostgreSQL 드라이버)
- MySQL 드라이버(pymysql) 유지 (백업용)

### 2. docker-compose.yml 수정

**추가: PostgreSQL 서비스**
```yaml
postgres:
  image: postgres:16
  container_name: postgres-server
  restart: always
  environment:
    POSTGRES_DB: hexdb
    POSTGRES_USER: hexsera
    POSTGRES_PASSWORD: hexpoint
  ports:
    - "5432:5432"
  volumes:
    - postgres-data:/var/lib/postgresql/data
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U hexsera -d hexdb"]
    interval: 5s
    timeout: 5s
    retries: 10
  networks:
    - web
```

**수정: FastAPI depends_on**
```yaml
fastapi:
  depends_on:
    - postgres  # mysql → postgres로 변경
```

**추가: volumes 섹션**
```yaml
volumes:
  postgres-data:
```

**특징:**
- PostgreSQL 16 이미지 사용
- MySQL과 동일한 DB명, 사용자명, 비밀번호
- healthcheck로 연결 가능 상태 확인 (pg_isready)
- FastAPI가 PostgreSQL 시작 대기

### 3. backend/.env 수정

**변경 후:**
```env
# Database Configuration (PostgreSQL)
DATABASE_URL=postgresql+psycopg2://hexsera:hexpoint@postgres-server:5432/hexdb

# Database Configuration (MySQL - Backup)
MYSQL_HOST=mysql-server
MYSQL_PORT=3306
MYSQL_DATABASE=hexdb
MYSQL_USER=hexsera
MYSQL_PASSWORD=hexpoint

# API Key
API_KEY=hexsera-secret-api-key-2026

# Admin Account Seed Data
ADMIN_EMAIL=admin@hexsera.com
ADMIN_NICKNAME=admin
ADMIN_PASSWORD=admin_secure_password_2026
ADMIN_BIRTH_DATE=2000-01-01
```

**특징:**
- DATABASE_URL 환경변수 추가 (PostgreSQL 연결 문자열)
- 형식: `postgresql+psycopg2://사용자:비밀번호@호스트:포트/데이터베이스명`
- MySQL 설정은 백업용으로 유지

### 4. backend/database.py 수정

**변경 전:**
```python
DATABASE_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"
```

**변경 후:**
```python
DATABASE_URL = os.getenv("DATABASE_URL")
```

**특징:**
- f-string 조합 제거
- 단일 환경변수로 간소화
- .env 파일만 수정하면 DB 전환 가능

### 5. backend/app/core/config.py 수정

**변경 전:**
```python
class Settings:
    # Database
    DB_HOST: str = os.getenv("MYSQL_HOST")
    DB_PORT: int = int(os.getenv("MYSQL_PORT", 3306))
    DB_NAME: str = os.getenv("MYSQL_DATABASE")
    DB_USER: str = os.getenv("MYSQL_USER")
    DB_PASSWORD: str = os.getenv("MYSQL_PASSWORD")

    @property
    def database_url(self) -> str:
        return f"mysql+pymysql://{self.DB_USER}:{self.DB_PASSWORD}@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"
```

**변경 후:**
```python
class Settings:
    """애플리케이션 설정"""
    # Database
    DATABASE_URL: str = os.getenv("DATABASE_URL")

    # API Key
    API_KEY: str = os.getenv("API_KEY")

    # Admin Seeding
    ADMIN_EMAIL: str = os.getenv("ADMIN_EMAIL")
    ADMIN_NICKNAME: str = os.getenv("ADMIN_NICKNAME")
    ADMIN_PASSWORD: str = os.getenv("ADMIN_PASSWORD")
    ADMIN_BIRTH_DATE: str = os.getenv("ADMIN_BIRTH_DATE")
```

**특징:**
- 개별 DB_* 변수 제거
- @property 메서드 제거
- 코드가 간결해지고 DATABASE_URL만 관리

### 6. backend/alembic/env.py 수정

**변경 전:**
```python
MYSQL_USER = os.getenv("MYSQL_USER")
MYSQL_PASSWORD = os.getenv("MYSQL_PASSWORD")
MYSQL_HOST = os.getenv("MYSQL_HOST")
MYSQL_PORT = os.getenv("MYSQL_PORT")
MYSQL_DATABASE = os.getenv("MYSQL_DATABASE")

DATABASE_URL = f"mysql+pymysql://{MYSQL_USER}:{MYSQL_PASSWORD}@{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DATABASE}"
config.set_main_option('sqlalchemy.url', DATABASE_URL)
```

**변경 후:**
```python
DATABASE_URL = os.getenv("DATABASE_URL")
config.set_main_option('sqlalchemy.url', DATABASE_URL)
```

**특징:**
- 5개의 환경변수를 1개로 통합
- Alembic이 환경변수 DATABASE_URL 사용
- .env 파일만 수정하면 모든 파일에 자동 반영

### 7. backend/alembic/versions/92671f4e4bf1_initial_postgresql_migration.py 생성

**명령어:**
```bash
docker exec fastapi-server alembic revision --autogenerate -m "initial postgresql migration"
docker exec fastapi-server alembic upgrade head
```

**생성된 테이블:**
- users (id, email, nickname, password, birth_date, role)
- scores (id, user_id, score, created_at)
- friendships (id, user_id, friend_user_id, status, created_at)
- monthly_scores (id, user_id, year, month, score, updated_at)
- game_visits (id, user_id, visit_date, visit_count)
- alembic_version (version_num)

**특징:**
- autogenerate로 models.py 기반 자동 생성
- MySQL 마이그레이션은 versions_mysql_backup/에 백업
- PostgreSQL 전용 초기 마이그레이션

## 아키텍처 변경

### 마이그레이션 전 (MySQL)
```
┌─────────────────────────────────┐
│      FastAPI                    │
│  - depends_on: mysql            │
└────────────┬────────────────────┘
             │ DATABASE_URL (f-string 조합)
             ▼
┌─────────────────────────────────┐
│      MySQL 8.0                  │
│  - mysql-server:3306            │
│  - pymysql 드라이버             │
└─────────────────────────────────┘
```

### 마이그레이션 후 (PostgreSQL)
```
┌─────────────────────────────────┐
│      FastAPI                    │
│  - depends_on: postgres         │
└────────────┬────────────────────┘
             │ DATABASE_URL (환경변수)
             ▼
┌─────────────────────────────────┐
│      PostgreSQL 16              │
│  - postgres-server:5432         │
│  - psycopg2-binary 드라이버     │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│      MySQL 8.0 (백업)           │
│  - mysql-server:3306            │
│  - 컨테이너 유지                │
└─────────────────────────────────┘
```

## 발생한 문제 및 해결

### 1. ModuleNotFoundError: No module named 'psycopg2'

**원인:**
- requirements.txt에 psycopg2-binary 추가했지만 Docker 이미지 미재빌드
- Docker는 Dockerfile 기반으로 이미지를 캐싱
- requirements.txt 변경만으로는 자동 재설치 안됨

**해결:**
```bash
docker compose stop fastapi
docker compose rm -f fastapi
docker compose up -d --build fastapi
```

**특징:**
- `--build` 플래그로 이미지 강제 재빌드
- `RUN pip install -r requirements.txt` 단계에서 psycopg2-binary 설치됨

### 2. DATABASE_URL 코드 중복

**원인:**
- database.py, config.py, alembic/env.py에서 각각 f-string으로 조합
- 3개 파일에 동일한 로직 반복

**해결:**
- DATABASE_URL을 환경변수로 통합
- .env 파일에서 한 번만 정의
- 모든 파일에서 `os.getenv("DATABASE_URL")` 사용

**특징:**
- 코드 중복 제거 (DRY 원칙)
- .env 파일만 수정하면 모든 곳에 자동 반영
- 유지보수 편의성 향상


## 결과
- 상태: 완료


## 배운내용


## 다음 작업

## 기본 정보
- 날짜: 2026-02-05 (수) 16:00~17:10
- 작성자: hexsera

## 진행 목표
MySQL 데이터베이스의 모든 테이블 데이터를 PostgreSQL로 마이그레이션하여 운영 환경을 통일하고 기존 사용자 데이터를 보존

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| 실행계획 작성 | PRD/mysql-postgresql-데이터마이그레이션-실행계획.md | Model 기반 마이그레이션 방식으로 설계 |
| 마이그레이션 스크립트 생성 | backend/migrate_data.py | SQLAlchemy ORM 사용 |
| 데이터 마이그레이션 실행 | - | 447건 데이터 이동 완료 |
| PostgreSQL 시퀀스 초기화 | - | 5개 테이블 시퀀스 동기화 |
| 데이터 검증 | - | MySQL vs PostgreSQL 일치 확인 |
| FastAPI 테스트 | - | PostgreSQL 연결 정상 작동 확인 |


## 주요 변경 사항

### 1. PRD/mysql-postgresql-데이터마이그레이션-실행계획.md 생성

**추가:**
```markdown
# MySQL → PostgreSQL 데이터 마이그레이션 실행계획

## 구현 방법

**마이그레이션 전략**:
1. **SQLAlchemy ORM 방식**: models.py의 Model 클래스를 사용하여 MySQL → PostgreSQL 데이터 복사
2. **장점**: 타입 자동 변환, 컬럼 정보 자동 추출, 테이블 구조 변경 시 스크립트 수정 불필요
3. **단계**: 양쪽 DB 세션 생성 → Model 기반 데이터 조회 → 데이터 복사 → 검증
```

**특징:**
- Model 기반 방식 채택 (컬럼 자동 추출, 유지보수 용이)
- 딕셔너리 변환 방식으로 세션 간 데이터 전달 (DetachedInstanceError 방지)
- 시퀀스 초기화 단계 포함 (AUTO_INCREMENT 동기화)
- 5단계 구현 절차 (스크립트 생성 → 실행 → 시퀀스 초기화 → alembic 동기화 → MySQL 중단)

### 2. backend/migrate_data.py 생성

**추가:**
```python
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv
from models import User, Score, Friendship, MonthlyScore, GameVisit

load_dotenv()

# MySQL 연결
MYSQL_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"
mysql_engine = create_engine(MYSQL_URL)
MySQLSession = sessionmaker(bind=mysql_engine)

# PostgreSQL 연결
POSTGRES_URL = os.getenv("DATABASE_URL")
postgres_engine = create_engine(POSTGRES_URL)
PostgresSession = sessionmaker(bind=postgres_engine)

def migrate_model(model_class):
    """Model 기반으로 데이터를 MySQL에서 PostgreSQL로 복사"""
    table_name = model_class.__tablename__
    print(f"\n[{table_name}] 마이그레이션 시작...")

    # MySQL에서 데이터 읽기
    mysql_session = MySQLSession()
    try:
        rows = mysql_session.query(model_class).all()
        print(f"  - MySQL에서 {len(rows)}건 읽기 완료")

        if len(rows) == 0:
            print(f"  - {table_name} 테이블에 데이터가 없습니다.")
            return

        # 객체를 딕셔너리로 변환 (새 세션에서 사용하기 위해)
        row_dicts = []
        for row in rows:
            row_dict = {col.name: getattr(row, col.name) for col in model_class.__table__.columns}
            row_dicts.append(row_dict)
    finally:
        mysql_session.close()

    # PostgreSQL에 데이터 삽입
    postgres_session = PostgresSession()
    try:
        # 기존 데이터 삭제
        postgres_session.query(model_class).delete()
        print(f"  - PostgreSQL 기존 데이터 삭제 완료")

        # 새 데이터 삽입
        for row_dict in row_dicts:
            new_obj = model_class(**row_dict)
            postgres_session.add(new_obj)

        postgres_session.commit()
        print(f"  - PostgreSQL에 {len(row_dicts)}건 삽입 완료")
    except Exception as e:
        postgres_session.rollback()
        raise e
    finally:
        postgres_session.close()

def main():
    print("=== MySQL → PostgreSQL 데이터 마이그레이션 시작 ===")

    # 마이그레이션할 Model 목록
    models_to_migrate = [
        User,
        Score,
        Friendship,
        MonthlyScore,
        GameVisit,
    ]

    # 각 Model 마이그레이션 실행
    for model in models_to_migrate:
        try:
            migrate_model(model)
        except Exception as e:
            print(f"  - 오류 발생: {e}")

    print("\n=== 마이그레이션 완료 ===")

if __name__ == "__main__":
    main()
```

**특징:**
- SQLAlchemy ORM 기반 마이그레이션 (models.py의 User, Score 등 사용)
- 컬럼 정보 자동 추출: `model_class.__table__.columns`
- 객체 → 딕셔너리 변환으로 세션 분리 (DetachedInstanceError 방지)
- 트랜잭션 단위 커밋, 오류 시 자동 롤백
- 각 테이블별 진행 상황 로깅

## 마이그레이션 아키텍처

```
┌─────────────────────────────────┐
│      MySQL Database             │
│  - users (31건)                 │
│  - scores (4건)                 │
│  - friendships (6건)            │
│  - monthly_scores (31건)        │
│  - game_visits (375건)          │
└────────────┬────────────────────┘
             │
             │ migrate_data.py
             │ (SQLAlchemy ORM)
             │
             ▼
┌─────────────────────────────────┐
│   1. MySQL 세션에서 데이터 조회  │
│      mysql_session.query()      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   2. 객체 → 딕셔너리 변환        │
│      (세션 독립적 데이터)        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   3. PostgreSQL 세션에 삽입      │
│      postgres_session.add()     │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│    PostgreSQL Database          │
│  - users (31건)                 │
│  - scores (4건)                 │
│  - friendships (6건)            │
│  - monthly_scores (31건)        │
│  - game_visits (375건)          │
└─────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   4. 시퀀스 초기화               │
│      setval('table_id_seq')     │
└─────────────────────────────────┘
```

## 마이그레이션 실행 결과

### 데이터 이동 현황
| 테이블 | MySQL | PostgreSQL | 상태 |
|--------|-------|------------|------|
| users | 31건 | 31건 | ✅ 완료 |
| scores | 4건 | 4건 | ✅ 완료 |
| friendships | 6건 | 6건 | ✅ 완료 |
| monthly_scores | 31건 | 31건 | ✅ 완료 |
| game_visits | 375건 | 375건 | ✅ 완료 |
| **총계** | **447건** | **447건** | ✅ 완료 |

### 시퀀스 초기화 결과
| 테이블 | 시퀀스명 | 현재값 |
|--------|---------|--------|
| users | users_id_seq | 33 |
| scores | scores_id_seq | 4 |
| friendships | friendships_id_seq | 10 |
| monthly_scores | monthly_scores_id_seq | 45 |
| game_visits | game_visits_id_seq | 763 |



## 결과
- 상태: 완료


## 배운내용


## 다음 작업
- api 확인