# 배포 가이드 작성 실행계획

## 요구사항 요약

**요구사항**: `docs/deployment-guide.md` 파일을 새로 생성한다.

**목적**: 처음 배포하는 사람도 이 문서만 보고 서버 세팅부터 서비스 운영까지 진행할 수 있도록 인프라 설정 절차를 기록한다.

---

## 현재상태 분석

- `docs/` 디렉토리에 배포 관련 문서가 없다.
- `docker-compose.yml`에 traefik, nginx, fastapi, postgres, mysql 5개 서비스가 정의되어 있다.
- `traefik.yml`에 HTTP→HTTPS 리다이렉트, Cloudflare DNS Challenge 설정이 존재한다.
- `backend/.env.example`에 환경 변수 항목이 정의되어 있다.
- `backend/Dockerfile`은 `python:3.11-slim` 기반이고 uvicorn으로 실행된다.
- Alembic 마이그레이션 구성(`alembic.ini`)이 백엔드에 존재한다.

---

## 구현 방법

현재 코드베이스(`docker-compose.yml`, `traefik.yml`, `backend/.env.example`, `Dockerfile`)를 분석하여 실제 설정 값 기준으로 문서를 작성한다. 코드 자동 생성 없이 마크다운 형식으로 직접 작성한다.

---

## 구현 단계

### 1. 사전 요구사항 섹션 작성

```markdown
## 사전 요구사항

- 서버 OS: Ubuntu 20.04 이상
- Docker Engine 24.x 이상, Docker Compose v2 이상 설치
- 도메인 DNS가 Cloudflare에서 관리되고 있어야 한다
- 서버의 80, 443, 5432 포트가 열려 있어야 한다
- Cloudflare API Token: Zone:DNS:Edit 권한으로 발급
```

- 서버 환경과 네트워크 조건을 명시하여 사전에 준비해야 할 항목을 체크할 수 있게 한다.
- Cloudflare API Token 발급 권한(Zone:DNS:Edit)을 명시하지 않으면 DNS Challenge가 실패한다.

### 2. 환경 변수 설정 섹션 작성

```markdown
## 환경 변수 설정

### backend/.env

backend/.env.example을 복사하여 backend/.env를 생성한다.

cp backend/.env.example backend/.env

| 변수명 | 예시 값 | 설명 |
|--------|---------|------|
| DATABASE_URL | postgresql+psycopg2://hexsera:hexpoint@postgres-server:5432/hexdb | PostgreSQL 연결 문자열 |
| ADMIN_EMAIL | admin@example.com | 초기 관리자 계정 이메일 |
| ADMIN_PASSWORD | yourpassword | 초기 관리자 계정 비밀번호 |

### docker-compose.yml

CF_DNS_API_TOKEN을 Cloudflare에서 발급한 토큰으로 교체한다.
```

- `.env.example` 파일 기준으로 변수명과 설명을 표로 정리해 빠르게 참조할 수 있게 한다.
- `DATABASE_URL`에서 `@postgres-server`는 Docker 내부 컨테이너명으로, 외부 IP가 아닌 것을 명시한다.

### 3. 초기 배포 절차 섹션 작성

```markdown
## 초기 배포 절차

# 1. 저장소 클론
git clone <repo-url> && cd Pinball_web

# 2. 환경 변수 파일 생성
cp backend/.env.example backend/.env
# backend/.env 파일을 실제 값으로 수정

# 3. acme.json 파일 생성 (Traefik 인증서 저장용)
touch acme.json && chmod 600 acme.json

# 4. 프론트엔드 빌드
source ~/.nvm/nvm.sh && cd frontend && npm install && npm run build

# 5. 빌드 결과물 nginx 볼륨에 복사
docker compose cp frontend/dist/. nginx-server:/etc/nginx/html/

# 6. 전체 서비스 시작
docker compose up -d
```

- `acme.json`은 반드시 `chmod 600`으로 권한을 설정해야 Traefik이 인증서를 저장할 수 있다.
- 프론트엔드 빌드 결과물(dist/)을 nginx 볼륨에 복사하는 단계가 빠지면 빈 페이지가 표시된다.

### 4. DB 마이그레이션 섹션 작성

```markdown
## DB 마이그레이션

# 최초 배포 시 또는 스키마 변경 후 실행
docker compose exec fastapi alembic upgrade head

# 새 마이그레이션 파일 생성 (모델 변경 후)
docker compose exec fastapi alembic revision --autogenerate -m "변경 내용 설명"

# 현재 마이그레이션 상태 확인
docker compose exec fastapi alembic current
```

- 서비스 시작 후 반드시 `alembic upgrade head`를 실행해야 테이블이 생성된다.
- `--autogenerate`는 SQLAlchemy 모델 변경사항을 감지해 마이그레이션 파일을 자동 생성한다.

### 5. 롤백 방법 섹션 작성

```markdown
## 롤백 방법

### DB 마이그레이션 롤백
# 한 단계 이전으로 롤백
docker compose exec fastapi alembic downgrade -1

# 특정 버전으로 롤백 (alembic history로 revision ID 확인)
docker compose exec fastapi alembic history
docker compose exec fastapi alembic downgrade <revision_id>

### 서비스 롤백
# 이전 이미지로 되돌리기
docker compose down
git checkout <이전 커밋>
docker compose build fastapi
docker compose up -d
```

- 마이그레이션 롤백은 DB 데이터 손실 위험이 있으므로 실행 전 DB 백업을 권장한다.
- `alembic downgrade base`는 모든 마이그레이션을 되돌리므로 사용에 주의한다.

### 6. 트러블슈팅 섹션 작성

```markdown
## 트러블슈팅

### 인증서 발급 실패
- 원인: CF_DNS_API_TOKEN 권한 부족 또는 acme.json 권한 오류
- 해결: `chmod 600 acme.json` 확인, Cloudflare 토큰 Zone:DNS:Edit 권한 재확인

### FastAPI 컨테이너 시작 실패
- 원인: backend/.env 파일 누락 또는 DATABASE_URL 오류
- 해결: `docker compose logs fastapi`로 로그 확인 후 .env 값 수정

### 프론트엔드 404 오류
- 원인: nginx 볼륨에 dist/ 파일이 없는 경우
- 해결: npm run build 후 `docker compose cp frontend/dist/. nginx-server:/etc/nginx/html/` 재실행
```

- 각 트러블슈팅 항목에 원인과 해결 명령어를 함께 기록해 빠르게 대응할 수 있게 한다.

---

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| `docs/deployment-guide.md` | 생성 | 사전 요구사항, 환경 변수 설정, 초기 배포 절차, DB 마이그레이션, 롤백, 트러블슈팅 |

---

## 완료 체크리스트

- [ ] `docs/deployment-guide.md` 파일이 존재한다
- [ ] 사전 요구사항에 Cloudflare API Token 발급 방법(Zone:DNS:Edit 권한)이 명시되어 있다
- [ ] `backend/.env` 생성 절차와 각 변수 설명이 표 형태로 정리되어 있다
- [ ] `acme.json` 생성 및 `chmod 600` 명령이 초기 배포 절차에 포함되어 있다
- [ ] `alembic upgrade head` 명령이 마이그레이션 섹션에 포함되어 있다
- [ ] DB 롤백 명령(`alembic downgrade -1`)이 롤백 섹션에 포함되어 있다
- [ ] 트러블슈팅에 인증서 발급 실패, FastAPI 시작 실패, 프론트엔드 404 항목이 포함되어 있다
