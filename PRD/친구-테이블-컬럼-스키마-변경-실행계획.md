# 친구 테이블 컬럼 스키마 변경 실행계획

## 요구사항 요약

**요구사항**: Friendship 모델의 `addressee_id` 컬럼 이름을 `receiver_id`로 변경

**목적**: DB에서 친구 신청을 보내는 사람(requester_id)과 받는 사람(addressee_id)을 명확히 구분하기 위함. `addressee`보다 `receiver`가 더 직관적이고 이해하기 쉬운 용어임.

## 현재상태 분석

- `fastapi/models.py`의 Friendship 클래스에 `addressee_id` 컬럼이 정의되어 있음
- `fastapi/main.py`에서 `addressee_id`를 사용하는 코드가 5곳 존재:
  - FriendRequestRequest 스키마 (line 120)
  - FriendRequestResponse 스키마 (line 127)
  - POST /api/friend-requests 엔드포인트 (line 344, 353, 359, 363)
- 기존 Alembic 마이그레이션 파일 2개 존재 (641e66bada47_.py, b293026a2667_.py)

## 구현 방법

**기술**: Alembic 마이그레이션을 사용하여 DB 스키마 변경
- SQLAlchemy 모델을 먼저 수정
- Alembic autogenerate로 마이그레이션 파일 자동 생성
- 마이그레이션 적용으로 실제 DB 컬럼 이름 변경
- FastAPI 코드의 모든 `addressee_id` 참조를 `receiver_id`로 변경

## 구현 단계

### 1. SQLAlchemy 모델 수정
- `fastapi/models.py`의 Friendship 클래스 수정
- `addressee_id` → `receiver_id`로 변경

```python
class Friendship(Base):
    __tablename__ = "friendships"

    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(Integer, nullable=False, index=True)
    receiver_id = Column(Integer, nullable=False, index=True)  # 변경됨
    status = Column(String(20), nullable=False, default='pending')
    created_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

### 2. Pydantic 스키마 수정
- `fastapi/main.py`의 FriendRequestRequest 스키마 수정
- `fastapi/main.py`의 FriendRequestResponse 스키마 수정

```python
class FriendRequestRequest(BaseModel):
    """친구 추가 요청 스키마"""
    receiver_id: int    # 친구 요청을 받는 사람 (변경됨)
    requester_id: int    # 친구 요청을 보내는 사람

class FriendRequestResponse(BaseModel):
    """친구 추가 응답 스키마"""
    message: str
    receiver_id: int  # 변경됨
    requester_id: int
```

### 3. API 엔드포인트 로직 수정
- `fastapi/main.py`의 POST /api/friend-requests 엔드포인트 수정
- 모든 `addressee_id` 참조를 `receiver_id`로 변경

```python
@app.post("/api/friend-requests", response_model=FriendRequestResponse)
def create_friend_request(request: FriendRequestRequest, db: Session = Depends(get_db)):
    # 1. DB에 Friendship 레코드 생성
    db_friendship = Friendship(
        requester_id=request.requester_id,
        receiver_id=request.receiver_id,  # 변경됨
        status="pending"
    )
    db.add(db_friendship)
    db.commit()
    db.refresh(db_friendship)

    # 2. 메모리에도 저장 (다른 엔드포인트 호환성 유지)
    friend_request_data = {
        "id": request.receiver_id,  # 변경됨
        "requester_id": request.requester_id,
        "status": "pending"
    }
    friend_requests.append(friend_request_data)

    print(f"친구 요청 저장됨 (DB+메모리): {request.requester_id} -> {request.receiver_id}")  # 변경됨

    return FriendRequestResponse(
        message="Friend request received",
        receiver_id=db_friendship.receiver_id,  # 변경됨
        requester_id=db_friendship.requester_id
    )
```

### 4. Alembic 마이그레이션 파일 생성
- Docker 컨테이너 내에서 Alembic autogenerate 실행
- 컬럼 이름 변경이 감지되어 마이그레이션 파일 자동 생성됨

```bash
docker exec fastapi-server alembic revision --autogenerate -m "rename addressee_id to receiver_id in friendships table"
```

### 5. 마이그레이션 적용
- 생성된 마이그레이션 파일을 실제 DB에 적용

```bash
docker exec fastapi-server alembic upgrade head
```

### 6. 동작 확인
- FastAPI 컨테이너 재시작
- POST /api/friend-requests 엔드포인트 테스트
- DB에서 friendships 테이블 스키마 확인

```bash
# FastAPI 재시작
docker compose restart fastapi

# DB 스키마 확인
docker exec mysql-server mysql -u hexsera -phexpoint hexdb -e "DESCRIBE friendships;"
```

## 수정/생성할 파일 목록

| 파일 경로 | 작업 유형 | 변경 내용 |
|-----------|-----------|-----------|
| fastapi/models.py | 수정 | Friendship 클래스의 addressee_id → receiver_id |
| fastapi/main.py | 수정 | FriendRequestRequest, FriendRequestResponse 스키마 수정 및 POST /api/friend-requests 엔드포인트 로직 수정 (총 5곳) |
| fastapi/alembic/versions/[새파일].py | 생성 | Alembic autogenerate로 자동 생성되는 마이그레이션 파일 |

## 완료 체크리스트


- [o] DB의 friendships 테이블에서 addressee_id 컬럼이 receiver_id로 변경됨 (DESCRIBE friendships 확인)
- [o] POST /api/friend-requests 엔드포인트가 정상 동작함 (curl 테스트)
- [o] API 응답에서 receiver_id 필드가 올바르게 반환됨
