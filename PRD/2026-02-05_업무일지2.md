# 업무일지

## 기본 정보
- 날짜: 2026-02-05 (수)
- 작성자: hexsera

## 진행 목표
MySQL 데이터베이스의 모든 테이블 데이터를 PostgreSQL로 마이그레이션하여 운영 환경을 통일하고 기존 사용자 데이터를 보존

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| 실행계획 작성 | PRD/mysql-postgresql-데이터마이그레이션-실행계획.md | Model 기반 마이그레이션 방식으로 설계 |
| 마이그레이션 스크립트 생성 | backend/migrate_data.py | SQLAlchemy ORM 사용 |
| 데이터 마이그레이션 실행 | - | 447건 데이터 이동 완료 |
| PostgreSQL 시퀀스 초기화 | - | 5개 테이블 시퀀스 동기화 |
| alembic_version 동기화 | - | 버전 e9059978e80e로 동기화 |
| 데이터 검증 | - | MySQL vs PostgreSQL 일치 확인 |
| FastAPI 테스트 | - | PostgreSQL 연결 정상 작동 확인 |

**총 1시간 30분**

## 주요 변경 사항

### 1. PRD/mysql-postgresql-데이터마이그레이션-실행계획.md 생성

**추가:**
```markdown
# MySQL → PostgreSQL 데이터 마이그레이션 실행계획

## 구현 방법

**마이그레이션 전략**:
1. **SQLAlchemy ORM 방식**: models.py의 Model 클래스를 사용하여 MySQL → PostgreSQL 데이터 복사
2. **장점**: 타입 자동 변환, 컬럼 정보 자동 추출, 테이블 구조 변경 시 스크립트 수정 불필요
3. **단계**: 양쪽 DB 세션 생성 → Model 기반 데이터 조회 → 데이터 복사 → 검증
```

**특징:**
- Model 기반 방식 채택 (컬럼 자동 추출, 유지보수 용이)
- 딕셔너리 변환 방식으로 세션 간 데이터 전달 (DetachedInstanceError 방지)
- 시퀀스 초기화 단계 포함 (AUTO_INCREMENT 동기화)
- 5단계 구현 절차 (스크립트 생성 → 실행 → 시퀀스 초기화 → alembic 동기화 → MySQL 중단)

### 2. backend/migrate_data.py 생성

**추가:**
```python
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv
from models import User, Score, Friendship, MonthlyScore, GameVisit

load_dotenv()

# MySQL 연결
MYSQL_URL = f"mysql+pymysql://{os.getenv('MYSQL_USER')}:{os.getenv('MYSQL_PASSWORD')}@{os.getenv('MYSQL_HOST')}:{os.getenv('MYSQL_PORT')}/{os.getenv('MYSQL_DATABASE')}"
mysql_engine = create_engine(MYSQL_URL)
MySQLSession = sessionmaker(bind=mysql_engine)

# PostgreSQL 연결
POSTGRES_URL = os.getenv("DATABASE_URL")
postgres_engine = create_engine(POSTGRES_URL)
PostgresSession = sessionmaker(bind=postgres_engine)

def migrate_model(model_class):
    """Model 기반으로 데이터를 MySQL에서 PostgreSQL로 복사"""
    table_name = model_class.__tablename__
    print(f"\n[{table_name}] 마이그레이션 시작...")

    # MySQL에서 데이터 읽기
    mysql_session = MySQLSession()
    try:
        rows = mysql_session.query(model_class).all()
        print(f"  - MySQL에서 {len(rows)}건 읽기 완료")

        if len(rows) == 0:
            print(f"  - {table_name} 테이블에 데이터가 없습니다.")
            return

        # 객체를 딕셔너리로 변환 (새 세션에서 사용하기 위해)
        row_dicts = []
        for row in rows:
            row_dict = {col.name: getattr(row, col.name) for col in model_class.__table__.columns}
            row_dicts.append(row_dict)
    finally:
        mysql_session.close()

    # PostgreSQL에 데이터 삽입
    postgres_session = PostgresSession()
    try:
        # 기존 데이터 삭제
        postgres_session.query(model_class).delete()
        print(f"  - PostgreSQL 기존 데이터 삭제 완료")

        # 새 데이터 삽입
        for row_dict in row_dicts:
            new_obj = model_class(**row_dict)
            postgres_session.add(new_obj)

        postgres_session.commit()
        print(f"  - PostgreSQL에 {len(row_dicts)}건 삽입 완료")
    except Exception as e:
        postgres_session.rollback()
        raise e
    finally:
        postgres_session.close()

def main():
    print("=== MySQL → PostgreSQL 데이터 마이그레이션 시작 ===")

    # 마이그레이션할 Model 목록
    models_to_migrate = [
        User,
        Score,
        Friendship,
        MonthlyScore,
        GameVisit,
    ]

    # 각 Model 마이그레이션 실행
    for model in models_to_migrate:
        try:
            migrate_model(model)
        except Exception as e:
            print(f"  - 오류 발생: {e}")

    print("\n=== 마이그레이션 완료 ===")

if __name__ == "__main__":
    main()
```

**특징:**
- SQLAlchemy ORM 기반 마이그레이션 (models.py의 User, Score 등 사용)
- 컬럼 정보 자동 추출: `model_class.__table__.columns`
- 객체 → 딕셔너리 변환으로 세션 분리 (DetachedInstanceError 방지)
- 트랜잭션 단위 커밋, 오류 시 자동 롤백
- 각 테이블별 진행 상황 로깅

## 마이그레이션 아키텍처

```
┌─────────────────────────────────┐
│      MySQL Database             │
│  - users (31건)                 │
│  - scores (4건)                 │
│  - friendships (6건)            │
│  - monthly_scores (31건)        │
│  - game_visits (375건)          │
└────────────┬────────────────────┘
             │
             │ migrate_data.py
             │ (SQLAlchemy ORM)
             │
             ▼
┌─────────────────────────────────┐
│   1. MySQL 세션에서 데이터 조회  │
│      mysql_session.query()      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   2. 객체 → 딕셔너리 변환        │
│      (세션 독립적 데이터)        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   3. PostgreSQL 세션에 삽입      │
│      postgres_session.add()     │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│    PostgreSQL Database          │
│  - users (31건)                 │
│  - scores (4건)                 │
│  - friendships (6건)            │
│  - monthly_scores (31건)        │
│  - game_visits (375건)          │
└─────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   4. 시퀀스 초기화               │
│      setval('table_id_seq')     │
└─────────────────────────────────┘
```

## 마이그레이션 실행 결과

### 데이터 이동 현황
| 테이블 | MySQL | PostgreSQL | 상태 |
|--------|-------|------------|------|
| users | 31건 | 31건 | ✅ 완료 |
| scores | 4건 | 4건 | ✅ 완료 |
| friendships | 6건 | 6건 | ✅ 완료 |
| monthly_scores | 31건 | 31건 | ✅ 완료 |
| game_visits | 375건 | 375건 | ✅ 완료 |
| **총계** | **447건** | **447건** | ✅ 완료 |

### 시퀀스 초기화 결과
| 테이블 | 시퀀스명 | 현재값 |
|--------|---------|--------|
| users | users_id_seq | 33 |
| scores | scores_id_seq | 4 |
| friendships | friendships_id_seq | 10 |
| monthly_scores | monthly_scores_id_seq | 45 |
| game_visits | game_visits_id_seq | 763 |

### alembic_version 동기화
- MySQL 버전: e9059978e80e
- PostgreSQL 버전: e9059978e80e (동기화 완료)

### FastAPI 연결 테스트
```bash
# API 헬스 체크
$ curl http://localhost:8000/api/test
{"status":"ok","message":"API test endpoint"}

# Users API 조회 (PostgreSQL 데이터)
$ curl -H "X-API-Key: hexsera-secret-api-key-2026" http://localhost:8000/api/v1/users
[
  {"id": 1, "email": "admin@hexsera.com", "nickname": "admin", "role": "admin"},
  {"id": 2, "email": "test@test.com", "nickname": "oname", "role": "user"},
  ...
]
```

## 결과
- 상태: 완료
- MySQL → PostgreSQL 데이터 마이그레이션 성공 (447건)
- FastAPI 애플리케이션 PostgreSQL 연결 정상 작동
- 시퀀스 초기화 완료 (새 데이터 삽입 준비 완료)

## 배운내용


## 다음 작업
- MySQL 컨테이너 중지 (선택 사항, 데이터는 볼륨에 보존)
- docker-compose.yml에서 mysql 서비스 주석 처리 (선택 사항)
- PostgreSQL 백업 정책 수립
- 프로덕션 환경에서 최종 검증
