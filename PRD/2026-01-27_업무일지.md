# 업무일지

## 기본 정보
- 날짜: 2026-01-27 (월) 10:57~12:00
- 작성자: hexsera

## 진행 목표
friendships 테이블을 생성하여 사용자 간 친구 관계를 영구적으로 저장하고 관리할 수 있는 데이터베이스 구조를 구축한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
|PRD작성| 2분 | |
|PLAN작성| 8분 | |
|실행| 10분 | fastapi/models.py |
|학습 | 30분 | |

### fastapi/models.py (수정)

```python
class Friendship(Base):
    __tablename__ = "friendships"

    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(Integer, nullable=False, index=True)
    addressee_id = Column(Integer, nullable=False, index=True)
    status = Column(String(20), nullable=False, default='pending')
    created_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

## 결과
- 상태: 완료


## 기본 정보
- 날짜: 2026-01-27 (월) 10:57~12:00
- 작성자: hexsera

## 진행 목표
friendships 테이블을 생성하여 사용자 간 친구 관계를 영구적으로 저장하고 관리할 수 있는 데이터베이스 구조를 구축한다.


## 진행 내용
| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
|PRD작성| 7분 | |
|PLAN작성| 7분 | |
|실행| 3분 | fastapi/models.py |
|학습 | 2분 | |

### 1. fastapi/models.py 수정

**변경 후 (추가된 코드):**
```python
class Visit(Base):
    __tablename__ = "visits"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, nullable=True, index=True)
    visited_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

## 결과
- 상태: 완료


---

## 기본 정보
- 날짜: 2026-01-27 (월) 13:54~14:50
- 작성자: hexsera

## 진행 목표
POST /api/friend-requests 엔드포인트를 friendships 테이블과 연결하여 친구 요청 데이터를 DB에 영구 저장한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
| 실행계획 작성 | 15분 | PRD/친구신청-DB연결-실행계획.md |
| 실행 | 5분 | fastapi/main.py |

### 1. fastapi/main.py 수정

**Friendship 모델 import 추가 (7번 줄)**:
```python
from models import User, Score, Friendship
```

**FriendRequestRequest 스키마 수정 (118-121번 줄)**:
```python
class FriendRequestRequest(BaseModel):
    addressee_id: int    # 친구 요청을 받는 사람
    requester_id: int    # 친구 요청을 보내는 사람
```

**FriendRequestResponse 스키마 수정 (124-128번 줄)**:
```python
class FriendRequestResponse(BaseModel):
    message: str
    addressee_id: int
    requester_id: int
```

**db 연결**
```python
@app.post("/api/friend-requests", response_model=FriendRequestResponse)
def create_friend_request(request: FriendRequestRequest, db: Session = Depends(get_db)):
    """친구 추가 요청을 받는 엔드포인트 (DB와 메모리에 저장)"""

    # 1. DB에 Friendship 레코드 생성
    db_friendship = Friendship(
        requester_id=request.requester_id,
        addressee_id=request.addressee_id,
        status="pending"
    )
    db.add(db_friendship)
    db.commit()
    db.refresh(db_friendship)

    # 2. 메모리에도 저장 (다른 엔드포인트 호환성 유지)
    friend_request_data = {
        "id": request.addressee_id,
        "requester_id": request.requester_id,
        "status": "pending"
    }
    friend_requests.append(friend_request_data)

    print(f"친구 요청 저장됨 (DB+메모리): {request.requester_id} -> {request.addressee_id}")

    return FriendRequestResponse(
        message="Friend request received",
        addressee_id=db_friendship.addressee_id,
        requester_id=db_friendship.requester_id
    )
```

## 결과
- 상태: 완료



## 다음 작업
- GET /api/friend-requests 엔드포인트 DB 연동
- POST /api/friend-requests/accept 엔드포인트 DB 연동
- POST /api/friend-requests/reject 엔드포인트 DB 연동
- 메모리 리스트 제거 (모든 엔드포인트 DB 연동 완료 후)

## 다음 작업
- friendships 테이블 생성 확인 (`SHOW TABLES;`)
- 테이블 구조 확인 (`DESCRIBE friendships;`)
- 인덱스 확인 (`SHOW INDEX FROM friendships;`)
- 친구 요청 CRUD API 구현 (POST, GET, PUT, DELETE)
- 친구 목록 조회 API 구현

## 다음 작업
- visits 테이블 생성 확인 (MySQL CLI)
- 방문 기록 저장 API 엔드포인트 구현 (POST /api/v1/visits)
- 기간별 방문 통계 조회 API 구현 (GET /api/v1/visits/stats)
