# 업무일지

## 기본 정보
- 날짜: 2026-01-27 (월) 10:57~12:00
- 작성자: hexsera

## 진행 목표
friendships 테이블을 생성하여 사용자 간 친구 관계를 영구적으로 저장하고 관리할 수 있는 데이터베이스 구조를 구축한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
|PRD작성| 2분 | |
|PLAN작성| 8분 | |
|실행| 10분 | fastapi/models.py |
|학습 | 30분 | |

### fastapi/models.py (수정)

```python
class Friendship(Base):
    __tablename__ = "friendships"

    id = Column(Integer, primary_key=True, index=True)
    requester_id = Column(Integer, nullable=False, index=True)
    addressee_id = Column(Integer, nullable=False, index=True)
    status = Column(String(20), nullable=False, default='pending')
    created_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

## 결과
- 상태: 완료


## 기본 정보
- 날짜: 2026-01-27 (월) 10:57~12:00
- 작성자: hexsera

## 진행 목표
friendships 테이블을 생성하여 사용자 간 친구 관계를 영구적으로 저장하고 관리할 수 있는 데이터베이스 구조를 구축한다.


## 진행 내용
| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
|PRD작성| 7분 | |
|PLAN작성| 7분 | |
|실행| 3분 | fastapi/models.py |
|학습 | 2분 | |

### 1. fastapi/models.py 수정

**변경 후 (추가된 코드):**
```python
class Visit(Base):
    __tablename__ = "visits"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, nullable=True, index=True)
    visited_at = Column(DateTime, nullable=False, server_default=func.now(), index=True)
```

## 결과
- 상태: 완료


---

## 기본 정보
- 날짜: 2026-01-27 (월) 13:54~14:50
- 작성자: hexsera

## 진행 목표
POST /api/friend-requests 엔드포인트를 friendships 테이블과 연결하여 친구 요청 데이터를 DB에 영구 저장한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
| "/api/friend-requests" db 연결 | 1시간 |  |


### 1. fastapi/main.py 수정

**Friendship 모델 import 추가 (7번 줄)**:
```python
from models import User, Score, Friendship
```

**FriendRequestRequest 스키마 수정 (118-121번 줄)**:
```python
class FriendRequestRequest(BaseModel):
    addressee_id: int    # 친구 요청을 받는 사람
    requester_id: int    # 친구 요청을 보내는 사람
```

**FriendRequestResponse 스키마 수정 (124-128번 줄)**:
```python
class FriendRequestResponse(BaseModel):
    message: str
    addressee_id: int
    requester_id: int
```

**db 연결**
```python
@app.post("/api/friend-requests", response_model=FriendRequestResponse)
def create_friend_request(request: FriendRequestRequest, db: Session = Depends(get_db)):
    """친구 추가 요청을 받는 엔드포인트 (DB와 메모리에 저장)"""

    # 1. DB에 Friendship 레코드 생성
    db_friendship = Friendship(
        requester_id=request.requester_id,
        addressee_id=request.addressee_id,
        status="pending"
    )
    db.add(db_friendship)
    db.commit()
    db.refresh(db_friendship)

    # 2. 메모리에도 저장 (다른 엔드포인트 호환성 유지)
    friend_request_data = {
        "id": request.addressee_id,
        "requester_id": request.requester_id,
        "status": "pending"
    }
    friend_requests.append(friend_request_data)

    print(f"친구 요청 저장됨 (DB+메모리): {request.requester_id} -> {request.addressee_id}")

    return FriendRequestResponse(
        message="Friend request received",
        addressee_id=db_friendship.addressee_id,
        requester_id=db_friendship.requester_id
    )
```

## 결과
- 상태: 완료


---

## 기본 정보
- 날짜: 2026-01-27 (월) 3:08~3:40
- 작성자: hexsera

## 진행 목표
POST /api/friend-requests/accept 및 /reject 엔드포인트를 DB와 연결하여 친구 요청의 승인/거절 상태를 영구 저장한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
| /api/friend-requests/accept DB 연결 | |  fastapi/main.py |
| /api/friend-requests/reject | | fastapi/main.py |

### 1. fastapi/main.py 수정

**POST /api/friend-requests/accept 수정**:
```python
@app.post("/api/friend-requests/accept", response_model=FriendRequestActionResponse)
def accept_friend_request(action: FriendRequestActionRequest, db: Session = Depends(get_db)):
    """친구 요청 승인 (DB 연동)"""
    # DB에서 Friendship 레코드 조회
    friendship = db.query(Friendship).filter(
        Friendship.id == action.id,
        Friendship.requester_id == action.requester_id
    ).first()

    if not friendship:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Friend request not found"
        )

    # status 업데이트
    friendship.status = "accepted"
    db.commit()
    db.refresh(friendship)

    # 메모리 배열도 업데이트 (하위 호환성)
    for req in friend_requests:
        if req["id"] == action.id and req["requester_id"] == action.requester_id:
            req["status"] = "accepted"

    print(f"친구 요청 승인됨 (DB): {action.id} -> {action.requester_id}")
    return FriendRequestActionResponse(
        message="Friend request accepted",
        id=friendship.id,
        requester_id=friendship.requester_id,
        status=friendship.status
    )
```


**POST /api/friend-requests/reject 수정**:
- accept와 동일한 패턴으로 구현
- status를 "rejected"로 설정

```python
@app.post("/api/friend-requests/reject", response_model=FriendRequestActionResponse)
def reject_friend_request(action: FriendRequestActionRequest, db: Session = Depends(get_db)):
    """친구 요청 거절 (DB 연동)"""
    # DB에서 Friendship 레코드 조회
    friendship = db.query(Friendship).filter(
        Friendship.id == action.id,
        Friendship.requester_id == action.requester_id
    ).first()

    if not friendship:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Friend request not found"
        )

    # status 업데이트
    friendship.status = "rejected"
    db.commit()
    db.refresh(friendship)

    # 메모리 배열도 업데이트 (하위 호환성)
    for req in friend_requests:
        if req["id"] == action.id and req["requester_id"] == action.requester_id:
            req["status"] = "rejected"

    print(f"친구 요청 거절됨 (DB): {action.id} -> {action.requester_id}")
    return FriendRequestActionResponse(
        message="Friend request rejected",
        id=friendship.id,
        requester_id=friendship.requester_id,
        status=friendship.status
    )
```

## 결과
- 상태: 완료



---

## 기본 정보
- 날짜: 2026-01-27 (월) 3:58~5:00
- 작성자: hexsera

## 진행 목표
Friendship 모델의 addressee_id 컬럼 이름을 receiver_id로 변경하여 친구 신청을 받는 사람을 더 직관적으로 표현한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|------|
| PRD 작성 | 1분 | PRD/친구 테이블 컬럼 스키마 변경PRD.md |
| PLAN 작성 | 2분 | PRD/친구-테이블-컬럼-스키마-변경-실행계획.md |
| 실행 | 5분 | fastapi/models.py, fastapi/main.py, fastapi/alembic/versions/9d0e5443047e_*.py |

### 1. fastapi/models.py 수정

**변경 전:**
```python
addressee_id = Column(Integer, nullable=False, index=True)
```

**변경 후:**
```python
receiver_id = Column(Integer, nullable=False, index=True)
```

### 2. fastapi/main.py 수정

**Pydantic 스키마 변경 (3곳):**
- FriendRequestRequest: `addressee_id` → `receiver_id`
- FriendRequestResponse: `addressee_id` → `receiver_id`
- POST /api/friend-requests 엔드포인트 로직 (3곳)

### 3. Alembic 마이그레이션

**생성된 마이그레이션 파일:**
- `9d0e5443047e_rename_addressee_id_to_receiver_id_in_.py`
- 컬럼 이름 변경: `op.alter_column()` 사용
- MySQL에서는 `existing_type` 파라미터 필수
- 기존 데이터 4건 모두 유지

**마이그레이션 적용:**
```bash
docker exec fastapi-server alembic stamp b293026a2667  # 현재 DB 상태 stamp
docker exec fastapi-server alembic revision --autogenerate -m "..."
docker exec fastapi-server alembic upgrade head
```

## 추가 작업
id 칼럼은 PK를 위한 자동 int 칼럼인데 ai가 이걸 유저 id라고 생각하는거같다...
그래서 각종 DB 연결을 수정해주었다... 좀더 PLAN 을 자세히 읽어야할거 같은데.. 쉽지않네.

## 결과
- 상태: 완료


---

## 기본 정보
- 날짜: 2026-01-27 (월) 17:10~18:00
- 작성자: hexsera

## 진행 목표
Pinball.jsx 우상단에 점수를 표시하는 UI를 추가하여 사용자에게 게임 점수를 시각적으로 제공한다.

## 진행 내용

| 작업 | 실행시간 | 수정파일 |
|------|----------|----------|
|핀볼 점수텍스트 추가| | Pinball.jsx |
### 1. react/main/src/Pinball.jsx 수정

**Typography import 추가 (3번 줄):**
```javascript
import { Button, Box, Typography } from '@mui/material';
```

**score useState 추가 (9번 줄):**
```javascript
const [score, setScore] = useState(0);
```

**게임 캔버스 Box에 position: relative 추가 (344번 줄):**
```javascript
<Box sx={{
  position: 'relative',  // ← 점수 UI 절대 위치 기준점
  width: '700px',
  height: '1200px',
  // ...
}}>
```

**점수 표시 UI 추가 (354-372번 줄):**
```javascript
<Box sx={{
  position: 'absolute',
  top: '20px',
  right: '20px',
  backgroundColor: 'rgba(0, 0, 0, 0.6)',
  padding: '10px 20px',
  borderRadius: '8px',
  border: '2px solid #FFD700'
}}>
  <Typography sx={{
    fontSize: '24px',
    fontWeight: 'bold',
    color: '#FFD700',
    textShadow: '2px 2px 4px rgba(0, 0, 0, 0.8)',
    fontFamily: 'monospace'
  }}>
    SCORE: {score}
  </Typography>
</Box>
```

## 결과
- 상태: 완료

## 다음 작업
- 점수 증가 로직 구현 (범퍼/장애물 충돌 시)
- 게임 종료 시 점수 저장 API 연동 (POST /api/v1/scores)

## 다음 작업
- GET /api/friend-requests 엔드포인트 DB 연동
- 메모리 리스트 제거 (모든 엔드포인트 DB 연동 완료 후)

## 다음 작업
- GET /api/friend-requests 엔드포인트 DB 연동
- 메모리 배열(`friend_requests`) 제거 (모든 엔드포인트 DB 연동 완료 후)

## 다음 작업
- GET /api/friend-requests 엔드포인트 DB 연동
- 메모리 리스트 제거 (모든 엔드포인트 DB 연동 완료 후)

## 다음 작업
- 친구 요청 CRUD API 구현 (POST, GET, PUT, DELETE)
- 친구 목록 조회 API 구현

## 다음 작업
- visits 테이블 생성 확인 (MySQL CLI)
- 방문 기록 저장 API 엔드포인트 구현 (POST /api/v1/visits)
- 기간별 방문 통계 조회 API 구현 (GET /api/v1/visits/stats)