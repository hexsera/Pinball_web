# 업무일지

## 기본 정보
- 날짜: 2026-02-08 (토)
- 작성자: hexsera

## 진행 목표
FastAPI 프로젝트에 TDD(Test-Driven Development) 구조를 구축하여, 향후 신규 API 개발 시 테스트 주도 개발 방식을 적용할 수 있는 기반을 마련한다.

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| 실행계획 작성 | PRD/TDD-구조-생성-실행계획.md | pytest 기반 TDD 구조 설계 |
| 테스트 패키지 추가 | backend/requirements.txt | pytest, httpx 추가 |
| pytest 설정 | backend/pytest.ini | 테스트 경로 및 파일 패턴 설정 |
| 테스트 디렉토리 생성 | backend/tests/ | __init__.py, conftest.py, test_example.py, README.md |
| conftest.py 작성 | backend/tests/conftest.py | PostgreSQL 테스트 DB 설정, fixture 정의 |
| main.py 수정 | backend/main.py | startup() 함수 분리, TESTING 환경변수 처리 |
| PostgreSQL 테스트 DB 생성 | hexdb_test | 테스트 전용 데이터베이스 생성 및 권한 설정 |
| 테스트 예시 작성 | backend/tests/test_example.py | TDD 개발 순서 예시 코드 |
| TDD 가이드 작성 | backend/tests/README.md | 테스트 실행 방법 및 개발 가이드 |
| pytest 실행 검증 | - | test_health_check 통과 확인 |
| FastAPI 서버 재시작 | - | 변경사항 적용 및 정상 작동 확인 |

**총 1시간 30분**

## 주요 변경 사항

### 1. backend/requirements.txt (수정)

**추가:**
```
pytest==8.0.0
httpx==0.27.0
```

**특징:**
- pytest: Python 테스트 프레임워크 (업계 표준)
- httpx: FastAPI TestClient가 사용하는 HTTP 클라이언트

### 2. backend/pytest.ini (생성)

**추가:**
```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

**특징:**
- pytest가 tests/ 폴더에서 test_*.py 파일을 자동 탐색
- 테스트 함수는 test_*로 시작하는 함수만 인식

### 3. backend/tests/conftest.py (생성)

**추가:**
```python
# conftest.py 최상단에 추가 (다른 import보다 먼저)
import os
os.environ["TESTING"] = "1"

import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

from database import Base, get_db
from main import app

# 테스트용 PostgreSQL 데이터베이스
TEST_DATABASE_URL = "postgresql+psycopg2://hexsera:hexpoint@postgres-server:5432/hexdb_test"

test_engine = create_engine(TEST_DATABASE_URL)
TestSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=test_engine)


@pytest.fixture(scope="session", autouse=True)
def setup_test_database():
    """테스트 시작 전 테이블 생성, 종료 후 삭제"""
    Base.metadata.create_all(bind=test_engine)
    yield
    Base.metadata.drop_all(bind=test_engine)


@pytest.fixture(scope="function")
def db_session():
    """각 테스트마다 트랜잭션 생성 및 롤백"""
    connection = test_engine.connect()
    transaction = connection.begin()
    session = TestSessionLocal(bind=connection)

    yield session

    session.close()
    transaction.rollback()
    connection.close()


@pytest.fixture(scope="function")
def client(db_session):
    """테스트용 FastAPI 클라이언트 (테스트 DB 사용)"""
    def override_get_db():
        try:
            yield db_session
        finally:
            pass

    app.dependency_overrides[get_db] = override_get_db
    with TestClient(app) as c:
        yield c
    app.dependency_overrides.clear()
```

**특징:**
- TESTING=1 환경변수 설정으로 main.py의 startup() 함수 실행 방지
- PostgreSQL 테스트 DB(hexdb_test) 사용
- setup_test_database: 테스트 세션 시작 시 테이블 생성, 종료 시 삭제
- db_session: 각 테스트마다 트랜잭션 시작 → 테스트 실행 → 롤백 (테스트 격리)
- client: FastAPI TestClient로 HTTP 요청 테스트 가능

### 4. backend/main.py (수정)

**변경 전:**
```python
from fastapi import FastAPI, Depends, HTTPException, status, Request
from pydantic import BaseModel
from datetime import date, datetime
from typing import List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import or_, and_
from database import wait_for_db, engine, Base, get_db, SessionLocal
from models import User, Score, Friendship, MonthlyScore, GameVisit
from auth import verify_api_key
from seed import seed_admin


# 애플리케이션 시작 시 DB 연결 확인
if not wait_for_db():
    raise Exception("Database connection failed after retries")

# 모든 테이블 생성 (존재하지 않는 경우에만)
print("Creating database tables...")
Base.metadata.create_all(bind=engine)
print("Database tables created successfully")



# Data Seeding
print("Starting data seeding...")
db = SessionLocal()
try:
    seed_admin(db)
finally:
    db.close()
print("Data seeding completed")

app = FastAPI(title="Hexsera API", version="1.0.0")
```

**변경 후:**
```python
from fastapi import FastAPI, Depends, HTTPException, status, Request
from pydantic import BaseModel
from datetime import date, datetime
from typing import List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import or_, and_
from database import wait_for_db, engine, Base, get_db, SessionLocal
from models import User, Score, Friendship, MonthlyScore, GameVisit
from auth import verify_api_key
from seed import seed_admin


def startup():
    """애플리케이션 시작 시 DB 초기화 및 시딩"""
    # 애플리케이션 시작 시 DB 연결 확인
    if not wait_for_db():
        raise Exception("Database connection failed after retries")

    # 모든 테이블 생성 (존재하지 않는 경우에만)
    print("Creating database tables...")
    Base.metadata.create_all(bind=engine)
    print("Database tables created successfully")

    # Data Seeding
    print("Starting data seeding...")
    db = SessionLocal()
    try:
        seed_admin(db)
    finally:
        db.close()
    print("Data seeding completed")


import os
if os.getenv("TESTING") != "1":
    startup()

app = FastAPI(title="Hexsera API", version="1.0.0")
```

**특징:**
- DB 초기화 코드를 startup() 함수로 분리
- TESTING=1 환경변수가 설정되면 startup() 실행 건너뜀
- 테스트 환경에서 main.py import 시 PostgreSQL 연결 오류 방지
- 프로덕션 환경에서는 기존과 동일하게 작동

### 5. backend/tests/test_example.py (생성)

**추가:**
```python
"""
TDD 방식으로 신규 API 개발 시 참고할 수 있는 예시 테스트 파일

TDD 개발 순서:
1. 테스트 작성 (실패하는 테스트)
2. 최소한의 코드로 테스트 통과
3. 리팩토링

예시: 새로운 /api/items 엔드포인트를 TDD로 개발한다면
"""

def test_health_check(client):
    """GET /api/ 헬스 체크 테스트 (테스트 환경 검증용)"""
    response = client.get("/api/")
    assert response.status_code == 200


# 신규 API 개발 시 아래와 같은 방식으로 테스트 작성
# 1단계: 실패하는 테스트 작성
# def test_create_item(client):
#     """POST /api/items 아이템 생성 테스트"""
#     response = client.post("/api/items", json={
#         "name": "Test Item",
#         "price": 1000
#     })
#     assert response.status_code == 201
#     assert response.json()["name"] == "Test Item"
#
# 2단계: main.py에 최소한의 코드로 엔드포인트 구현
# 3단계: 테스트 통과 확인
# 4단계: 코드 리팩토링 (필요시)
```

**특징:**
- test_health_check: 테스트 환경 검증용 기본 테스트
- 주석 처리된 예시 코드로 TDD 개발 순서 설명
- client fixture를 사용하여 HTTP 요청 테스트

### 6. backend/tests/README.md (생성)

**추가:**
```markdown
# Tests 디렉토리

이 디렉토리는 TDD(Test-Driven Development) 방식으로 신규 API를 개발하기 위한 테스트 파일을 담는다.

## TDD 개발 순서

1. **테스트 작성**: 구현하려는 API의 동작을 테스트 코드로 먼저 작성한다 (실패하는 테스트)
2. **최소 구현**: 테스트를 통과할 수 있는 최소한의 코드만 작성한다
3. **리팩토링**: 테스트가 통과하면 코드를 개선한다
4. **반복**: 새로운 기능이 필요하면 1번부터 반복한다

## 테스트 실행 방법

```bash
cd backend
pytest                    # 모든 테스트 실행
pytest tests/test_example.py  # 특정 파일만 실행
pytest -v                 # 상세 출력
pytest -k "health"        # 특정 테스트만 실행 (이름 필터)
```

## 신규 API 개발 예시

예를 들어 `/api/items` 엔드포인트를 TDD로 개발한다면:

1. `tests/test_items.py` 파일 생성
2. 실패하는 테스트 작성:
   ```python
   def test_create_item(client):
       response = client.post("/api/items", json={"name": "Item1", "price": 100})
       assert response.status_code == 201
   ```
3. `pytest` 실행 → 실패 확인
4. `main.py`에 최소 코드 작성하여 테스트 통과
5. 리팩토링 → 재테스트

## 테스트 작성 팁

- fixture 활용: `client`, `db_session`은 conftest.py에 정의되어 있음
- 테스트 격리: 각 테스트는 독립적으로 실행되며, 트랜잭션 롤백으로 DB가 자동 초기화됨
- 테스트 DB: hexdb_test 사용 (프로덕션 hexdb와 분리)

## 테스트 DB 관리

테스트는 별도의 PostgreSQL 데이터베이스(hexdb_test)를 사용합니다.

- 각 테스트는 트랜잭션 내에서 실행되고, 완료 후 자동으로 롤백됩니다
- 테스트 간 데이터 격리가 보장됩니다
- 프로덕션 DB(hexdb)에는 영향을 주지 않습니다
```

**특징:**
- TDD 개발 순서 상세 설명
- 테스트 실행 방법 가이드
- 신규 API 개발 예시 제공
- 테스트 DB 관리 방법 설명

### 7. PostgreSQL 테스트 DB 생성

**실행 명령:**
```bash
docker exec postgres-server psql -U hexsera -d postgres -c "CREATE DATABASE hexdb_test;"
docker exec postgres-server psql -U hexsera -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE hexdb_test TO hexsera;"
```

**결과:**
```
 hexdb      | hexsera | UTF8     | libc            | en_US.utf8 | en_US.utf8 |
 hexdb_test | hexsera | UTF8     | libc            | en_US.utf8 | en_US.utf8 |
```

**특징:**
- 프로덕션 DB(hexdb)와 분리된 테스트 전용 DB
- 테스트 실행 시 이 DB를 사용하여 프로덕션 데이터에 영향 없음

## 아키텍처 구조

### TDD 테스트 구조
```
┌───────────────────────────────────────────┐
│         pytest 실행                       │
│  $ docker exec fastapi-server pytest     │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│    conftest.py (최초 로드)                │
│  - TESTING=1 환경변수 설정                │
│  - main.py import → startup() 건너뜀     │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│    setup_test_database (session)          │
│  - hexdb_test 연결                        │
│  - Base.metadata.create_all()            │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│    각 테스트 함수 실행                    │
│  ┌─────────────────────────────────────┐ │
│  │ db_session fixture (function)       │ │
│  │ - transaction.begin()               │ │
│  │ - 테스트 실행                        │ │
│  │ - transaction.rollback()            │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │ client fixture (function)           │ │
│  │ - TestClient(app)                   │ │
│  │ - dependency_overrides[get_db]      │ │
│  └─────────────────────────────────────┘ │
└───────────────────────────────────────────┘
```

### 테스트 vs 프로덕션 환경 분기
```
main.py import
      │
      ▼
┌─────────────────────┐
│ TESTING 환경변수?   │
└──────┬──────────────┘
       │
       ├─ Yes (TESTING=1) ─────► startup() 건너뜀 ───► 테스트 환경
       │                          (테스트 DB 사용)
       │
       └─ No (미설정) ───────────► startup() 실행 ───► 프로덕션 환경
                                   (프로덕션 DB 사용)
```

## 결과
- 상태: 완료
- pytest 테스트 통과: 1 passed (test_health_check)
- FastAPI 서버 정상 작동 확인
- TDD 개발 기반 구축 완료

## 배운내용


## 다음 작업
- 기존 API 엔드포인트에 대한 테스트 코드 작성 (선택사항)
- 신규 API 개발 시 TDD 방식 적용
- 테스트 커버리지 확인 도구 도입 (pytest-cov)
