# 업무일지

## 기본 정보
- 날짜: 2026-02-21 (토)
- 작성자: hexsera

## 진행 목표
AI 채팅 기능 개선 — AI 대전 모드 연동, AI 선제 메시지, 게이머 말투 설정, 스페이스바 충돌 해결

## 진행 내용

| 작업 | 수정 파일 | 비고 |
|------|----------|------|
| AI 대전 모드일 때만 채팅창 표시 | `PinballPage.jsx` | 조건부 렌더링 |
| AI 선제 메시지 로직 추가 | `ChatPanel.jsx` | 마운트 후 5초, 50% 확률 |
| 유저 선제 메시지 시 타이머 취소 | `ChatPanel.jsx` | 유저가 먼저 말 걸면 AI 선제 취소 |
| 채팅 입력창 focus 처리 | `ChatInput.jsx` | 클릭 시 input focus 이동 |
| 스페이스바 게임 조작 충돌 방지 | `Pinball.jsx`, `AIPinball.jsx` | INPUT focus 시 keydown 무시 |
| 시스템 프롬프트 개선 | `chat.py` | 반말+게이머 말투+욕설 순화+한 문장 제한 |
| AI_INIT 선제 메시지 트리거 처리 | `chat.py` | `__AI_INIT__` 수신 시 인사말 생성 |
| Gemini API 키 교체 | `backend/.env` | 새 API 키로 변경 |

**총 2시간**

## 주요 변경 사항

### 1. PinballPage.jsx 수정

**변경 전:**
```jsx
<ChatPanel />
```

**변경 후:**
```jsx
{isAIMode && <ChatPanel isAIMode={isAIMode} />}
```

**특징:**
- AI 대전 버튼 OFF 상태에서 채팅창이 DOM에서 완전히 제거됨
- `isAIMode` prop을 ChatPanel에 전달하여 내부 로직 제어

---

### 2. ChatPanel.jsx 수정

**변경 전:**
```jsx
export default function ChatPanel() {
  const [chatId, setChatId] = useState(null);
  const bottomRef = useRef(null);
  // AI 선제 메시지 로직 없음
```

**변경 후:**
```jsx
export default function ChatPanel({ isAIMode }) {
  const [chatId, setChatId] = useState(null);
  const bottomRef = useRef(null);
  const initTimerRef = useRef(null);

  // AI 선제 메시지: 마운트 후 5초 뒤 50% 확률로 AI가 먼저 대화 시작
  useEffect(() => {
    if (!isAIMode) return;
    initTimerRef.current = setTimeout(async () => {
      if (Math.random() < 0.5) {
        try {
          const { data } = await axios.post('/api/v1/chat', {
            chat_id: null,
            message: '__AI_INIT__',
          });
          setChatId(data.chat_id);
          setMessages([{ role: 'ai', content: data.reply }]);
        } catch {
          // 선제 메시지 실패 시 조용히 무시
        }
      }
    }, 5000);
    return () => clearTimeout(initTimerRef.current);
  }, [isAIMode]);

  const handleSend = async () => {
    if (!inputValue.trim() || isLoading) return;

    // 유저가 먼저 말을 걸면 AI 선제 메시지 타이머 취소
    if (initTimerRef.current) {
      clearTimeout(initTimerRef.current);
      initTimerRef.current = null;
    }
    // ...
  };
```

**특징:**
- `initTimerRef`로 타이머 ID를 보관하여 유저 선제 메시지 시 취소 가능
- 컴포넌트 언마운트 시 타이머 자동 정리 (메모리 누수 방지)

---

### 3. ChatInput.jsx 수정

**변경 전:**
```jsx
export default function ChatInput({ value, onChange, onSend, disabled }) {
  const handleKeyDown = (e) => { ... };

  return (
    <TextField
      value={value}
      onChange={onChange}
      onKeyDown={handleKeyDown}
      ...
    />
  );
}
```

**변경 후:**
```jsx
import { useRef } from 'react';

export default function ChatInput({ value, onChange, onSend, disabled }) {
  const inputRef = useRef(null);
  const handleKeyDown = (e) => { ... };

  return (
    <TextField
      inputRef={inputRef}
      onClick={() => inputRef.current?.focus()}
      value={value}
      onChange={onChange}
      onKeyDown={handleKeyDown}
      ...
    />
  );
}
```

**특징:**
- 채팅창 클릭 시 브라우저 focus가 input으로 이동
- focus 이동 덕분에 이후 스페이스바 입력이 게임이 아닌 채팅으로 전달됨

---

### 4. Pinball.jsx / AIPinball.jsx 수정

**변경 전:**
```jsx
const handleKeyDown = (event) => {
  if (!gameStartedRef.current) {
    if (event.key === ' ' || event.code === 'Space') { ... }
    return;
  }
  // ...
};
```

**변경 후:**
```jsx
const handleKeyDown = (event) => {
  // 채팅 입력창에 focus가 있으면 게임 조작 무시
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

  if (!gameStartedRef.current) {
    if (event.key === ' ' || event.code === 'Space') { ... }
    return;
  }
  // ...
};
```

**특징:**
- `event.target.tagName` 검사로 채팅 input focus 여부 판별
- 기존 게임 로직 무변경, guard 조건만 상단에 추가

---

### 5. backend/app/api/v1/chat.py 수정

**변경 전:**
```python
SYSTEM_PROMPT = (
    "너는 핀볼 게임에서 사용자와 대결 중인 AI 상대방이다. "
    "경쟁자 입장에서 짧고 도발적이거나 친근하게 대화한다. "
    "핀볼 점수, 게임 전략, 승부에 관한 이야기를 한다. "
    "한국어로 대화하며, 게임 외 주제는 핀볼 대결로 돌려서 답한다."
)

# ...
response = chat_session.send_message(request.message)
```

**변경 후:**
```python
SYSTEM_PROMPT = (
    "너는 핀볼 게임에서 사용자와 대결 중인 AI 상대방이다. "
    "반말을 사용하고 흔한 게이머 말투(ㅋㅋ, ㄷㄷ, 실화냐, ㄹㅇ, 개잘함 등)를 구사해. "
    "욕설과 과한 표현은 반드시 순화해서 표현해 (예: '미친' → '헐', '개' → '엄청', '씨발' → '아씨'). "
    "핀볼 점수, 게임 전략, 승부 이야기 위주로 대화해. "
    "한국어로만 대화하고, 게임 외 주제는 핀볼 대결로 돌려서 답해. "
    "반드시 한 문장 이내로만 답해. 절대 두 문장 이상 보내지 마."
)

AI_INIT_TRIGGER = "__AI_INIT__"

# AI 선제 메시지 트리거 처리
if request.message == AI_INIT_TRIGGER:
    prompt = "대결 시작 전 상대방에게 짧은 인사를 반말 게이머 말투로 건네."
else:
    prompt = request.message

response = chat_session.send_message(prompt)
```

**특징:**
- 반말 + 게이머 말투 고정, 욕설 순화 지시 추가
- 한 문장 이내 응답 강제
- `__AI_INIT__` 트리거 수신 시 선제 인사말 생성 프롬프트로 대체

## 데이터 흐름

```
AI 대전 버튼 ON
      │
      ▼
ChatPanel 마운트
      │
      ├── 5초 타이머 시작 (initTimerRef)
      │         │
      │    유저가 먼저 채팅 입력
      │         │
      │    clearTimeout → 타이머 취소
      │
      └── 5초 후 Math.random() < 0.5 ?
               │ YES
               ▼
        POST /api/v1/chat { message: '__AI_INIT__' }
               │
               ▼
        Gemini API → 선제 인사말 생성
               │
               ▼
        채팅창에 AI 메시지 표시
```

## 결과
- 상태: 완료

## 배운내용


## 다음 작업
- 백엔드 컨테이너 재시작 후 동작 확인 (`docker compose up -d fastapi`)
- AI 선제 메시지 50% 확률 및 말투 실제 확인 테스트
