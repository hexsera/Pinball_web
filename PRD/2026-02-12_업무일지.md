# 업무일지

## 기본 정보
- 날짜: 2026-02-12 (목) 9:30~10:30
- 작성자: hexsera

## 진행 목표
backend 폴더를 정리하여 api 를 빠르게 찾기 위함.

## 진행 내용
main.py 의 엔드포인터들을 파일로 분할시켜 main.py 내용 단축.
불필요한 mock 데이터 삭제.



## 결과
완료

## 배운 내용


## 다음 작업
- 추가 정리할 부분 확인
- 백엔드 README 재작성
- Calude 파일 재작성

---

# 업무일지 2

## 기본 정보
- 날짜: 2026-02-12 (목) 10:30~11:30
- 작성자: hexsera

## 진행 목표
pytest 에서 테스트용 db (hexdb_test) 를 사용하지 못하는 문제 해결

## 진행 내용
test_testdb.py, main 에 db name 출력 엔드포인트 생성, test_high_scores.py 에 db name 엔드포인트 출력 코드생성
원인 파악을 위한 코드들을 작성하였음. 


## 결과
미해결
- 원인이 pytest client 가 서비스용 hexdb 에 연결 되어 있음. pytest 의 세션 가로채기가 작동하지 않음을 알 수 있었음
- 하지만 fixture db_session 는 hexdb_test 로 연결이 되었음. 어떤 차이가 있는지 알아봐야함.

## 배운 내용


## 다음 작업
- pytest 세부 확인


---

# 업무일지 3

## 기본 정보
- 날짜: 2026-02-12 (목) 13:50~14:20
- 작성자: hexsera

## 진행 목표
user get 에 nickname 쿼리 추가로 닉네임으로 사용자 검색 기능 추가.

## 진행 내용
api users.py 에 get 부분 nickname 쿼리 추가.

## 결과
- 완료

## 배운 내용
- contains

## 다음 작업



---

# 업무일지 4

## 기본 정보
- 날짜: 2026-02-12 (목) 14:40~15:50
- 작성자: hexsera

## 진행 목표
user put 에 MonthlyScore 에 nickname 연동 추가.

## 진행 내용
api users.py 에 put 에 MonthlyScore 에서 같은 id 찾은 후 nickname 연동

## 결과
- 완료

## 배운 내용


## 다음 작업
- 월간 테이블 월간 필터링, 삭제

---

# 업무일지 5

## 기본 정보
- 날짜: 2026-02-12 (목) 16:00~17:10
- 작성자: hexsera

## 진행 목표
pytest 테스트 DB 연결 문제 해결

## 진행 내용
conftest.py 수정

## 결과
- 미해결
- 테스트 DB 는 연결되었으나 테스트 환경과 실제 환경이 달라 생기는 문제 있음.

## 배운 내용


## 다음 작업

# 업무일지 6

## 기본 정보
- 날짜: 2026-02-12 (목) 17:10~17:20
- 작성자: hexsera

## 진행 목표
월간 테이블 GET 을 이번달 범위만 반환하게 변경

## 진행 내용
monthly_scores.py 에 GET 엔드포인트 수정

## 결과
- 완료

## 배운 내용


## 다음 작업

---

# 업무일지 7

## 기본 정보
- 날짜: 2026-02-12 (목) 18:00~18:45
- 작성자: hexsera

## 진행 목표
친구 테이블 GET 이 nickname 을 반환하도록

## 진행 내용
friend.py 의 GET 및 friendsship.py riendRequestData 스키마 수정

## 결과
- 완료

## 배운 내용
join

## 다음 작업

---

# 업무일지 8

## 기본 정보
- 날짜: 2026-02-12 (목) 19:00~19:30 20:00~20:50
- 작성자: hexsera

## 진행 목표
user FK 삭제 및 Mixed Content 오류 해결

## 진행 내용
- user 삭제 시 FK 참조 테이블(Friendship, MonthlyScore, HighScore) 데이터 먼저 삭제하도록 users.py 수정
- 프로덕션 환경에서 Mixed Content 오류 발생 확인 및 원인 분석
- `main.py`에 `redirect_slashes=False` 설정 추가
- 모든 라우터 파일의 `"/"` 경로를 `""` 로 변경 (monthly_scores.py, friends.py, users.py, scores.py, game_visits.py)

## 결과
- 완료
- `/api/v1/monthly-scores` 및 `/api/friend-requests` 등 모든 엔드포인트가 307 없이 200 응답

## 배운 내용

### Mixed Content 오류 발생 원인

**배경**: `main.py`에서 `@app.get("/api/v1/monthly-scores")` 로 직접 정의하던 엔드포인트를 `app.include_router(router, prefix="/api/v1/monthly-scores")`와 라우터 내부 `@router.get("/")` 방식으로 분리했다.

**문제**: FastAPI에서 `prefix="/api/v1/monthly-scores"`와 라우터 경로 `"/"`를 조합하면 실제 등록 경로가 `/api/v1/monthly-scores/` (끝에 슬래시 포함)가 된다. 브라우저가 슬래시 없는 `/api/v1/monthly-scores`로 요청하면 FastAPI가 자동으로 `/api/v1/monthly-scores/`로 307 Temporary Redirect 응답을 보낸다. 이때 307 응답의 Location 헤더가 `http://hexsera.com/api/v1/monthly-scores/`로 반환되어, HTTPS 페이지에서 HTTP 요청이 차단되는 Mixed Content 오류가 발생한다.

**해결 방법**:
1. `FastAPI(redirect_slashes=False)` 설정으로 슬래시 자동 리다이렉트 비활성화
2. 라우터 경로를 `"/"` 대신 `""` (빈 문자열)로 변경하여 prefix 경로 그대로 매칭

**핵심**: `main.py`에서 직접 엔드포인트를 정의할 때와 `include_router`로 분리할 때 실제 등록되는 URL 경로가 달라진다. 라우터로 분리할 때는 루트 경로를 `"/"` 대신 `""`으로 정의해야 슬래시가 붙지 않는다.

## 다음 작업
